
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../core/sorting/">
      
      
        <link rel="next" href="../animal/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Results - Neurodent</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#results" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Neurodent" class="md-header__button md-logo" aria-label="Neurodent" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Neurodent
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Results
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Neurodent" class="md-nav__button md-logo" aria-label="Neurodent" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Neurodent
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core Classes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_3" >
        
          
          <label class="md-nav__link" for="__nav_3_1_3" id="__nav_3_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Analysis Helper Classes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_3">
            <span class="md-nav__icon md-icon"></span>
            Analysis Helper Classes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/windowed/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Windowed Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/sorting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spike Sorting
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Visualization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Visualization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Results
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Results
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#neurodent.visualization.results.AnimalOrganizer" class="md-nav__link">
    <span class="md-ellipsis">
      AnimalOrganizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AnimalOrganizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.AnimalOrganizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.AnimalOrganizer.apply_lof_threshold" class="md-nav__link">
    <span class="md-ellipsis">
      apply_lof_threshold
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.AnimalOrganizer.compute_bad_channels" class="md-nav__link">
    <span class="md-ellipsis">
      compute_bad_channels
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.AnimalOrganizer.compute_frequency_domain_spike_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      compute_frequency_domain_spike_analysis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.AnimalOrganizer.compute_spike_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      compute_spike_analysis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.AnimalOrganizer.compute_windowed_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      compute_windowed_analysis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.AnimalOrganizer.get_all_lof_scores" class="md-nav__link">
    <span class="md-ellipsis">
      get_all_lof_scores
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.AnimalOrganizer.get_timeline_summary" class="md-nav__link">
    <span class="md-ellipsis">
      get_timeline_summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#neurodent.visualization.results.SpikeAnalysisResult" class="md-nav__link">
    <span class="md-ellipsis">
      SpikeAnalysisResult
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpikeAnalysisResult">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.SpikeAnalysisResult.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.SpikeAnalysisResult.convert_sa_to_np" class="md-nav__link">
    <span class="md-ellipsis">
      convert_sa_to_np
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.SpikeAnalysisResult.convert_sas_to_mne" class="md-nav__link">
    <span class="md-ellipsis">
      convert_sas_to_mne
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.SpikeAnalysisResult.save_fif_and_json" class="md-nav__link">
    <span class="md-ellipsis">
      save_fif_and_json
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult" class="md-nav__link">
    <span class="md-ellipsis">
      WindowAnalysisResult
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WindowAnalysisResult">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.__update_instance_vars" class="md-nav__link">
    <span class="md-ellipsis">
      __update_instance_vars
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.add_unique_hash" class="md-nav__link">
    <span class="md-ellipsis">
      add_unique_hash
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.aggregate_time_windows" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_time_windows
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.apply_filters" class="md-nav__link">
    <span class="md-ellipsis">
      apply_filters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.evaluate_lof_threshold_binary" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_lof_threshold_binary
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.filter_all" class="md-nav__link">
    <span class="md-ellipsis">
      filter_all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.filter_high_beta" class="md-nav__link">
    <span class="md-ellipsis">
      filter_high_beta
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.filter_high_rms" class="md-nav__link">
    <span class="md-ellipsis">
      filter_high_rms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.filter_logrms_range" class="md-nav__link">
    <span class="md-ellipsis">
      filter_logrms_range
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.filter_low_rms" class="md-nav__link">
    <span class="md-ellipsis">
      filter_low_rms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.filter_morphological_smoothing" class="md-nav__link">
    <span class="md-ellipsis">
      filter_morphological_smoothing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.filter_reject_channels" class="md-nav__link">
    <span class="md-ellipsis">
      filter_reject_channels
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.filter_reject_channels_by_session" class="md-nav__link">
    <span class="md-ellipsis">
      filter_reject_channels_by_session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_bad_channels_by_lof_threshold" class="md-nav__link">
    <span class="md-ellipsis">
      get_bad_channels_by_lof_threshold
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_filter_high_beta" class="md-nav__link">
    <span class="md-ellipsis">
      get_filter_high_beta
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_filter_high_rms" class="md-nav__link">
    <span class="md-ellipsis">
      get_filter_high_rms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_filter_logrms_range" class="md-nav__link">
    <span class="md-ellipsis">
      get_filter_logrms_range
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_filter_low_rms" class="md-nav__link">
    <span class="md-ellipsis">
      get_filter_low_rms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_filter_morphological_smoothing" class="md-nav__link">
    <span class="md-ellipsis">
      get_filter_morphological_smoothing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_filter_reject_channels" class="md-nav__link">
    <span class="md-ellipsis">
      get_filter_reject_channels
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_filter_reject_channels_by_recording_session" class="md-nav__link">
    <span class="md-ellipsis">
      get_filter_reject_channels_by_recording_session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_groupavg_result" class="md-nav__link">
    <span class="md-ellipsis">
      get_groupavg_result
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_info" class="md-nav__link">
    <span class="md-ellipsis">
      get_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_lof_scores" class="md-nav__link">
    <span class="md-ellipsis">
      get_lof_scores
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.get_result" class="md-nav__link">
    <span class="md-ellipsis">
      get_result
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.load_pickle_and_json" class="md-nav__link">
    <span class="md-ellipsis">
      load_pickle_and_json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.read_mnes_spikes" class="md-nav__link">
    <span class="md-ellipsis">
      read_mnes_spikes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="read_mnes_spikes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.read_mnes_spikes--from-mne-spike-annotations" class="md-nav__link">
    <span class="md-ellipsis">
      From MNE spike annotations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.read_sars_spikes" class="md-nav__link">
    <span class="md-ellipsis">
      read_sars_spikes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="read_sars_spikes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.read_sars_spikes--after-computing-war-and-spike-detection" class="md-nav__link">
    <span class="md-ellipsis">
      After computing WAR and spike detection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.reorder_and_pad_channels" class="md-nav__link">
    <span class="md-ellipsis">
      reorder_and_pad_channels
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neurodent.visualization.results.WindowAnalysisResult.save_pickle_and_json" class="md-nav__link">
    <span class="md-ellipsis">
      save_pickle_and_json
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#neurodent.visualization.results.bin_spike_times" class="md-nav__link">
    <span class="md-ellipsis">
      bin_spike_times
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2_2" id="__nav_3_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Plotting
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_2">
            <span class="md-nav__icon md-icon"></span>
            Plotting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../animal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Animal Level
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../experiment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Experiment Level
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utilities
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="results">Results</h1>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="neurodent.visualization.results.AnimalOrganizer" class="doc doc-heading">
            <code>AnimalOrganizer</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="neurodent.visualization.results.AnimalFeatureParser">AnimalFeatureParser</span></code></p>









              <details class="quote">
                <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AnimalOrganizer</span><span class="p">(</span><span class="n">AnimalFeatureParser</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_folder_path</span><span class="p">,</span>
        <span class="n">anim_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">day_sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;nest&quot;</span><span class="p">,</span> <span class="s2">&quot;concat&quot;</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;noday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;concat&quot;</span><span class="p">,</span>
        <span class="n">assume_from_number</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_days</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">truncate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">lro_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        AnimalOrganizer is used to organize data from a single animal into a format that can be used for analysis.</span>
<span class="sd">        It is used to organize data from a single animal into a format that can be used for analysis.</span>

<span class="sd">        Args:</span>
<span class="sd">            base_folder_path (str): The path to the base folder of the animal data.</span>
<span class="sd">            anim_id (str): The ID of the animal. This should correspond to only one animal.</span>
<span class="sd">            day_sep (str, optional): Separator for day in folder name. Set to None or empty string to get all folders. Defaults to None.</span>
<span class="sd">            mode (Literal[&quot;nest&quot;, &quot;concat&quot;, &quot;base&quot;, &quot;noday&quot;], optional): The mode of the AnimalOrganizer. Defaults to &quot;concat&quot;.</span>
<span class="sd">                File structure patterns (where * indicates search location):</span>
<span class="sd">                &quot;nest&quot;: base_folder_path / animal_id / *date_format* (looks for folders/files within animal_id subdirectories)</span>
<span class="sd">                &quot;concat&quot;: base_folder_path / *animal_id*date_format* (looks for folders/files with animal_id+date in name at base level)</span>
<span class="sd">                &quot;base&quot;: base_folder_path / * (looks for folders/files directly in base_folder_path)</span>
<span class="sd">                &quot;noday&quot;: base_folder_path / *animal_id* (same as concat but expects single unique match, no date filtering)</span>
<span class="sd">            assume_from_number (bool, optional): Whether to assume the animal ID is a number. Defaults to False.</span>
<span class="sd">            skip_days (list[str], optional): The days to skip. Defaults to [].</span>
<span class="sd">            truncate (bool|int, optional): Whether to truncate the data. Defaults to False.</span>
<span class="sd">            lro_kwargs (dict, optional): Keyword arguments for LongRecordingOrganizer. Defaults to {}.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">base_folder_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anim_id</span> <span class="o">=</span> <span class="n">anim_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animal_param</span> <span class="o">=</span> <span class="p">[</span><span class="n">anim_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">day_sep</span> <span class="o">=</span> <span class="n">day_sep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span> <span class="o">=</span> <span class="n">assume_from_number</span>

        <span class="k">match</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;nest&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_folder_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anim_id</span><span class="si">}</span><span class="s2">*&quot;</span> <span class="o">/</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">case</span> <span class="s2">&quot;concat&quot;</span> <span class="o">|</span> <span class="s2">&quot;noday&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_folder_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anim_id</span><span class="si">}</span><span class="s2">*&quot;</span>
                <span class="c1"># self.bin_folder_pat = self.base_folder_path / f&quot;*{self.anim_id}*{self.date_format}*&quot;</span>
            <span class="k">case</span> <span class="s2">&quot;base&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_folder_path</span>
            <span class="c1"># case &#39;noday&#39;:</span>
            <span class="c1">#     self.bin_folder_pat = self.base_folder_path / f&quot;*{self.anim_id}*&quot;</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span><span class="p">))</span>

        <span class="c1"># Filter to only include directories (LongRecordingOrganizer expects folder paths)</span>
        <span class="n">before_filter_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
        <span class="n">after_filter_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">before_filter_count</span> <span class="o">&gt;</span> <span class="n">after_filter_count</span><span class="p">:</span>
            <span class="n">filtered_count</span> <span class="o">=</span> <span class="n">before_filter_count</span> <span class="o">-</span> <span class="n">after_filter_count</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered out </span><span class="si">{</span><span class="n">filtered_count</span><span class="si">}</span><span class="s2"> non-directory items (files) from glob results&quot;</span><span class="p">)</span>

        <span class="c1"># if mode != &#39;noday&#39;:</span>
        <span class="c1">#     self.__bin_folders = [x for x in self.__bin_folders if datetime.strptime(Path(x).name, self.date_format)]</span>
        <span class="n">truncate</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parse_truncate</span><span class="p">(</span><span class="n">truncate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">truncate</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AnimalOrganizer will be truncated to the first </span><span class="si">{</span><span class="n">truncate</span><span class="si">}</span><span class="s2"> LongRecordings&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">[:</span><span class="n">truncate</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">y</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">skip_days</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bin_folder_pattern: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self._bin_folders: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self.bin_folder_names: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;noday&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Animal ID &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anim_id</span><span class="si">}</span><span class="s2">&#39; is not unique, found: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No directories found for animal ID </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anim_id</span><span class="si">}</span><span class="s2"> (pattern: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_dicts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">core</span><span class="o">.</span><span class="n">parse_path_to_animalday</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">animal_param</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_param</span><span class="p">,</span> <span class="n">day_sep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">day_sep</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_mode</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span>
        <span class="p">]</span>

        <span class="c1"># Group folders by parsed animalday to handle overlapping days</span>
        <span class="n">animalday_to_folders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">animalday_dict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_dicts</span><span class="p">):</span>
            <span class="n">animalday</span> <span class="o">=</span> <span class="n">animalday_dict</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">animalday</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">animalday_to_folders</span><span class="p">:</span>
                <span class="n">animalday_to_folders</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">animalday_to_folders</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="c1"># Store grouping info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_folder_groups</span> <span class="o">=</span> <span class="n">animalday_to_folders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_animaldays</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">animalday_to_folders</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Log merging operations for overlapping days</span>
        <span class="n">overlapping_days</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">folders</span> <span class="ow">in</span> <span class="n">animalday_to_folders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">overlapping_days</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merging </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span><span class="si">}</span><span class="s2"> folders for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">folders</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">overlapping_days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">overlapping_days</span><span class="si">}</span><span class="s2"> animaldays with overlapping folders&quot;</span><span class="p">)</span>

        <span class="c1"># Update animaldays to reflect unique days (not total folders)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_animaldays</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self.animaldays (unique): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">genotypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;genotype&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_dicts</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">genotypes</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inconsistent genotypes in </span><span class="si">{</span><span class="n">genotypes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span> <span class="o">=</span> <span class="n">genotypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self.genotype: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">long_analyzers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">core</span><span class="o">.</span><span class="n">LongRecordingAnalyzer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_animaldays</span><span class="p">)</span><span class="si">}</span><span class="s2"> LongRecordings (one per unique animalday)&quot;</span><span class="p">)</span>

        <span class="c1"># Process manual_datetimes if provided in lro_kwargs</span>
        <span class="k">if</span> <span class="s2">&quot;manual_datetimes&quot;</span> <span class="ow">in</span> <span class="n">lro_kwargs</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing manual_datetimes configuration&quot;</span><span class="p">)</span>
            <span class="n">base_lro_kwargs</span> <span class="o">=</span> <span class="n">lro_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">base_lro_kwargs</span><span class="p">[</span><span class="s2">&quot;manual_datetimes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_processed_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_timestamps</span><span class="p">(</span>
                <span class="n">lro_kwargs</span><span class="p">[</span><span class="s2">&quot;manual_datetimes&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_folder_groups</span><span class="p">,</span> <span class="n">base_lro_kwargs</span>
            <span class="p">)</span>
            <span class="c1"># Remove from lro_kwargs since we&#39;ll handle it manually</span>
            <span class="n">lro_kwargs</span> <span class="o">=</span> <span class="n">base_lro_kwargs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_processed_timestamps</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create LongRecordingOrganizer instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_long_recordings</span><span class="p">(</span><span class="n">lro_kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_timestamp_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_spec</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively resolve any timestamp input type to concrete datetime(s).</span>

<span class="sd">        Args:</span>
<span class="sd">            input_spec: datetime, List[datetime], or Callable returning either</span>
<span class="sd">            folder_path: Path to folder for function execution context</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[datetime, List[datetime]]: Resolved timestamp(s)</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If input_spec is not a supported type</span>
<span class="sd">            Exception: If user function fails (wrapped with context)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_spec</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">input_spec</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_spec</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Validate that all items are datetime objects</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">input_spec</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;All items in timestamp list must be datetime objects, got: </span><span class="si">{</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">input_spec</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">input_spec</span>

        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">input_spec</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing user timestamp function on folder: </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">input_spec</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
                <span class="c1"># Recursively process the result (functions can return datetime or list)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_timestamp_input</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User timestamp function failed on folder &#39;</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User timestamp function failed on folder &#39;</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid timestamp input type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">input_spec</span><span class="p">)</span><span class="si">}</span><span class="s2">. Expected: datetime, List[datetime], or Callable&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_folder_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">animalday_to_folders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find folder path by name in the animalday groups.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">folders</span> <span class="ow">in</span> <span class="n">animalday_to_folders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">folder_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="n">available_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">folders</span> <span class="ow">in</span> <span class="n">animalday_to_folders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">available_names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">])</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder name &#39;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">&#39; not found. Available folders: </span><span class="si">{</span><span class="n">available_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_global_timeline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">base_datetime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">animalday_to_folders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">base_lro_kwargs</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute contiguous timeline for all folders starting from base_datetime.</span>

<span class="sd">        This uses a two-pass approach:</span>
<span class="sd">        1. Create temporary LROs to determine durations</span>
<span class="sd">        2. Compute continuous start times based on cumulative durations</span>
<span class="sd">        3. Return timeline mapping for final LRO creation</span>

<span class="sd">        Args:</span>
<span class="sd">            base_datetime: Starting datetime for the timeline</span>
<span class="sd">            animalday_to_folders: Mapping of animalday -&gt; list of folder paths</span>
<span class="sd">            base_lro_kwargs: Base kwargs for LRO construction (without manual_datetimes)</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Mapping of folder_name -&gt; start_datetime for continuous timeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_folders</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="k">for</span> <span class="n">folders</span> <span class="ow">in</span> <span class="n">animalday_to_folders</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">total_animaldays</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">animalday_to_folders</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Computing continuous timeline for </span><span class="si">{</span><span class="n">total_animaldays</span><span class="si">}</span><span class="s2"> animaldays (</span><span class="si">{</span><span class="n">total_folders</span><span class="si">}</span><span class="s2"> total folders) &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;starting at </span><span class="si">{</span><span class="n">base_datetime</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Step 1: Create temporary LROs to determine durations</span>
        <span class="c1"># We need to create LROs in the order they will appear in the final timeline</span>
        <span class="n">ordered_folders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">animalday</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">animalday_to_folders</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">folders</span> <span class="o">=</span> <span class="n">animalday_to_folders</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># For overlapping folders, we need to sort them by temporal order</span>
                <span class="c1"># Create temp LROs to get timing info for sorting</span>
                <span class="n">folder_lro_pairs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">temp_lro</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">LongRecordingOrganizer</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="o">**</span><span class="n">base_lro_kwargs</span><span class="p">)</span>
                        <span class="n">folder_lro_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">folder</span><span class="p">,</span> <span class="n">temp_lro</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create temp LRO for duration estimation in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Use folder order as fallback</span>
                        <span class="n">folder_lro_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">folder</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

                <span class="c1"># Sort by median time if possible</span>
                <span class="n">sorted_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_lros_by_median_time</span><span class="p">(</span><span class="n">folder_lro_pairs</span><span class="p">)</span>
                <span class="n">ordered_folders</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">folder</span> <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sorted_pairs</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ordered_folders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span>

        <span class="c1"># Step 2: Estimate total duration for each folder</span>
        <span class="n">folder_durations</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">ordered_folders</span><span class="p">:</span>
            <span class="c1"># Create temporary LRO to get duration</span>
            <span class="n">temp_lro</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">LongRecordingOrganizer</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="o">**</span><span class="n">base_lro_kwargs</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">temp_lro</span><span class="o">.</span><span class="n">LongRecording</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">temp_lro</span><span class="p">,</span> <span class="s2">&quot;LongRecording&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">temp_lro</span><span class="o">.</span><span class="n">LongRecording</span>
                <span class="k">else</span> <span class="mf">0.0</span>
            <span class="p">)</span>
            <span class="n">folder_durations</span><span class="p">[</span><span class="n">folder</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: estimated duration = </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

        <span class="c1"># Step 3: Compute continuous start times</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">current_start_time</span> <span class="o">=</span> <span class="n">base_datetime</span>

        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">ordered_folders</span><span class="p">:</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="n">result</span><span class="p">[</span><span class="n">folder_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_start_time</span>

            <span class="c1"># Move to next start time (current start + duration)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">folder_durations</span><span class="p">[</span><span class="n">folder</span><span class="p">]</span>
            <span class="n">current_start_time</span> <span class="o">=</span> <span class="n">current_start_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeline: </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2"> starts at </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">folder_name</span><span class="p">]</span><span class="si">}</span><span class="s2">, duration </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

        <span class="n">total_timeline_duration</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">folder_durations</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Continuous timeline computed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2"> folders, total duration </span><span class="si">{</span><span class="n">total_timeline_duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_all_timestamps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manual_datetimes</span><span class="p">,</span> <span class="n">animalday_to_folders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">base_lro_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the top-level manual_datetimes input and return folder_name -&gt; resolved_timestamps mapping.</span>

<span class="sd">        Args:</span>
<span class="sd">            manual_datetimes: Any supported timestamp input type</span>
<span class="sd">            animalday_to_folders: Mapping of animalday -&gt; list of folder paths</span>
<span class="sd">            base_lro_kwargs: Base kwargs for LRO construction (without manual_datetimes)</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Mapping of folder_name -&gt; Union[datetime, List[datetime]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manual_datetimes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Per-folder specification</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing per-folder timestamp specification&quot;</span><span class="p">)</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">folder_spec</span> <span class="ow">in</span> <span class="n">manual_datetimes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">folder_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_folder_by_name</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">animalday_to_folders</span><span class="p">)</span>
                <span class="n">resolved</span><span class="p">[</span><span class="n">folder_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_timestamp_input</span><span class="p">(</span><span class="n">folder_spec</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved timestamps for </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">resolved</span><span class="p">[</span><span class="n">folder_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resolved</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manual_datetimes</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="c1"># Global timeline - compute contiguous spacing</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing global timeline starting at </span><span class="si">{</span><span class="n">manual_datetimes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_global_timeline</span><span class="p">(</span><span class="n">manual_datetimes</span><span class="p">,</span> <span class="n">animalday_to_folders</span><span class="p">,</span> <span class="n">base_lro_kwargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Function or list at top level - apply to all folders</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing timestamp input for all folders&quot;</span><span class="p">)</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">folders</span> <span class="ow">in</span> <span class="n">animalday_to_folders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
                    <span class="n">folder_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">resolved</span><span class="p">[</span><span class="n">folder_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_timestamp_input</span><span class="p">(</span><span class="n">manual_datetimes</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved timestamps for </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">resolved</span><span class="p">[</span><span class="n">folder_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resolved</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lro_kwargs_for_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_lro_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the appropriate lro_kwargs for a specific folder, including processed timestamps if available.</span>

<span class="sd">        Args:</span>
<span class="sd">            folder_path: Path to the folder</span>
<span class="sd">            base_lro_kwargs: Base kwargs to extend</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: lro_kwargs with manual_datetimes added if available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processed_timestamps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base_lro_kwargs</span>

        <span class="n">folder_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">folder_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processed_timestamps</span><span class="p">:</span>
            <span class="c1"># Add the processed timestamps for this folder</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">base_lro_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;manual_datetimes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processed_timestamps</span><span class="p">[</span><span class="n">folder_name</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using processed timestamps for folder </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;manual_datetimes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">kwargs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No processed timestamps for this folder - use base kwargs</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No processed timestamps for folder </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">, using base kwargs&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">base_lro_kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_timeline_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log timeline summary for debugging purposes.&quot;&quot;&quot;</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AnimalOrganizer Timeline Summary:&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No LongRecordings created&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lro</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lro_start_time</span><span class="p">(</span><span class="n">lro</span><span class="p">)</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lro_end_time</span><span class="p">(</span><span class="n">lro</span><span class="p">)</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lro</span><span class="o">.</span><span class="n">LongRecording</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;LongRecording&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">LongRecording</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="n">n_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lro</span><span class="o">.</span><span class="n">file_durations</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;file_durations&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_durations</span> <span class="k">else</span> <span class="mi">1</span>
                    <span class="n">folder_path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;base_folder_path&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>

                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;LRO </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;(duration: </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s, files: </span><span class="si">{</span><span class="n">n_files</span><span class="si">}</span><span class="s2">, folder: </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get timeline info for LRO </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lro_start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lro</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the start time of an LRO.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;file_end_datetimes&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_end_datetimes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;file_durations&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_durations</span><span class="p">:</span>
                <span class="c1"># Calculate start time from first end time and duration</span>
                <span class="n">first_end</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dt</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_end_datetimes</span> <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">first_duration</span> <span class="o">=</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_durations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">first_end</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">first_duration</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lro_end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lro</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the end time of an LRO.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;file_end_datetimes&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_end_datetimes</span><span class="p">:</span>
            <span class="c1"># Get the last non-None end time</span>
            <span class="n">end_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_end_datetimes</span> <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">end_times</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">end_times</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_timeline_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get timeline summary as a DataFrame for user inspection and debugging.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: Timeline information with columns:</span>
<span class="sd">                - lro_index: Index of the LRO</span>
<span class="sd">                - start_time: Start datetime of the LRO</span>
<span class="sd">                - end_time: End datetime of the LRO</span>
<span class="sd">                - duration_s: Duration in seconds</span>
<span class="sd">                - n_files: Number of files in the LRO</span>
<span class="sd">                - folder_path: Base folder path</span>
<span class="sd">                - animalday: Parsed animalday identifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">timeline_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lro</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lro_start_time</span><span class="p">(</span><span class="n">lro</span><span class="p">)</span>
                <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lro_end_time</span><span class="p">(</span><span class="n">lro</span><span class="p">)</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">lro</span><span class="o">.</span><span class="n">LongRecording</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;LongRecording&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">LongRecording</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="p">)</span>
                <span class="n">n_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lro</span><span class="o">.</span><span class="n">file_durations</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;file_durations&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_durations</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="n">folder_path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;base_folder_path&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>

                <span class="n">timeline_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;lro_index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                        <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">start_time</span><span class="p">,</span>
                        <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">end_time</span><span class="p">,</span>
                        <span class="s2">&quot;duration_s&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                        <span class="s2">&quot;n_files&quot;</span><span class="p">:</span> <span class="n">n_files</span><span class="p">,</span>
                        <span class="s2">&quot;folder_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder_path</span><span class="p">),</span>
                        <span class="s2">&quot;folder_name&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">folder_path</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;animalday&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span>
                            <span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;_animalday&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span>
                        <span class="p">),</span>  <span class="c1"># This might not exist, but useful if it does</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Include failed LROs in the summary for debugging</span>
                <span class="n">timeline_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;lro_index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                        <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;duration_s&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;n_files&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;folder_name&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;animalday&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">timeline_data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_long_recordings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lro_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create LongRecordingOrganizer instances for each unique animalday.&quot;&quot;&quot;</span>
        <span class="c1"># Create one LRO per unique animalday (not per folder)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">core</span><span class="o">.</span><span class="n">LongRecordingOrganizer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">folders</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_folder_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Single folder - use processed timestamps if available</span>
                <span class="n">folder_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lro_kwargs_for_folder</span><span class="p">(</span><span class="n">folders</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lro_kwargs</span><span class="p">)</span>
                <span class="n">lro</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">LongRecordingOrganizer</span><span class="p">(</span><span class="n">folders</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">folder_kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Multiple folders - create individual LROs then sort and merge</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating individual LROs for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span><span class="si">}</span><span class="s2"> folders for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Create individual LROs first, each with their own processed timestamps</span>
                <span class="n">folder_lro_pairs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
                    <span class="n">folder_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lro_kwargs_for_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">lro_kwargs</span><span class="p">)</span>
                    <span class="n">individual_lro</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">LongRecordingOrganizer</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="o">**</span><span class="n">folder_kwargs</span><span class="p">)</span>
                    <span class="n">folder_lro_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">folder</span><span class="p">,</span> <span class="n">individual_lro</span><span class="p">))</span>

                <span class="c1"># Sort by median time using constructed LROs</span>
                <span class="n">sorted_folder_lro_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_lros_by_median_time</span><span class="p">(</span><span class="n">folder_lro_pairs</span><span class="p">)</span>

                <span class="c1"># Debug logging to show the order of LROs being merged</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LRO merge order for overlapping animalday:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">lro</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_folder_lro_pairs</span><span class="p">):</span>
                    <span class="n">folder_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                    <span class="c1"># Handle mock objects gracefully</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">lro</span><span class="o">.</span><span class="n">LongRecording</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;LongRecording&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">LongRecording</span>
                            <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">duration_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="n">duration_str</span> <span class="o">=</span> <span class="s2">&quot;mock&quot;</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2"> (duration: </span><span class="si">{</span><span class="n">duration_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

                <span class="c1"># Merge all LROs into the first one (in temporal order)</span>
                <span class="n">merged_lro</span> <span class="o">=</span> <span class="n">sorted_folder_lro_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Get the LRO from first tuple</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base LRO: </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">sorted_folder_lro_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">lro</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_folder_lro_pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">folder_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merging LRO </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2"> into base LRO&quot;</span><span class="p">)</span>
                    <span class="n">merged_lro</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">lro</span><span class="p">)</span>

                <span class="n">lro</span> <span class="o">=</span> <span class="n">merged_lro</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully merged </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_folder_lro_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> LROs for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lro</span><span class="p">)</span>

        <span class="c1"># Log timeline summary for debugging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_timeline_summary</span><span class="p">()</span>

        <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">channel_names</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">channel_names</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inconsistent channel names in long_recordings: </span><span class="si">{</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="n">channel_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">animal_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_dicts</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">animal_ids</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inconsistent animal IDs in </span><span class="si">{</span><span class="n">animal_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span> <span class="o">=</span> <span class="n">animal_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_avg_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sort_lros_by_median_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_lro_pairs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sort LROs by median timestamp of their constituent recordings.</span>

<span class="sd">        Args:</span>
<span class="sd">            folder_lro_pairs (list): List of (folder_path, lro) tuples</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Sorted (folder_path, lro) tuples in temporal order based on median timestamp</span>

<span class="sd">        Note:</span>
<span class="sd">            Extracts file_end_datetimes from each LRO (timestamps from LastEdit fields in metadata CSV files),</span>
<span class="sd">            calculates the median timestamp of constituent recordings within each LRO, and sorts LROs</span>
<span class="sd">            by this median timestamp. This ensures proper temporal ordering based on actual recording</span>
<span class="sd">            content rather than folder naming conventions. Falls back to folder modification time if</span>
<span class="sd">            no valid timestamps are available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder_lro_pairs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">folder_lro_pairs</span>

        <span class="n">folder_lro_times</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">folder_path</span><span class="p">,</span> <span class="n">lro</span> <span class="ow">in</span> <span class="n">folder_lro_pairs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get median timestamp from constituent recordings within the LRO</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;file_end_datetimes&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_end_datetimes</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">valid_timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_end_datetimes</span> <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">valid_timestamps</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">if</span> <span class="n">valid_timestamps</span><span class="p">:</span>
                        <span class="c1"># Sort timestamps and get the median</span>
                        <span class="n">valid_timestamps</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                        <span class="n">n_timestamps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_timestamps</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">n_timestamps</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Odd number of timestamps - take middle one</span>
                            <span class="n">median_timestamp</span> <span class="o">=</span> <span class="n">valid_timestamps</span><span class="p">[</span><span class="n">n_timestamps</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Even number of timestamps - take average of two middle ones</span>
                            <span class="n">mid1</span> <span class="o">=</span> <span class="n">valid_timestamps</span><span class="p">[</span><span class="n">n_timestamps</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="n">mid2</span> <span class="o">=</span> <span class="n">valid_timestamps</span><span class="p">[</span><span class="n">n_timestamps</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
                            <span class="n">median_timestamp</span> <span class="o">=</span> <span class="n">mid1</span> <span class="o">+</span> <span class="p">(</span><span class="n">mid2</span> <span class="o">-</span> <span class="n">mid1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

                        <span class="c1"># Convert to seconds since epoch for sorting</span>
                        <span class="n">median_time_seconds</span> <span class="o">=</span> <span class="n">median_timestamp</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;LRO </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_timestamps</span><span class="si">}</span><span class="s2"> recordings, median timestamp: </span><span class="si">{</span><span class="n">median_timestamp</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No file_end_datetimes available in LRO </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, cannot determine temporal order&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No file_end_datetimes available in LRO </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, cannot determine temporal order&quot;</span><span class="p">)</span>

                <span class="n">folder_lro_times</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">lro</span><span class="p">,</span> <span class="n">median_time_seconds</span><span class="p">))</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract timing from </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="c1"># Sort by median time</span>
        <span class="n">sorted_folder_lro_times</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">folder_lro_times</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">sorted_folder_lro_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">folder</span><span class="p">,</span> <span class="n">lro</span><span class="p">)</span> <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">lro</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sorted_folder_lro_times</span><span class="p">]</span>

        <span class="c1"># Log the sorting for debugging</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder_lro_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LRO temporal sorting details:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">lro</span><span class="p">,</span> <span class="n">median_time_seconds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_folder_lro_times</span><span class="p">):</span>
                <span class="n">folder_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

                <span class="c1"># Convert back to datetime for readable logging</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

                    <span class="n">median_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">median_time_seconds</span><span class="p">)</span>
                    <span class="n">median_time_str</span> <span class="o">=</span> <span class="n">median_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                    <span class="n">median_time_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">median_time_seconds</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span>

                <span class="c1"># Handle mock objects gracefully for duration</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lro</span><span class="o">.</span><span class="n">LongRecording</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;LongRecording&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">LongRecording</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="n">duration_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="n">duration_str</span> <span class="o">=</span> <span class="s2">&quot;mock&quot;</span>

                <span class="c1"># Show number of recordings in LRO</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">n_recordings</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">lro</span><span class="o">.</span><span class="n">file_end_datetimes</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;file_end_datetimes&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_end_datetimes</span>
                        <span class="k">else</span> <span class="mi">0</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="n">n_recordings</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">: median_timestamp=</span><span class="si">{</span><span class="n">median_time_str</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">n_recordings</span><span class="si">}</span><span class="s2"> recordings, duration=</span><span class="si">{</span><span class="n">duration_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Summary line for quick reference</span>
            <span class="n">folder_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sorted_folder_lro_times</span><span class="p">]</span>
            <span class="n">median_times</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">median_time_seconds</span> <span class="ow">in</span> <span class="n">sorted_folder_lro_times</span><span class="p">:</span>
                <span class="n">median_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">median_time_seconds</span><span class="p">)</span>
                <span class="n">median_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">))</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final sort order: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">folder_names</span><span class="p">,</span><span class="w"> </span><span class="n">median_times</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sorted_folder_lro_pairs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_colbins_to_rowbins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multiprocess_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dask&quot;</span><span class="p">,</span> <span class="s2">&quot;serial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;serial&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Converting column bins to row bins&quot;</span><span class="p">):</span>
            <span class="n">lrec</span><span class="o">.</span><span class="n">convert_colbins_to_rowbins</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">multiprocess_mode</span><span class="o">=</span><span class="n">multiprocess_mode</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_rowbins_to_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiprocess_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dask&quot;</span><span class="p">,</span> <span class="s2">&quot;serial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;serial&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Converting row bins to recs&quot;</span><span class="p">):</span>
            <span class="n">lrec</span><span class="o">.</span><span class="n">convert_rowbins_to_rec</span><span class="p">(</span><span class="n">multiprocess_mode</span><span class="o">=</span><span class="n">multiprocess_mode</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">:</span>
            <span class="n">lrec</span><span class="o">.</span><span class="n">cleanup_rec</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_bad_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lof_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force_recompute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute bad channels using LOF analysis for all recordings.</span>

<span class="sd">        Args:</span>
<span class="sd">            lof_threshold (float, optional): Threshold for determining bad channels from LOF scores.</span>
<span class="sd">                                           If None, only computes/loads scores without setting bad_channel_names.</span>
<span class="sd">            force_recompute (bool): Whether to recompute LOF scores even if they exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Computing bad channels for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">)</span><span class="si">}</span><span class="s2"> recordings with threshold=</span><span class="si">{</span><span class="n">lof_threshold</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing bad channels for recording </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lrec</span><span class="o">.</span><span class="n">compute_bad_channels</span><span class="p">(</span><span class="n">lof_threshold</span><span class="o">=</span><span class="n">lof_threshold</span><span class="p">,</span> <span class="n">force_recompute</span><span class="o">=</span><span class="n">force_recompute</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Recording </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> LOF scores computed: </span><span class="si">{</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">lrec</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lof_scores&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">lrec</span><span class="o">.</span><span class="n">lof_scores</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Update bad channels dict if threshold was applied</span>
        <span class="k">if</span> <span class="n">lof_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">animalday</span><span class="p">:</span> <span class="n">lrec</span><span class="o">.</span><span class="n">bad_channel_names</span> <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">)</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_lof_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lof_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply threshold to existing LOF scores to determine bad channels for all recordings.</span>

<span class="sd">        Args:</span>
<span class="sd">            lof_threshold (float): Threshold for determining bad channels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">:</span>
            <span class="n">lrec</span><span class="o">.</span><span class="n">apply_lof_threshold</span><span class="p">(</span><span class="n">lof_threshold</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">animalday</span><span class="p">:</span> <span class="n">lrec</span><span class="o">.</span><span class="n">bad_channel_names</span> <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_lof_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get LOF scores for all recordings.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary mapping animal days to LOF score dictionaries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">animalday</span><span class="p">:</span> <span class="n">lrec</span><span class="o">.</span><span class="n">get_lof_scores</span><span class="p">()</span> <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_windowed_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">window_s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">multiprocess_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dask&quot;</span><span class="p">,</span> <span class="s2">&quot;serial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;serial&quot;</span><span class="p">,</span>
        <span class="n">suppress_short_interval_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">apply_notch_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes windowed analysis of animal recordings. The data is divided into windows (time bins), then features are extracted from each window. The result is</span>
<span class="sd">        formatted to a Dataframe and wrapped into a WindowAnalysisResult object.</span>

<span class="sd">        Args:</span>
<span class="sd">            features (list[str]): List of features to compute. See individual compute_...() functions for output format</span>
<span class="sd">            exclude (list[str], optional): List of features to ignore. Will override the features parameter. Defaults to [].</span>
<span class="sd">            window_s (int, optional): Length of each window in seconds. Note that some features break with very short window times. Defaults to 4.</span>
<span class="sd">            suppress_short_interval_error (bool, optional): If True, suppress ValueError for short intervals between timestamps in resulting WindowAnalysisResult. Useful for aggregated WARs. Defaults to False.</span>
<span class="sd">            apply_notch_filter (bool, optional): Whether to apply notch filtering to remove line noise. Uses constants.LINE_FREQ. Defaults to True.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError: If a feature&#39;s compute_...() function was not implemented, this error will be raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            window_analysis_result: a WindowAnalysisResult object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">_sanitize_feature_request</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>

        <span class="n">dataframes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">:</span>  <span class="c1"># Iterate over all long recordings</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing windowed analysis for </span><span class="si">{</span><span class="n">lrec</span><span class="o">.</span><span class="n">base_folder_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lan</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">LongRecordingAnalyzer</span><span class="p">(</span><span class="n">lrec</span><span class="p">,</span> <span class="n">fragment_len_s</span><span class="o">=</span><span class="n">window_s</span><span class="p">,</span> <span class="n">apply_notch_filter</span><span class="o">=</span><span class="n">apply_notch_filter</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lan</span><span class="o">.</span><span class="n">n_fragments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No fragments found for </span><span class="si">{</span><span class="n">lrec</span><span class="o">.</span><span class="n">base_folder_path</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">lan</span><span class="o">.</span><span class="n">n_fragments</span><span class="si">}</span><span class="s2"> fragments&quot;</span><span class="p">)</span>
            <span class="n">miniters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lan</span><span class="o">.</span><span class="n">n_fragments</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">match</span> <span class="n">multiprocess_mode</span><span class="p">:</span>
                <span class="k">case</span> <span class="s2">&quot;dask&quot;</span><span class="p">:</span>
                    <span class="c1"># The last fragment is not included because it makes the dask array ragged</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Converting LongRecording to numpy array&quot;</span><span class="p">)</span>

                    <span class="n">n_fragments_war</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lan</span><span class="o">.</span><span class="n">n_fragments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">first_fragment</span> <span class="o">=</span> <span class="n">lan</span><span class="o">.</span><span class="n">get_fragment_np</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">np_fragments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_fragments_war</span><span class="p">,)</span> <span class="o">+</span> <span class="n">first_fragment</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">first_fragment</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;np_fragments.shape: </span><span class="si">{</span><span class="n">np_fragments</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_fragments_war</span><span class="p">):</span>
                        <span class="n">np_fragments</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lan</span><span class="o">.</span><span class="n">get_fragment_np</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

                    <span class="c1"># Cache fragments to zarr</span>
                    <span class="n">tmppath</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">cache_fragments_to_zarr</span><span class="p">(</span><span class="n">np_fragments</span><span class="p">,</span> <span class="n">n_fragments_war</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">np_fragments</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing metadata serially&quot;</span><span class="p">)</span>
                    <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_fragment_metadata</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">lan</span><span class="p">,</span> <span class="n">window_s</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_fragments_war</span><span class="p">)]</span>
                    <span class="n">meta_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadatas</span><span class="p">)</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing features in parallel&quot;</span><span class="p">)</span>
                    <span class="n">np_fragments_reconstruct</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_zarr</span><span class="p">(</span><span class="n">tmppath</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dask array shape: </span><span class="si">{</span><span class="n">np_fragments_reconstruct</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dask array chunks: </span><span class="si">{</span><span class="n">np_fragments_reconstruct</span><span class="o">.</span><span class="n">chunks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Create delayed tasks for each fragment using efficient dependency resolution</span>
                    <span class="n">feature_values</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">delayed</span><span class="p">(</span><span class="n">FragmentAnalyzer</span><span class="o">.</span><span class="n">process_fragment_with_dependencies</span><span class="p">)(</span>
                            <span class="n">np_fragments_reconstruct</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">lan</span><span class="o">.</span><span class="n">f_s</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">kwargs</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_fragments_war</span><span class="p">)</span>
                    <span class="p">]</span>

                    <span class="c1"># Compute features in parallel</span>
                    <span class="n">feature_values</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">feature_values</span><span class="p">)</span>

                    <span class="c1"># Clean up temp directory after processing</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cleaning up temp directory&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmppath</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove temporary directory </span><span class="si">{</span><span class="n">tmppath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Combining metadata and feature values&quot;</span><span class="p">)</span>
                    <span class="n">feat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">feature_values</span><span class="p">)</span>
                    <span class="n">lan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">meta_df</span><span class="p">,</span> <span class="n">feat_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing serially&quot;</span><span class="p">)</span>
                    <span class="n">lan_df</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lan</span><span class="o">.</span><span class="n">n_fragments</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing rows&quot;</span><span class="p">,</span> <span class="n">miniters</span><span class="o">=</span><span class="n">miniters</span><span class="p">):</span>
                        <span class="n">lan_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_fragment_serial</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">lan</span><span class="p">,</span> <span class="n">window_s</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

            <span class="n">lan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lan_df</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Validating timestamps&quot;</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">validate_timestamps</span><span class="p">(</span><span class="n">lan_df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">lan_df</span> <span class="o">=</span> <span class="n">lan_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">long_analyzers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lan</span><span class="p">)</span>
            <span class="n">dataframes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lan_df</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dataframes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span>

        <span class="c1"># Collect LOF scores from long recordings</span>
        <span class="n">lof_scores_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Checking LOF scores for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: has_attr=</span><span class="si">{</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">lrec</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lof_scores&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is_not_none=</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">lrec</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lof_scores&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lrec</span><span class="p">,</span> <span class="s2">&quot;lof_scores&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lrec</span><span class="o">.</span><span class="n">lof_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lof_scores_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;lof_scores&quot;</span><span class="p">:</span> <span class="n">lrec</span><span class="o">.</span><span class="n">lof_scores</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s2">&quot;channel_names&quot;</span><span class="p">:</span> <span class="n">lrec</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added LOF scores for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lrec</span><span class="o">.</span><span class="n">lof_scores</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total LOF scores collected: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lof_scores_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"> animal days&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">window_analysis_result</span> <span class="o">=</span> <span class="n">WindowAnalysisResult</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="p">,</span>
            <span class="n">suppress_short_interval_error</span><span class="p">,</span>
            <span class="n">lof_scores_dict</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_analysis_result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_spike_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiprocess_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dask&quot;</span><span class="p">,</span> <span class="s2">&quot;serial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;serial&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute spike sorting on all long recordings and return a list of SpikeAnalysisResult objects</span>

<span class="sd">        Args:</span>
<span class="sd">            multiprocess_mode (Literal[&#39;dask&#39;, &#39;serial&#39;]): Whether to use Dask for parallel processing. Defaults to &#39;serial&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            spike_analysis_results: list[SpikeAnalysisResult]. Each SpikeAnalysisResult object corresponds to a LongRecording object,</span>
<span class="sd">            typically a different day or recording session.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: If mountainsort5 is not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if mountainsort5 is available</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MOUNTAINSORT_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Spike analysis requires mountainsort5. Install it with: pip install mountainsort5&quot;</span><span class="p">)</span>
        <span class="n">sars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lrec_sorts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lrec_recs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="p">[</span><span class="n">lrec</span><span class="o">.</span><span class="n">LongRecording</span> <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sorting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span><span class="si">}</span><span class="s2"> recordings&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">get_total_samples</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span><span class="si">}</span><span class="s2"> because it has no samples&quot;</span><span class="p">)</span>
                <span class="n">sortings</span><span class="p">,</span> <span class="n">recordings</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sortings</span><span class="p">,</span> <span class="n">recordings</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">MountainSortAnalyzer</span><span class="o">.</span><span class="n">sort_recording</span><span class="p">(</span>
                    <span class="n">rec</span><span class="p">,</span> <span class="n">multiprocess_mode</span><span class="o">=</span><span class="n">multiprocess_mode</span>
                <span class="p">)</span>
            <span class="n">lrec_sorts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sortings</span><span class="p">)</span>
            <span class="n">lrec_recs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recordings</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">multiprocess_mode</span> <span class="o">==</span> <span class="s2">&quot;dask&quot;</span><span class="p">:</span>
            <span class="n">lrec_sorts</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">lrec_sorts</span><span class="p">)</span>

        <span class="n">lrec_sas</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">si</span><span class="o">.</span><span class="n">create_sorting_analyzer</span><span class="p">(</span><span class="n">sorting</span><span class="p">,</span> <span class="n">recording</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sorting</span><span class="p">,</span> <span class="n">recording</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sortings</span><span class="p">,</span> <span class="n">recordings</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">sortings</span><span class="p">,</span> <span class="n">recordings</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lrec_sorts</span><span class="p">,</span> <span class="n">lrec_recs</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">sars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">SpikeAnalysisResult</span><span class="p">(</span>
                <span class="n">result_sas</span><span class="o">=</span><span class="n">sas</span><span class="p">,</span>
                <span class="n">result_mne</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">animal_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
                <span class="n">genotype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
                <span class="n">animal_day</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">bin_folder_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                <span class="n">channel_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
                <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sas</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lrec_sas</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spike_analysis_results</span> <span class="o">=</span> <span class="n">sars</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spike_analysis_results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_frequency_domain_spike_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">detection_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multiprocess_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dask&quot;</span><span class="p">,</span> <span class="s2">&quot;serial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;serial&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute frequency-domain spike detection on all long recordings.</span>

<span class="sd">        Args:</span>
<span class="sd">            detection_params (dict, optional): Detection parameters. Uses defaults if None.</span>
<span class="sd">            max_length (int, optional): Maximum length in samples to analyze per recording</span>
<span class="sd">            multiprocess_mode (Literal[&quot;dask&quot;, &quot;serial&quot;]): Processing mode</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[FrequencyDomainSpikeAnalysisResult]: Results for each recording session</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: If SpikeInterface is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import here to avoid circular imports</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.frequency_domain_results</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrequencyDomainSpikeAnalysisResult</span>

        <span class="n">fdsar_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="p">[</span><span class="n">lrec</span><span class="o">.</span><span class="n">LongRecording</span> <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running frequency-domain spike detection on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span><span class="si">}</span><span class="s2"> recordings&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detection parameters: </span><span class="si">{</span><span class="n">detection_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">get_total_samples</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2"> because it has no samples&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Run frequency domain spike detection</span>
                <span class="n">spike_indices_per_channel</span><span class="p">,</span> <span class="n">mne_raw_with_annotations</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">FrequencyDomainSpikeDetector</span><span class="o">.</span><span class="n">detect_spikes_recording</span><span class="p">(</span>
                        <span class="n">rec</span><span class="p">,</span>
                        <span class="n">detection_params</span><span class="o">=</span><span class="n">detection_params</span><span class="p">,</span>
                        <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
                        <span class="n">multiprocess_mode</span><span class="o">=</span><span class="n">multiprocess_mode</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Create FrequencyDomainSpikeAnalysisResult</span>
                <span class="n">fdsar</span> <span class="o">=</span> <span class="n">FrequencyDomainSpikeAnalysisResult</span><span class="o">.</span><span class="n">from_detection_results</span><span class="p">(</span>
                    <span class="n">spike_indices_per_channel</span><span class="o">=</span><span class="n">spike_indices_per_channel</span><span class="p">,</span>
                    <span class="n">mne_raw_with_annotations</span><span class="o">=</span><span class="n">mne_raw_with_annotations</span><span class="p">,</span>
                    <span class="n">detection_params</span><span class="o">=</span><span class="n">detection_params</span> <span class="ow">or</span> <span class="p">{},</span>
                    <span class="n">animal_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
                    <span class="n">genotype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
                    <span class="n">animal_day</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">bin_folder_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                    <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">fdsar_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fdsar</span><span class="p">)</span>

                <span class="c1"># Log results</span>
                <span class="n">total_spikes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spikes</span><span class="p">)</span> <span class="k">for</span> <span class="n">spikes</span> <span class="ow">in</span> <span class="n">spike_indices_per_channel</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recording </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span><span class="si">}</span><span class="s2">: Detected </span><span class="si">{</span><span class="n">total_spikes</span><span class="si">}</span><span class="s2"> spikes across </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">spike_indices_per_channel</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing recording </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="c1"># Store results for later access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency_domain_spike_analysis_results</span> <span class="o">=</span> <span class="n">fdsar_list</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed frequency-domain spike detection. Total recordings processed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fdsar_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fdsar_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_fragment_serial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">lan</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">LongRecordingAnalyzer</span><span class="p">,</span> <span class="n">window_s</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_fragment_metadata</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">lan</span><span class="p">,</span> <span class="n">window_s</span><span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_fragment_features</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">lan</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_fragment_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">lan</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">LongRecordingAnalyzer</span><span class="p">,</span> <span class="n">window_s</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">lan_folder</span> <span class="o">=</span> <span class="n">lan</span><span class="o">.</span><span class="n">LongRecording</span><span class="o">.</span><span class="n">base_folder_path</span>
        <span class="n">animalday_dict</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">parse_path_to_animalday</span><span class="p">(</span>
            <span class="n">lan_folder</span><span class="p">,</span> <span class="n">animal_param</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_param</span><span class="p">,</span> <span class="n">day_sep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">day_sep</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_mode</span>
        <span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">animalday_dict</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">animalday_dict</span><span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">animalday_dict</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;genotype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">animalday_dict</span><span class="p">[</span><span class="s2">&quot;genotype&quot;</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lan</span><span class="o">.</span><span class="n">LongRecording</span><span class="o">.</span><span class="n">get_dur_fragment</span><span class="p">(</span><span class="n">window_s</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;endfile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lan</span><span class="o">.</span><span class="n">get_file_end</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="n">frag_dt</span> <span class="o">=</span> <span class="n">lan</span><span class="o">.</span><span class="n">LongRecording</span><span class="o">.</span><span class="n">get_datetime_fragment</span><span class="p">(</span><span class="n">window_s</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frag_dt</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;isday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">is_day</span><span class="p">(</span><span class="n">frag_dt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_fragment_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">lan</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">LongRecordingAnalyzer</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lan</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;compute_</span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                <span class="n">row</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid function </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.AnimalOrganizer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">base_folder_path</span><span class="p">,</span> <span class="n">anim_id</span><span class="p">,</span> <span class="n">day_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_days</span><span class="o">=</span><span class="p">[],</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lro_kwargs</span><span class="o">=</span><span class="p">{})</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>AnimalOrganizer is used to organize data from a single animal into a format that can be used for analysis.
It is used to organize data from a single animal into a format that can be used for analysis.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>base_folder_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the base folder of the animal data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>anim_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the animal. This should correspond to only one animal.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>day_sep</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Separator for day in folder name. Set to None or empty string to get all folders. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;nest&#39;, &#39;concat&#39;, &#39;base&#39;, &#39;noday&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The mode of the AnimalOrganizer. Defaults to "concat".
File structure patterns (where * indicates search location):
"nest": base_folder_path / animal_id / <em>date_format</em> (looks for folders/files within animal_id subdirectories)
"concat": base_folder_path / <em>animal_id</em>date_format<em> (looks for folders/files with animal_id+date in name at base level)
"base": base_folder_path / * (looks for folders/files directly in base_folder_path)
"noday": base_folder_path / </em>animal_id* (same as concat but expects single unique match, no date filtering)</p>
              </div>
            </td>
            <td>
                  <code>&#39;concat&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>assume_from_number</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to assume the animal ID is a number. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>skip_days</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The days to skip. Defaults to [].</p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>truncate</code>
            </td>
            <td>
                  <code><span title="bool">bool</span> | <span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to truncate the data. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lro_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keyword arguments for LongRecordingOrganizer. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">base_folder_path</span><span class="p">,</span>
    <span class="n">anim_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">day_sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;nest&quot;</span><span class="p">,</span> <span class="s2">&quot;concat&quot;</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;noday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;concat&quot;</span><span class="p">,</span>
    <span class="n">assume_from_number</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skip_days</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">truncate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">lro_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AnimalOrganizer is used to organize data from a single animal into a format that can be used for analysis.</span>
<span class="sd">    It is used to organize data from a single animal into a format that can be used for analysis.</span>

<span class="sd">    Args:</span>
<span class="sd">        base_folder_path (str): The path to the base folder of the animal data.</span>
<span class="sd">        anim_id (str): The ID of the animal. This should correspond to only one animal.</span>
<span class="sd">        day_sep (str, optional): Separator for day in folder name. Set to None or empty string to get all folders. Defaults to None.</span>
<span class="sd">        mode (Literal[&quot;nest&quot;, &quot;concat&quot;, &quot;base&quot;, &quot;noday&quot;], optional): The mode of the AnimalOrganizer. Defaults to &quot;concat&quot;.</span>
<span class="sd">            File structure patterns (where * indicates search location):</span>
<span class="sd">            &quot;nest&quot;: base_folder_path / animal_id / *date_format* (looks for folders/files within animal_id subdirectories)</span>
<span class="sd">            &quot;concat&quot;: base_folder_path / *animal_id*date_format* (looks for folders/files with animal_id+date in name at base level)</span>
<span class="sd">            &quot;base&quot;: base_folder_path / * (looks for folders/files directly in base_folder_path)</span>
<span class="sd">            &quot;noday&quot;: base_folder_path / *animal_id* (same as concat but expects single unique match, no date filtering)</span>
<span class="sd">        assume_from_number (bool, optional): Whether to assume the animal ID is a number. Defaults to False.</span>
<span class="sd">        skip_days (list[str], optional): The days to skip. Defaults to [].</span>
<span class="sd">        truncate (bool|int, optional): Whether to truncate the data. Defaults to False.</span>
<span class="sd">        lro_kwargs (dict, optional): Keyword arguments for LongRecordingOrganizer. Defaults to {}.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">base_folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">base_folder_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">anim_id</span> <span class="o">=</span> <span class="n">anim_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">animal_param</span> <span class="o">=</span> <span class="p">[</span><span class="n">anim_id</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">day_sep</span> <span class="o">=</span> <span class="n">day_sep</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">read_mode</span> <span class="o">=</span> <span class="n">mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span> <span class="o">=</span> <span class="n">assume_from_number</span>

    <span class="k">match</span> <span class="n">mode</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;nest&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_folder_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anim_id</span><span class="si">}</span><span class="s2">*&quot;</span> <span class="o">/</span> <span class="s2">&quot;*&quot;</span>
        <span class="k">case</span> <span class="s2">&quot;concat&quot;</span> <span class="o">|</span> <span class="s2">&quot;noday&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_folder_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anim_id</span><span class="si">}</span><span class="s2">*&quot;</span>
            <span class="c1"># self.bin_folder_pat = self.base_folder_path / f&quot;*{self.anim_id}*{self.date_format}*&quot;</span>
        <span class="k">case</span> <span class="s2">&quot;base&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_folder_path</span>
        <span class="c1"># case &#39;noday&#39;:</span>
        <span class="c1">#     self.bin_folder_pat = self.base_folder_path / f&quot;*{self.anim_id}*&quot;</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span><span class="p">))</span>

    <span class="c1"># Filter to only include directories (LongRecordingOrganizer expects folder paths)</span>
    <span class="n">before_filter_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
    <span class="n">after_filter_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">before_filter_count</span> <span class="o">&gt;</span> <span class="n">after_filter_count</span><span class="p">:</span>
        <span class="n">filtered_count</span> <span class="o">=</span> <span class="n">before_filter_count</span> <span class="o">-</span> <span class="n">after_filter_count</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered out </span><span class="si">{</span><span class="n">filtered_count</span><span class="si">}</span><span class="s2"> non-directory items (files) from glob results&quot;</span><span class="p">)</span>

    <span class="c1"># if mode != &#39;noday&#39;:</span>
    <span class="c1">#     self.__bin_folders = [x for x in self.__bin_folders if datetime.strptime(Path(x).name, self.date_format)]</span>
    <span class="n">truncate</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parse_truncate</span><span class="p">(</span><span class="n">truncate</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">truncate</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AnimalOrganizer will be truncated to the first </span><span class="si">{</span><span class="n">truncate</span><span class="si">}</span><span class="s2"> LongRecordings&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">[:</span><span class="n">truncate</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">y</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">skip_days</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bin_folder_pattern: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self._bin_folders: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self.bin_folder_names: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;noday&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Animal ID &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anim_id</span><span class="si">}</span><span class="s2">&#39; is not unique, found: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No directories found for animal ID </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anim_id</span><span class="si">}</span><span class="s2"> (pattern: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_pattern</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_dicts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">core</span><span class="o">.</span><span class="n">parse_path_to_animalday</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">animal_param</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_param</span><span class="p">,</span> <span class="n">day_sep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">day_sep</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_mode</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span>
    <span class="p">]</span>

    <span class="c1"># Group folders by parsed animalday to handle overlapping days</span>
    <span class="n">animalday_to_folders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">animalday_dict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_folders</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_dicts</span><span class="p">):</span>
        <span class="n">animalday</span> <span class="o">=</span> <span class="n">animalday_dict</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">animalday</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">animalday_to_folders</span><span class="p">:</span>
            <span class="n">animalday_to_folders</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">animalday_to_folders</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="c1"># Store grouping info</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_folder_groups</span> <span class="o">=</span> <span class="n">animalday_to_folders</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">unique_animaldays</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">animalday_to_folders</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Log merging operations for overlapping days</span>
    <span class="n">overlapping_days</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">folders</span> <span class="ow">in</span> <span class="n">animalday_to_folders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">overlapping_days</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merging </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span><span class="si">}</span><span class="s2"> folders for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">folders</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">overlapping_days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">overlapping_days</span><span class="si">}</span><span class="s2"> animaldays with overlapping folders&quot;</span><span class="p">)</span>

    <span class="c1"># Update animaldays to reflect unique days (not total folders)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_animaldays</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self.animaldays (unique): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">genotypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;genotype&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_dicts</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">genotypes</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inconsistent genotypes in </span><span class="si">{</span><span class="n">genotypes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span> <span class="o">=</span> <span class="n">genotypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self.genotype: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">long_analyzers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">core</span><span class="o">.</span><span class="n">LongRecordingAnalyzer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_animaldays</span><span class="p">)</span><span class="si">}</span><span class="s2"> LongRecordings (one per unique animalday)&quot;</span><span class="p">)</span>

    <span class="c1"># Process manual_datetimes if provided in lro_kwargs</span>
    <span class="k">if</span> <span class="s2">&quot;manual_datetimes&quot;</span> <span class="ow">in</span> <span class="n">lro_kwargs</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing manual_datetimes configuration&quot;</span><span class="p">)</span>
        <span class="n">base_lro_kwargs</span> <span class="o">=</span> <span class="n">lro_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">base_lro_kwargs</span><span class="p">[</span><span class="s2">&quot;manual_datetimes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_processed_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_timestamps</span><span class="p">(</span>
            <span class="n">lro_kwargs</span><span class="p">[</span><span class="s2">&quot;manual_datetimes&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_animalday_folder_groups</span><span class="p">,</span> <span class="n">base_lro_kwargs</span>
        <span class="p">)</span>
        <span class="c1"># Remove from lro_kwargs since we&#39;ll handle it manually</span>
        <span class="n">lro_kwargs</span> <span class="o">=</span> <span class="n">base_lro_kwargs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processed_timestamps</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create LongRecordingOrganizer instances</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_create_long_recordings</span><span class="p">(</span><span class="n">lro_kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.AnimalOrganizer.apply_lof_threshold" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_lof_threshold</span><span class="p">(</span><span class="n">lof_threshold</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Apply threshold to existing LOF scores to determine bad channels for all recordings.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lof_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for determining bad channels.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_lof_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lof_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply threshold to existing LOF scores to determine bad channels for all recordings.</span>

<span class="sd">    Args:</span>
<span class="sd">        lof_threshold (float): Threshold for determining bad channels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">:</span>
        <span class="n">lrec</span><span class="o">.</span><span class="n">apply_lof_threshold</span><span class="p">(</span><span class="n">lof_threshold</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">animalday</span><span class="p">:</span> <span class="n">lrec</span><span class="o">.</span><span class="n">bad_channel_names</span> <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.AnimalOrganizer.compute_bad_channels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_bad_channels</span><span class="p">(</span><span class="n">lof_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute bad channels using LOF analysis for all recordings.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lof_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for determining bad channels from LOF scores.
                           If None, only computes/loads scores without setting bad_channel_names.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force_recompute</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to recompute LOF scores even if they exist.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_bad_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lof_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force_recompute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute bad channels using LOF analysis for all recordings.</span>

<span class="sd">    Args:</span>
<span class="sd">        lof_threshold (float, optional): Threshold for determining bad channels from LOF scores.</span>
<span class="sd">                                       If None, only computes/loads scores without setting bad_channel_names.</span>
<span class="sd">        force_recompute (bool): Whether to recompute LOF scores even if they exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Computing bad channels for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">)</span><span class="si">}</span><span class="s2"> recordings with threshold=</span><span class="si">{</span><span class="n">lof_threshold</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing bad channels for recording </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lrec</span><span class="o">.</span><span class="n">compute_bad_channels</span><span class="p">(</span><span class="n">lof_threshold</span><span class="o">=</span><span class="n">lof_threshold</span><span class="p">,</span> <span class="n">force_recompute</span><span class="o">=</span><span class="n">force_recompute</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Recording </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> LOF scores computed: </span><span class="si">{</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">lrec</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lof_scores&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">lrec</span><span class="o">.</span><span class="n">lof_scores</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Update bad channels dict if threshold was applied</span>
    <span class="k">if</span> <span class="n">lof_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">animalday</span><span class="p">:</span> <span class="n">lrec</span><span class="o">.</span><span class="n">bad_channel_names</span> <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.AnimalOrganizer.compute_frequency_domain_spike_analysis" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_frequency_domain_spike_analysis</span><span class="p">(</span><span class="n">detection_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multiprocess_mode</span><span class="o">=</span><span class="s1">&#39;serial&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute frequency-domain spike detection on all long recordings.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>detection_params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Detection parameters. Uses defaults if None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_length</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum length in samples to analyze per recording</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>multiprocess_mode</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;dask&#39;, &#39;serial&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processing mode</p>
              </div>
            </td>
            <td>
                  <code>&#39;serial&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[FrequencyDomainSpikeAnalysisResult]: Results for each recording session</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If SpikeInterface is not available</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_frequency_domain_spike_analysis</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">detection_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">multiprocess_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dask&quot;</span><span class="p">,</span> <span class="s2">&quot;serial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;serial&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute frequency-domain spike detection on all long recordings.</span>

<span class="sd">    Args:</span>
<span class="sd">        detection_params (dict, optional): Detection parameters. Uses defaults if None.</span>
<span class="sd">        max_length (int, optional): Maximum length in samples to analyze per recording</span>
<span class="sd">        multiprocess_mode (Literal[&quot;dask&quot;, &quot;serial&quot;]): Processing mode</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[FrequencyDomainSpikeAnalysisResult]: Results for each recording session</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If SpikeInterface is not available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Import here to avoid circular imports</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.frequency_domain_results</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrequencyDomainSpikeAnalysisResult</span>

    <span class="n">fdsar_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="p">[</span><span class="n">lrec</span><span class="o">.</span><span class="n">LongRecording</span> <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">]</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running frequency-domain spike detection on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span><span class="si">}</span><span class="s2"> recordings&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detection parameters: </span><span class="si">{</span><span class="n">detection_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">get_total_samples</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2"> because it has no samples&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Run frequency domain spike detection</span>
            <span class="n">spike_indices_per_channel</span><span class="p">,</span> <span class="n">mne_raw_with_annotations</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">FrequencyDomainSpikeDetector</span><span class="o">.</span><span class="n">detect_spikes_recording</span><span class="p">(</span>
                    <span class="n">rec</span><span class="p">,</span>
                    <span class="n">detection_params</span><span class="o">=</span><span class="n">detection_params</span><span class="p">,</span>
                    <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
                    <span class="n">multiprocess_mode</span><span class="o">=</span><span class="n">multiprocess_mode</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Create FrequencyDomainSpikeAnalysisResult</span>
            <span class="n">fdsar</span> <span class="o">=</span> <span class="n">FrequencyDomainSpikeAnalysisResult</span><span class="o">.</span><span class="n">from_detection_results</span><span class="p">(</span>
                <span class="n">spike_indices_per_channel</span><span class="o">=</span><span class="n">spike_indices_per_channel</span><span class="p">,</span>
                <span class="n">mne_raw_with_annotations</span><span class="o">=</span><span class="n">mne_raw_with_annotations</span><span class="p">,</span>
                <span class="n">detection_params</span><span class="o">=</span><span class="n">detection_params</span> <span class="ow">or</span> <span class="p">{},</span>
                <span class="n">animal_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
                <span class="n">genotype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
                <span class="n">animal_day</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">bin_folder_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">fdsar_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fdsar</span><span class="p">)</span>

            <span class="c1"># Log results</span>
            <span class="n">total_spikes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spikes</span><span class="p">)</span> <span class="k">for</span> <span class="n">spikes</span> <span class="ow">in</span> <span class="n">spike_indices_per_channel</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recording </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span><span class="si">}</span><span class="s2">: Detected </span><span class="si">{</span><span class="n">total_spikes</span><span class="si">}</span><span class="s2"> spikes across </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">spike_indices_per_channel</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing recording </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="c1"># Store results for later access</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">frequency_domain_spike_analysis_results</span> <span class="o">=</span> <span class="n">fdsar_list</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed frequency-domain spike detection. Total recordings processed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fdsar_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fdsar_list</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.AnimalOrganizer.compute_spike_analysis" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_spike_analysis</span><span class="p">(</span><span class="n">multiprocess_mode</span><span class="o">=</span><span class="s1">&#39;serial&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute spike sorting on all long recordings and return a list of SpikeAnalysisResult objects</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>multiprocess_mode</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;dask&#39;, &#39;serial&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use Dask for parallel processing. Defaults to 'serial'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;serial&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>spike_analysis_results</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[SpikeAnalysisResult]. Each SpikeAnalysisResult object corresponds to a LongRecording object,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>typically a different day or recording session.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If mountainsort5 is not available.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_spike_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiprocess_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dask&quot;</span><span class="p">,</span> <span class="s2">&quot;serial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;serial&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute spike sorting on all long recordings and return a list of SpikeAnalysisResult objects</span>

<span class="sd">    Args:</span>
<span class="sd">        multiprocess_mode (Literal[&#39;dask&#39;, &#39;serial&#39;]): Whether to use Dask for parallel processing. Defaults to &#39;serial&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        spike_analysis_results: list[SpikeAnalysisResult]. Each SpikeAnalysisResult object corresponds to a LongRecording object,</span>
<span class="sd">        typically a different day or recording session.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If mountainsort5 is not available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if mountainsort5 is available</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">MOUNTAINSORT_AVAILABLE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Spike analysis requires mountainsort5. Install it with: pip install mountainsort5&quot;</span><span class="p">)</span>
    <span class="n">sars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lrec_sorts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lrec_recs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="p">[</span><span class="n">lrec</span><span class="o">.</span><span class="n">LongRecording</span> <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sorting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span><span class="si">}</span><span class="s2"> recordings&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">get_total_samples</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span><span class="si">}</span><span class="s2"> because it has no samples&quot;</span><span class="p">)</span>
            <span class="n">sortings</span><span class="p">,</span> <span class="n">recordings</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sortings</span><span class="p">,</span> <span class="n">recordings</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">MountainSortAnalyzer</span><span class="o">.</span><span class="n">sort_recording</span><span class="p">(</span>
                <span class="n">rec</span><span class="p">,</span> <span class="n">multiprocess_mode</span><span class="o">=</span><span class="n">multiprocess_mode</span>
            <span class="p">)</span>
        <span class="n">lrec_sorts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sortings</span><span class="p">)</span>
        <span class="n">lrec_recs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recordings</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">multiprocess_mode</span> <span class="o">==</span> <span class="s2">&quot;dask&quot;</span><span class="p">:</span>
        <span class="n">lrec_sorts</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">lrec_sorts</span><span class="p">)</span>

    <span class="n">lrec_sas</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="n">si</span><span class="o">.</span><span class="n">create_sorting_analyzer</span><span class="p">(</span><span class="n">sorting</span><span class="p">,</span> <span class="n">recording</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sorting</span><span class="p">,</span> <span class="n">recording</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sortings</span><span class="p">,</span> <span class="n">recordings</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">sortings</span><span class="p">,</span> <span class="n">recordings</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lrec_sorts</span><span class="p">,</span> <span class="n">lrec_recs</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">sars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">SpikeAnalysisResult</span><span class="p">(</span>
            <span class="n">result_sas</span><span class="o">=</span><span class="n">sas</span><span class="p">,</span>
            <span class="n">result_mne</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">animal_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
            <span class="n">genotype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
            <span class="n">animal_day</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">bin_folder_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
            <span class="n">channel_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
            <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sas</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lrec_sas</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">spike_analysis_results</span> <span class="o">=</span> <span class="n">sars</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spike_analysis_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.AnimalOrganizer.compute_windowed_analysis" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_windowed_analysis</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">window_s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">multiprocess_mode</span><span class="o">=</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span> <span class="n">suppress_short_interval_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_notch_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Computes windowed analysis of animal recordings. The data is divided into windows (time bins), then features are extracted from each window. The result is
formatted to a Dataframe and wrapped into a WindowAnalysisResult object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>features</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of features to compute. See individual compute_...() functions for output format</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of features to ignore. Will override the features parameter. Defaults to [].</p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>window_s</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Length of each window in seconds. Note that some features break with very short window times. Defaults to 4.</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suppress_short_interval_error</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, suppress ValueError for short intervals between timestamps in resulting WindowAnalysisResult. Useful for aggregated WARs. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_notch_filter</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply notch filtering to remove line noise. Uses constants.LINE_FREQ. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AttributeError">AttributeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a feature's compute_...() function was not implemented, this error will be raised.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>window_analysis_result</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a WindowAnalysisResult object</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_windowed_analysis</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">exclude</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">window_s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">multiprocess_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dask&quot;</span><span class="p">,</span> <span class="s2">&quot;serial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;serial&quot;</span><span class="p">,</span>
    <span class="n">suppress_short_interval_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">apply_notch_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes windowed analysis of animal recordings. The data is divided into windows (time bins), then features are extracted from each window. The result is</span>
<span class="sd">    formatted to a Dataframe and wrapped into a WindowAnalysisResult object.</span>

<span class="sd">    Args:</span>
<span class="sd">        features (list[str]): List of features to compute. See individual compute_...() functions for output format</span>
<span class="sd">        exclude (list[str], optional): List of features to ignore. Will override the features parameter. Defaults to [].</span>
<span class="sd">        window_s (int, optional): Length of each window in seconds. Note that some features break with very short window times. Defaults to 4.</span>
<span class="sd">        suppress_short_interval_error (bool, optional): If True, suppress ValueError for short intervals between timestamps in resulting WindowAnalysisResult. Useful for aggregated WARs. Defaults to False.</span>
<span class="sd">        apply_notch_filter (bool, optional): Whether to apply notch filtering to remove line noise. Uses constants.LINE_FREQ. Defaults to True.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AttributeError: If a feature&#39;s compute_...() function was not implemented, this error will be raised.</span>

<span class="sd">    Returns:</span>
<span class="sd">        window_analysis_result: a WindowAnalysisResult object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">_sanitize_feature_request</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>

    <span class="n">dataframes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">:</span>  <span class="c1"># Iterate over all long recordings</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing windowed analysis for </span><span class="si">{</span><span class="n">lrec</span><span class="o">.</span><span class="n">base_folder_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lan</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">LongRecordingAnalyzer</span><span class="p">(</span><span class="n">lrec</span><span class="p">,</span> <span class="n">fragment_len_s</span><span class="o">=</span><span class="n">window_s</span><span class="p">,</span> <span class="n">apply_notch_filter</span><span class="o">=</span><span class="n">apply_notch_filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lan</span><span class="o">.</span><span class="n">n_fragments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No fragments found for </span><span class="si">{</span><span class="n">lrec</span><span class="o">.</span><span class="n">base_folder_path</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">lan</span><span class="o">.</span><span class="n">n_fragments</span><span class="si">}</span><span class="s2"> fragments&quot;</span><span class="p">)</span>
        <span class="n">miniters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lan</span><span class="o">.</span><span class="n">n_fragments</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">match</span> <span class="n">multiprocess_mode</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;dask&quot;</span><span class="p">:</span>
                <span class="c1"># The last fragment is not included because it makes the dask array ragged</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Converting LongRecording to numpy array&quot;</span><span class="p">)</span>

                <span class="n">n_fragments_war</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lan</span><span class="o">.</span><span class="n">n_fragments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">first_fragment</span> <span class="o">=</span> <span class="n">lan</span><span class="o">.</span><span class="n">get_fragment_np</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">np_fragments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_fragments_war</span><span class="p">,)</span> <span class="o">+</span> <span class="n">first_fragment</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">first_fragment</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;np_fragments.shape: </span><span class="si">{</span><span class="n">np_fragments</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_fragments_war</span><span class="p">):</span>
                    <span class="n">np_fragments</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lan</span><span class="o">.</span><span class="n">get_fragment_np</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

                <span class="c1"># Cache fragments to zarr</span>
                <span class="n">tmppath</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">cache_fragments_to_zarr</span><span class="p">(</span><span class="n">np_fragments</span><span class="p">,</span> <span class="n">n_fragments_war</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">np_fragments</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing metadata serially&quot;</span><span class="p">)</span>
                <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_fragment_metadata</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">lan</span><span class="p">,</span> <span class="n">window_s</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_fragments_war</span><span class="p">)]</span>
                <span class="n">meta_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadatas</span><span class="p">)</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing features in parallel&quot;</span><span class="p">)</span>
                <span class="n">np_fragments_reconstruct</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_zarr</span><span class="p">(</span><span class="n">tmppath</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dask array shape: </span><span class="si">{</span><span class="n">np_fragments_reconstruct</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dask array chunks: </span><span class="si">{</span><span class="n">np_fragments_reconstruct</span><span class="o">.</span><span class="n">chunks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Create delayed tasks for each fragment using efficient dependency resolution</span>
                <span class="n">feature_values</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">delayed</span><span class="p">(</span><span class="n">FragmentAnalyzer</span><span class="o">.</span><span class="n">process_fragment_with_dependencies</span><span class="p">)(</span>
                        <span class="n">np_fragments_reconstruct</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">lan</span><span class="o">.</span><span class="n">f_s</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">kwargs</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_fragments_war</span><span class="p">)</span>
                <span class="p">]</span>

                <span class="c1"># Compute features in parallel</span>
                <span class="n">feature_values</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">feature_values</span><span class="p">)</span>

                <span class="c1"># Clean up temp directory after processing</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cleaning up temp directory&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmppath</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove temporary directory </span><span class="si">{</span><span class="n">tmppath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Combining metadata and feature values&quot;</span><span class="p">)</span>
                <span class="n">feat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">feature_values</span><span class="p">)</span>
                <span class="n">lan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">meta_df</span><span class="p">,</span> <span class="n">feat_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing serially&quot;</span><span class="p">)</span>
                <span class="n">lan_df</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lan</span><span class="o">.</span><span class="n">n_fragments</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing rows&quot;</span><span class="p">,</span> <span class="n">miniters</span><span class="o">=</span><span class="n">miniters</span><span class="p">):</span>
                    <span class="n">lan_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_fragment_serial</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">lan</span><span class="p">,</span> <span class="n">window_s</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

        <span class="n">lan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lan_df</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Validating timestamps&quot;</span><span class="p">)</span>
        <span class="n">core</span><span class="o">.</span><span class="n">validate_timestamps</span><span class="p">(</span><span class="n">lan_df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">lan_df</span> <span class="o">=</span> <span class="n">lan_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">long_analyzers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lan</span><span class="p">)</span>
        <span class="n">dataframes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lan_df</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dataframes</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span>

    <span class="c1"># Collect LOF scores from long recordings</span>
    <span class="n">lof_scores_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Checking LOF scores for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: has_attr=</span><span class="si">{</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">lrec</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lof_scores&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;is_not_none=</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">lrec</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lof_scores&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lrec</span><span class="p">,</span> <span class="s2">&quot;lof_scores&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lrec</span><span class="o">.</span><span class="n">lof_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lof_scores_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;lof_scores&quot;</span><span class="p">:</span> <span class="n">lrec</span><span class="o">.</span><span class="n">lof_scores</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="s2">&quot;channel_names&quot;</span><span class="p">:</span> <span class="n">lrec</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added LOF scores for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lrec</span><span class="o">.</span><span class="n">lof_scores</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total LOF scores collected: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lof_scores_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"> animal days&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">window_analysis_result</span> <span class="o">=</span> <span class="n">WindowAnalysisResult</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="p">,</span>
        <span class="n">suppress_short_interval_error</span><span class="p">,</span>
        <span class="n">lof_scores_dict</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_analysis_result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.AnimalOrganizer.get_all_lof_scores" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_lof_scores</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get LOF scores for all recordings.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping animal days to LOF score dictionaries.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_all_lof_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get LOF scores for all recordings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary mapping animal days to LOF score dictionaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">animalday</span><span class="p">:</span> <span class="n">lrec</span><span class="o">.</span><span class="n">get_lof_scores</span><span class="p">()</span> <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lrec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">)}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.AnimalOrganizer.get_timeline_summary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_timeline_summary</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get timeline summary as a DataFrame for user inspection and debugging.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: Timeline information with columns:
- lro_index: Index of the LRO
- start_time: Start datetime of the LRO
- end_time: End datetime of the LRO
- duration_s: Duration in seconds
- n_files: Number of files in the LRO
- folder_path: Base folder path
- animalday: Parsed animalday identifier</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_timeline_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get timeline summary as a DataFrame for user inspection and debugging.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Timeline information with columns:</span>
<span class="sd">            - lro_index: Index of the LRO</span>
<span class="sd">            - start_time: Start datetime of the LRO</span>
<span class="sd">            - end_time: End datetime of the LRO</span>
<span class="sd">            - duration_s: Duration in seconds</span>
<span class="sd">            - n_files: Number of files in the LRO</span>
<span class="sd">            - folder_path: Base folder path</span>
<span class="sd">            - animalday: Parsed animalday identifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">timeline_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lro</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_recordings</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lro_start_time</span><span class="p">(</span><span class="n">lro</span><span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lro_end_time</span><span class="p">(</span><span class="n">lro</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">lro</span><span class="o">.</span><span class="n">LongRecording</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;LongRecording&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">LongRecording</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">n_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lro</span><span class="o">.</span><span class="n">file_durations</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;file_durations&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lro</span><span class="o">.</span><span class="n">file_durations</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">folder_path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;base_folder_path&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>

            <span class="n">timeline_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;lro_index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">start_time</span><span class="p">,</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">end_time</span><span class="p">,</span>
                    <span class="s2">&quot;duration_s&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                    <span class="s2">&quot;n_files&quot;</span><span class="p">:</span> <span class="n">n_files</span><span class="p">,</span>
                    <span class="s2">&quot;folder_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder_path</span><span class="p">),</span>
                    <span class="s2">&quot;folder_name&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">folder_path</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;animalday&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">lro</span><span class="p">,</span> <span class="s2">&quot;_animalday&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span>
                    <span class="p">),</span>  <span class="c1"># This might not exist, but useful if it does</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Include failed LROs in the summary for debugging</span>
            <span class="n">timeline_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;lro_index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;duration_s&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;n_files&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;folder_name&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;animalday&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">timeline_data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="neurodent.visualization.results.SpikeAnalysisResult" class="doc doc-heading">
            <code>SpikeAnalysisResult</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="neurodent.visualization.results.AnimalFeatureParser">AnimalFeatureParser</span></code></p>









              <details class="quote">
                <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SpikeAnalysisResult</span><span class="p">(</span><span class="n">AnimalFeatureParser</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result_sas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">si</span><span class="o">.</span><span class="n">SortingAnalyzer</span><span class="p">],</span>
        <span class="n">result_mne</span><span class="p">:</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">animal_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">genotype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">animal_day</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bin_folder_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">DDFBinaryMetadata</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">channel_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">assume_from_number</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            result (list[si.SortingAnalyzer]): Result comes from AnimalOrganizer.compute_spike_analysis(). Each SortingAnalyzer is a single channel.</span>
<span class="sd">            animal_id (str, optional): Identifier for the animal where result was computed from. Defaults to None.</span>
<span class="sd">            genotype (str, optional): Genotype of animal. Defaults to None.</span>
<span class="sd">            channel_names (list[str], optional): List of channel names. Defaults to None.</span>
<span class="sd">            assume_channels (bool, optional): If true, assumes channel names according to AnimalFeatureParser.DEFAULT_CHNUM_TO_NAME. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_sas</span> <span class="o">=</span> <span class="n">result_sas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_mne</span> <span class="o">=</span> <span class="n">result_mne</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result_mne</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">result_sas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Exactly one of result_sas or result_mne must be provided&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span> <span class="o">=</span> <span class="n">animal_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span> <span class="o">=</span> <span class="n">genotype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animal_day</span> <span class="o">=</span> <span class="n">animal_day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_name</span> <span class="o">=</span> <span class="n">bin_folder_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="n">channel_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span> <span class="o">=</span> <span class="n">assume_from_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">core</span><span class="o">.</span><span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="n">assume_from_number</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span>
        <span class="p">]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel names: </span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel abbreviations: </span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_to_mne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_len</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">save_raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_mne</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result_mne</span> <span class="o">=</span> <span class="n">SpikeAnalysisResult</span><span class="o">.</span><span class="n">convert_sas_to_mne</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_sas</span><span class="p">,</span> <span class="n">chunk_len</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_raw</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_mne</span> <span class="o">=</span> <span class="n">result_mne</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result_mne</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_mne</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_fif_and_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">convert_to_mne</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">make_folder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">slugify_filebase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">save_abbrevs_as_chnames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Archive spike analysis result into the folder specified, as a fif and json file.</span>

<span class="sd">        Args:</span>
<span class="sd">            folder (str | Path): Destination folder to save results to</span>
<span class="sd">            convert_to_mne (bool, optional): If True, convert the SortingAnalyzers to a MNE RawArray if self.result_mne is None. Defaults to True.</span>
<span class="sd">            make_folder (bool, optional): If True, create the folder if it doesn&#39;t exist. Defaults to True.</span>
<span class="sd">            slugify_filebase (bool, optional): If True, slugify the filebase (replace special characters). Defaults to True.</span>
<span class="sd">            save_abbrevs_as_chnames (bool, optional): If True, save the channel abbreviations as the channel names in the json file. Defaults to False.</span>
<span class="sd">            overwrite (bool, optional): If True, overwrite the existing files. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_mne</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">convert_to_mne</span><span class="p">:</span>
                <span class="n">result_mne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_mne</span><span class="p">(</span><span class="n">save_raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result_mne</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No SortingAnalyzers found, skipping saving&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No MNE RawArray found, and convert_to_mne is False. Run convert_to_mne() first.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_mne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_mne</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">make_folder</span><span class="p">:</span>
            <span class="n">folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slugify_filebase</span><span class="p">:</span>
            <span class="n">filebase</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="n">slugify</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_day</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filebase</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_day</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">filebase</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filebase</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filebase</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filebase</span><span class="si">}</span><span class="s2">.json already exists&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filebase</span> <span class="o">+</span> <span class="s2">&quot;.fif&quot;</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.fif&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filebase</span><span class="si">}</span><span class="s2">.fif already exists&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="n">result_mne</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filebase</span> <span class="o">+</span> <span class="s2">&quot;-raw.fif&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">result_mne</span>

        <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;animal_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
            <span class="s2">&quot;genotype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
            <span class="s2">&quot;animal_day&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">animal_day</span><span class="p">,</span>
            <span class="s2">&quot;bin_folder_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_name</span><span class="p">,</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">,</span>
            <span class="s2">&quot;channel_names&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="k">if</span> <span class="n">save_abbrevs_as_chnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
            <span class="s2">&quot;assume_from_number&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">save_abbrevs_as_chnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filebase</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_fif_and_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>

        <span class="n">fif_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.fif&quot;</span><span class="p">))</span>  <span class="c1"># there may be more than 1 fif file</span>
        <span class="n">json_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected exactly one json file in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">fif_path</span> <span class="o">=</span> <span class="n">fif_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">json_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># data[&#39;metadata&#39;] = core.DDFBinaryMetadata(data[&#39;metadata&#39;])</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;result_mne&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_raw_fif</span><span class="p">(</span><span class="n">fif_path</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;result_sas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_sas_to_mne</span><span class="p">(</span><span class="n">sas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">si</span><span class="o">.</span><span class="n">SortingAnalyzer</span><span class="p">],</span> <span class="n">chunk_len</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a list of SortingAnalyzers to a MNE RawArray.</span>

<span class="sd">        Args:</span>
<span class="sd">            sas (list[si.SortingAnalyzer]): The list of SortingAnalyzers to convert</span>
<span class="sd">            chunk_len (float, optional): The length of the chunks to use for the conversion. Defaults to 60.</span>

<span class="sd">        Returns:</span>
<span class="sd">            mne.io.RawArray: The converted RawArray, with spikes labeled as annotations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check that all SortingAnalyzers have the same sampling frequency</span>
        <span class="n">sfreqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">()</span> <span class="k">for</span> <span class="n">sa</span> <span class="ow">in</span> <span class="n">sas</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">sf</span> <span class="o">==</span> <span class="n">sfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">sf</span> <span class="ow">in</span> <span class="n">sfreqs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All SortingAnalyzers must have the same sampling frequency. Got frequencies: </span><span class="si">{</span><span class="n">sfreqs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Preallocate data array</span>
        <span class="n">total_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span> <span class="o">*</span> <span class="n">sfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_channels</span><span class="p">,</span> <span class="n">total_frames</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data shape: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Fill data array one channel at a time</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sas</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting channel </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">n_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">SpikeAnalysisResult</span><span class="o">.</span><span class="n">convert_sa_to_np</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">chunk_len</span><span class="p">)</span>

        <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="k">for</span> <span class="n">sa</span> <span class="ow">in</span> <span class="n">sas</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel names: </span><span class="si">{</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sfreq</span> <span class="o">=</span> <span class="n">sfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Extract spike times for each unit and create annotations</span>
        <span class="n">onset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sa</span> <span class="ow">in</span> <span class="n">sas</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">():</span>
                <span class="n">spike_train</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span><span class="n">unit_id</span><span class="p">)</span>
                <span class="c1"># Convert to seconds and filter to recording duration</span>
                <span class="n">spike_times</span> <span class="o">=</span> <span class="n">spike_train</span> <span class="o">/</span> <span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">()</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">spike_times</span> <span class="o">&lt;</span> <span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span>
                <span class="n">spike_times</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

                <span class="c1"># Create annotation for each spike</span>
                <span class="n">onset</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
                <span class="n">description</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># collapse all units into 1 spike train</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">Annotations</span><span class="p">(</span><span class="n">onset</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

        <span class="n">info</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">create_info</span><span class="p">(</span><span class="n">ch_names</span><span class="o">=</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">sfreq</span><span class="o">=</span><span class="n">sfreq</span><span class="p">,</span> <span class="n">ch_types</span><span class="o">=</span><span class="s2">&quot;eeg&quot;</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">set_annotations</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">raw</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_sa_to_np</span><span class="p">(</span><span class="n">sa</span><span class="p">:</span> <span class="n">si</span><span class="o">.</span><span class="n">SortingAnalyzer</span><span class="p">,</span> <span class="n">chunk_len</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a SortingAnalyzer to an MNE RawArray.</span>

<span class="sd">        Args:</span>
<span class="sd">            sa (si.SortingAnalyzer): The SortingAnalyzer to convert. Must have only 1 channel.</span>
<span class="sd">            chunk_len (float, optional): The length of the chunks to use for the conversion. Defaults to 60.</span>
<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The converted traces</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check that SortingAnalyzer only has 1 channel</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected SortingAnalyzer to have 1 channel, but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">())</span><span class="si">}</span><span class="s2"> channels&quot;</span>
            <span class="p">)</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">recording</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recording info: </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate total number of frames and chunks</span>
        <span class="n">total_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span> <span class="o">*</span> <span class="n">rec</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">())</span>
        <span class="n">frames_per_chunk</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">chunk_len</span> <span class="o">*</span> <span class="n">rec</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">())</span>
        <span class="n">n_chunks</span> <span class="o">=</span> <span class="n">total_frames</span> <span class="o">//</span> <span class="n">frames_per_chunk</span>

        <span class="n">traces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">total_frames</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_chunks</span><span class="p">):</span>
            <span class="n">start_frame</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="n">frames_per_chunk</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">n_chunks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">end_frame</span> <span class="o">=</span> <span class="n">total_frames</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">frames_per_chunk</span>
            <span class="n">traces</span><span class="p">[</span><span class="n">start_frame</span><span class="p">:</span><span class="n">end_frame</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">get_traces</span><span class="p">(</span>
                <span class="n">start_frame</span><span class="o">=</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="o">=</span><span class="n">end_frame</span><span class="p">,</span> <span class="n">return_scaled</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">traces</span> <span class="o">*=</span> <span class="mf">1e-6</span>  <span class="c1"># convert from uV to V</span>
        <span class="k">return</span> <span class="n">traces</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.SpikeAnalysisResult.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">result_sas</span><span class="p">,</span> <span class="n">result_mne</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">animal_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">genotype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">animal_day</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bin_folder_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channel_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>result</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="spikeinterface.SortingAnalyzer">SortingAnalyzer</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Result comes from AnimalOrganizer.compute_spike_analysis(). Each SortingAnalyzer is a single channel.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>animal_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Identifier for the animal where result was computed from. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>genotype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Genotype of animal. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channel_names</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channel names. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>assume_channels</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If true, assumes channel names according to AnimalFeatureParser.DEFAULT_CHNUM_TO_NAME. Defaults to False.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">result_sas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">si</span><span class="o">.</span><span class="n">SortingAnalyzer</span><span class="p">],</span>
    <span class="n">result_mne</span><span class="p">:</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">animal_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">genotype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">animal_day</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bin_folder_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">DDFBinaryMetadata</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">channel_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">assume_from_number</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        result (list[si.SortingAnalyzer]): Result comes from AnimalOrganizer.compute_spike_analysis(). Each SortingAnalyzer is a single channel.</span>
<span class="sd">        animal_id (str, optional): Identifier for the animal where result was computed from. Defaults to None.</span>
<span class="sd">        genotype (str, optional): Genotype of animal. Defaults to None.</span>
<span class="sd">        channel_names (list[str], optional): List of channel names. Defaults to None.</span>
<span class="sd">        assume_channels (bool, optional): If true, assumes channel names according to AnimalFeatureParser.DEFAULT_CHNUM_TO_NAME. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">result_sas</span> <span class="o">=</span> <span class="n">result_sas</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">result_mne</span> <span class="o">=</span> <span class="n">result_mne</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result_mne</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">result_sas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Exactly one of result_sas or result_mne must be provided&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span> <span class="o">=</span> <span class="n">animal_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span> <span class="o">=</span> <span class="n">genotype</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">animal_day</span> <span class="o">=</span> <span class="n">animal_day</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_name</span> <span class="o">=</span> <span class="n">bin_folder_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="n">channel_names</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span> <span class="o">=</span> <span class="n">assume_from_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">core</span><span class="o">.</span><span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="n">assume_from_number</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span>
    <span class="p">]</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel names: </span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel abbreviations: </span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.SpikeAnalysisResult.convert_sa_to_np" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert_sa_to_np</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">chunk_len</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Convert a SortingAnalyzer to an MNE RawArray.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sa</code>
            </td>
            <td>
                  <code><span title="spikeinterface.SortingAnalyzer">SortingAnalyzer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The SortingAnalyzer to convert. Must have only 1 channel.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_len</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The length of the chunks to use for the conversion. Defaults to 60.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    np.ndarray: The converted traces</p>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_sa_to_np</span><span class="p">(</span><span class="n">sa</span><span class="p">:</span> <span class="n">si</span><span class="o">.</span><span class="n">SortingAnalyzer</span><span class="p">,</span> <span class="n">chunk_len</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a SortingAnalyzer to an MNE RawArray.</span>

<span class="sd">    Args:</span>
<span class="sd">        sa (si.SortingAnalyzer): The SortingAnalyzer to convert. Must have only 1 channel.</span>
<span class="sd">        chunk_len (float, optional): The length of the chunks to use for the conversion. Defaults to 60.</span>
<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: The converted traces</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check that SortingAnalyzer only has 1 channel</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Expected SortingAnalyzer to have 1 channel, but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">())</span><span class="si">}</span><span class="s2"> channels&quot;</span>
        <span class="p">)</span>

    <span class="n">rec</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">recording</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recording info: </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate total number of frames and chunks</span>
    <span class="n">total_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span> <span class="o">*</span> <span class="n">rec</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">())</span>
    <span class="n">frames_per_chunk</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">chunk_len</span> <span class="o">*</span> <span class="n">rec</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">())</span>
    <span class="n">n_chunks</span> <span class="o">=</span> <span class="n">total_frames</span> <span class="o">//</span> <span class="n">frames_per_chunk</span>

    <span class="n">traces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">total_frames</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_chunks</span><span class="p">):</span>
        <span class="n">start_frame</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="n">frames_per_chunk</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">n_chunks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">end_frame</span> <span class="o">=</span> <span class="n">total_frames</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">frames_per_chunk</span>
        <span class="n">traces</span><span class="p">[</span><span class="n">start_frame</span><span class="p">:</span><span class="n">end_frame</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">get_traces</span><span class="p">(</span>
            <span class="n">start_frame</span><span class="o">=</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="o">=</span><span class="n">end_frame</span><span class="p">,</span> <span class="n">return_scaled</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">traces</span> <span class="o">*=</span> <span class="mf">1e-6</span>  <span class="c1"># convert from uV to V</span>
    <span class="k">return</span> <span class="n">traces</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.SpikeAnalysisResult.convert_sas_to_mne" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert_sas_to_mne</span><span class="p">(</span><span class="n">sas</span><span class="p">,</span> <span class="n">chunk_len</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Convert a list of SortingAnalyzers to a MNE RawArray.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sas</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="spikeinterface.SortingAnalyzer">SortingAnalyzer</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of SortingAnalyzers to convert</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_len</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The length of the chunks to use for the conversion. Defaults to 60.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="mne.io.RawArray">RawArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>mne.io.RawArray: The converted RawArray, with spikes labeled as annotations</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_sas_to_mne</span><span class="p">(</span><span class="n">sas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">si</span><span class="o">.</span><span class="n">SortingAnalyzer</span><span class="p">],</span> <span class="n">chunk_len</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a list of SortingAnalyzers to a MNE RawArray.</span>

<span class="sd">    Args:</span>
<span class="sd">        sas (list[si.SortingAnalyzer]): The list of SortingAnalyzers to convert</span>
<span class="sd">        chunk_len (float, optional): The length of the chunks to use for the conversion. Defaults to 60.</span>

<span class="sd">    Returns:</span>
<span class="sd">        mne.io.RawArray: The converted RawArray, with spikes labeled as annotations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Check that all SortingAnalyzers have the same sampling frequency</span>
    <span class="n">sfreqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">()</span> <span class="k">for</span> <span class="n">sa</span> <span class="ow">in</span> <span class="n">sas</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">sf</span> <span class="o">==</span> <span class="n">sfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">sf</span> <span class="ow">in</span> <span class="n">sfreqs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All SortingAnalyzers must have the same sampling frequency. Got frequencies: </span><span class="si">{</span><span class="n">sfreqs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Preallocate data array</span>
    <span class="n">total_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span> <span class="o">*</span> <span class="n">sfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_channels</span><span class="p">,</span> <span class="n">total_frames</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data shape: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Fill data array one channel at a time</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sas</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting channel </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">n_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">SpikeAnalysisResult</span><span class="o">.</span><span class="n">convert_sa_to_np</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">chunk_len</span><span class="p">)</span>

    <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="k">for</span> <span class="n">sa</span> <span class="ow">in</span> <span class="n">sas</span><span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel names: </span><span class="si">{</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sfreq</span> <span class="o">=</span> <span class="n">sfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Extract spike times for each unit and create annotations</span>
    <span class="n">onset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">description</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sa</span> <span class="ow">in</span> <span class="n">sas</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">():</span>
            <span class="n">spike_train</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span><span class="n">unit_id</span><span class="p">)</span>
            <span class="c1"># Convert to seconds and filter to recording duration</span>
            <span class="n">spike_times</span> <span class="o">=</span> <span class="n">spike_train</span> <span class="o">/</span> <span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">()</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">spike_times</span> <span class="o">&lt;</span> <span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span>
            <span class="n">spike_times</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="c1"># Create annotation for each spike</span>
            <span class="n">onset</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
            <span class="n">description</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sa</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># collapse all units into 1 spike train</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">Annotations</span><span class="p">(</span><span class="n">onset</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">create_info</span><span class="p">(</span><span class="n">ch_names</span><span class="o">=</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">sfreq</span><span class="o">=</span><span class="n">sfreq</span><span class="p">,</span> <span class="n">ch_types</span><span class="o">=</span><span class="s2">&quot;eeg&quot;</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">set_annotations</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">raw</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.SpikeAnalysisResult.save_fif_and_json" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_fif_and_json</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">convert_to_mne</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">make_folder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slugify_filebase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_abbrevs_as_chnames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Archive spike analysis result into the folder specified, as a fif and json file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Destination folder to save results to</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>convert_to_mne</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, convert the SortingAnalyzers to a MNE RawArray if self.result_mne is None. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>make_folder</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, create the folder if it doesn't exist. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>slugify_filebase</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, slugify the filebase (replace special characters). Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_abbrevs_as_chnames</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, save the channel abbreviations as the channel names in the json file. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overwrite</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, overwrite the existing files. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_fif_and_json</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">convert_to_mne</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">make_folder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">slugify_filebase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">save_abbrevs_as_chnames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Archive spike analysis result into the folder specified, as a fif and json file.</span>

<span class="sd">    Args:</span>
<span class="sd">        folder (str | Path): Destination folder to save results to</span>
<span class="sd">        convert_to_mne (bool, optional): If True, convert the SortingAnalyzers to a MNE RawArray if self.result_mne is None. Defaults to True.</span>
<span class="sd">        make_folder (bool, optional): If True, create the folder if it doesn&#39;t exist. Defaults to True.</span>
<span class="sd">        slugify_filebase (bool, optional): If True, slugify the filebase (replace special characters). Defaults to True.</span>
<span class="sd">        save_abbrevs_as_chnames (bool, optional): If True, save the channel abbreviations as the channel names in the json file. Defaults to False.</span>
<span class="sd">        overwrite (bool, optional): If True, overwrite the existing files. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_mne</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">convert_to_mne</span><span class="p">:</span>
            <span class="n">result_mne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_mne</span><span class="p">(</span><span class="n">save_raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result_mne</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No SortingAnalyzers found, skipping saving&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No MNE RawArray found, and convert_to_mne is False. Run convert_to_mne() first.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result_mne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_mne</span>

    <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">make_folder</span><span class="p">:</span>
        <span class="n">folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">slugify_filebase</span><span class="p">:</span>
        <span class="n">filebase</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="n">slugify</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_day</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filebase</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_day</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">filebase</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filebase</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filebase</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filebase</span><span class="si">}</span><span class="s2">.json already exists&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filebase</span> <span class="o">+</span> <span class="s2">&quot;.fif&quot;</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.fif&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filebase</span><span class="si">}</span><span class="s2">.fif already exists&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">result_mne</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filebase</span> <span class="o">+</span> <span class="s2">&quot;-raw.fif&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">result_mne</span>

    <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;animal_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
        <span class="s2">&quot;genotype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
        <span class="s2">&quot;animal_day&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">animal_day</span><span class="p">,</span>
        <span class="s2">&quot;bin_folder_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_folder_name</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">,</span>
        <span class="s2">&quot;channel_names&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="k">if</span> <span class="n">save_abbrevs_as_chnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
        <span class="s2">&quot;assume_from_number&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">save_abbrevs_as_chnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filebase</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="neurodent.visualization.results.WindowAnalysisResult" class="doc doc-heading">
            <code>WindowAnalysisResult</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="neurodent.visualization.results.AnimalFeatureParser">AnimalFeatureParser</span></code></p>


        <p>Wrapper for output of windowed analysis. Has useful functions like group-wise and global averaging, filtering, and saving</p>








              <details class="quote">
                <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">WindowAnalysisResult</span><span class="p">(</span><span class="n">AnimalFeatureParser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for output of windowed analysis. Has useful functions like group-wise and global averaging, filtering, and saving</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">animal_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">genotype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">channel_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">assume_from_number</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">bad_channels_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">suppress_short_interval_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">lof_scores_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            result (pd.DataFrame): Result comes from AnimalOrganizer.compute_windowed_analysis()</span>
<span class="sd">            animal_id (str, optional): Identifier for the animal where result was computed from. Defaults to None.</span>
<span class="sd">            genotype (str, optional): Genotype of animal. Defaults to None.</span>
<span class="sd">            channel_names (list[str], optional): List of channel names. Defaults to None.</span>
<span class="sd">            assume_channels (bool, optional): If true, assumes channel names according to AnimalFeatureParser.DEFAULT_CHNUM_TO_NAME. Defaults to False.</span>
<span class="sd">            bad_channels_dict (dict[str, list[str]], optional): Dictionary of channels to reject for each recording session. Defaults to {}.</span>
<span class="sd">            suppress_short_interval_error (bool, optional): If True, suppress ValueError for short intervals between timestamps. Useful for aggregated WARs with large window sizes. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span> <span class="o">=</span> <span class="n">animal_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span> <span class="o">=</span> <span class="n">genotype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="n">channel_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span> <span class="o">=</span> <span class="n">assume_from_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span> <span class="o">=</span> <span class="n">suppress_short_interval_error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span> <span class="o">=</span> <span class="n">lof_scores_dict</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__update_instance_vars</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel names: </span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel abbreviations: </span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__update_instance_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run after updating self.result, or other init values&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Dropping column &#39;index&#39;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>

        <span class="c1"># Check if timestamps are sorted and sort if needed</span>
        <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">is_monotonic_increasing</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Timestamps are not sorted. Sorting result DataFrame by timestamp.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>

        <span class="c1"># Check for unusually short intervals between timestamps</span>
        <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">median_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
            <span class="n">timestamp_diffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
            <span class="n">short_intervals</span> <span class="o">=</span> <span class="n">timestamp_diffs</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">median_duration</span><span class="p">)</span>

            <span class="c1"># Skip first row since diff() produces NaT</span>
            <span class="n">short_intervals</span> <span class="o">=</span> <span class="n">short_intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">short_intervals</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">n_short</span> <span class="o">=</span> <span class="n">short_intervals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">pct_short</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_short</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">short_intervals</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="n">warning_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">n_short</span><span class="si">}</span><span class="s2"> intervals (</span><span class="si">{</span><span class="n">pct_short</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%) between timestamps &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;that are shorter than the median duration of </span><span class="si">{</span><span class="n">median_duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">pct_short</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span><span class="p">:</span>  <span class="c1"># More than 1% of intervals are short</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;animal&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">unique_animals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_animals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple animals found in result: </span><span class="si">{</span><span class="n">unique_animals</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unique_animals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Animal ID mismatch: result has </span><span class="si">{</span><span class="n">unique_animals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, but self.animal_id is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">FEATURES</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nonfeature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">FEATURES</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;animalday&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">core</span><span class="o">.</span><span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reorder_and_pad_channels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">target_channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">use_abbrevs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reorder and pad channels to match a target channel list.</span>

<span class="sd">        This method ensures that the data has a consistent channel order and structure</span>
<span class="sd">        by reordering existing channels and padding missing channels with NaNs.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_channels (list[str]): List of target channel names to match</span>
<span class="sd">            use_abbrevs (bool, optional): If True, target channel names are read as channel abbreviations instead of channel names. Defaults to True.</span>
<span class="sd">            inplace (bool, optional): If True, modify the result in place. Defaults to True.</span>
<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: DataFrame with reordered and padded channels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">target_channels</span> <span class="k">if</span> <span class="n">target_channels</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target channels must be unique. Found duplicates: </span><span class="si">{</span><span class="n">duplicates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">channel_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">ch</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_channels</span><span class="p">)}</span>
        <span class="n">channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">use_abbrevs</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span>

        <span class="n">valid_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_names</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_map</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_channels</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;None of the channel names </span><span class="si">{</span><span class="n">channel_names</span><span class="si">}</span><span class="s2"> were found in target channels </span><span class="si">{</span><span class="n">target_channels</span><span class="si">}</span><span class="s2">. Is use_abbrevs correctly set?&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_columns</span><span class="p">:</span>
            <span class="k">match</span> <span class="n">feature</span><span class="p">:</span>
                <span class="k">case</span><span class="w"> </span><span class="k">_</span> <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">LINEAR_FEATURES</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">BAND_FEATURES</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">BAND_FEATURES</span><span class="p">:</span>
                        <span class="n">df_bands</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bands</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">keys</span> <span class="o">=</span> <span class="n">df_bands</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                    <span class="n">new_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_channels</span><span class="p">),</span> <span class="o">*</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># dubious</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_map</span><span class="p">:</span>
                            <span class="n">new_vals</span><span class="p">[:,</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">ch</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">BAND_FEATURES</span><span class="p">:</span>
                        <span class="n">new_vals</span> <span class="o">=</span> <span class="n">new_vals</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">))</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">]</span>

                <span class="k">case</span><span class="w"> </span><span class="k">_</span> <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">MATRIX_FEATURES</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cohere&quot;</span><span class="p">,</span> <span class="s2">&quot;zcohere&quot;</span><span class="p">,</span> <span class="s2">&quot;imcoh&quot;</span><span class="p">,</span> <span class="s2">&quot;zimcoh&quot;</span><span class="p">]:</span>
                        <span class="n">df_bands</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bands</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">keys</span> <span class="o">=</span> <span class="n">df_bands</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vals.shape: </span><span class="si">{</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">new_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">target_channels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_channels</span><span class="p">)]</span>
                    <span class="n">new_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

                    <span class="c1"># Map original channels to target channels</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">ch1</span> <span class="ow">in</span> <span class="n">channel_map</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ch2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">ch2</span> <span class="ow">in</span> <span class="n">channel_map</span><span class="p">:</span>
                                    <span class="n">new_vals</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">ch1</span><span class="p">],</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">ch2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cohere&quot;</span><span class="p">,</span> <span class="s2">&quot;zcohere&quot;</span><span class="p">,</span> <span class="s2">&quot;imcoh&quot;</span><span class="p">,</span> <span class="s2">&quot;zimcoh&quot;</span><span class="p">]:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">))</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">]</span>

                <span class="k">case</span><span class="w"> </span><span class="k">_</span> <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">HIST_FEATURES</span><span class="p">:</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
                    <span class="n">new_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="o">*</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_channels</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_map</span><span class="p">:</span>
                            <span class="n">new_vals</span><span class="p">[:,</span> <span class="o">...</span><span class="p">,</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">ch</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:,</span> <span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

                    <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">))]</span>

                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid feature: </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Old channel names: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="n">target_channels</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New channel names: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Old channel abbreviations: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__update_instance_vars</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New channel abbreviations: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_sars_spikes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sars</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s2">&quot;SpikeAnalysisResult&quot;</span><span class="p">,</span> <span class="s2">&quot;FrequencyDomainSpikeAnalysisResult&quot;</span><span class="p">]],</span>
        <span class="n">read_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;sa&quot;</span><span class="p">,</span> <span class="s2">&quot;mne&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sa&quot;</span><span class="p">,</span>
        <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrate spike analysis results into WAR by adding nspike/lognspike features.</span>

<span class="sd">        This method extracts spike timing information from spike detection results and bins</span>
<span class="sd">        them according to the WAR&#39;s time windows, adding spike count features to each row.</span>

<span class="sd">        Args:</span>
<span class="sd">            sars: List of SpikeAnalysisResult or FrequencyDomainSpikeAnalysisResult objects.</span>
<span class="sd">                  One result per recording session (animalday).</span>
<span class="sd">            read_mode: Mode for extracting spike data:</span>
<span class="sd">                - &quot;sa&quot;: Read from SortingAnalyzer objects (result_sas attribute)</span>
<span class="sd">                - &quot;mne&quot;: Read from MNE RawArray objects (result_mne attribute)</span>
<span class="sd">            inplace: If True, modifies self.result and returns self.</span>
<span class="sd">                    If False, returns a new WindowAnalysisResult.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: WAR object with added spike features (nspike, lognspike).</span>
<span class="sd">                - If inplace=True: returns self with modified result DataFrame</span>
<span class="sd">                - If inplace=False: returns new WAR object with enhanced result DataFrame</span>

<span class="sd">        Notes:</span>
<span class="sd">            - The number of sars must match the number of unique animaldays in self.result</span>
<span class="sd">            - Spikes are binned into time windows matching the existing WAR fragments</span>
<span class="sd">            - nspike: array of spike counts per channel for each time window</span>
<span class="sd">            - lognspike: log-transformed spike counts using core.log_transform()</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # After computing WAR and spike detection</span>
<span class="sd">            &gt;&gt;&gt; enhanced_war = war.read_sars_spikes(fdsar_list, read_mode=&quot;sa&quot;, inplace=False)</span>
<span class="sd">            &gt;&gt;&gt; enhanced_war.result[&#39;nspike&#39;]  # Spike counts per channel per window</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">match</span> <span class="n">read_mode</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;sa&quot;</span><span class="p">:</span>
                <span class="n">spikes_all</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">sar</span> <span class="ow">in</span> <span class="n">sars</span><span class="p">:</span>  <span class="c1"># for each continuous recording session</span>
                    <span class="n">spikes_channel</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sar</span><span class="o">.</span><span class="n">result_sas</span><span class="p">):</span>  <span class="c1"># for each channel</span>
                        <span class="n">spike_times</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">():</span>  <span class="c1"># Flatten units</span>
                            <span class="n">spike_times</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span><span class="n">unit_id</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">spike_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span> <span class="o">/</span> <span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">()</span>
                        <span class="n">spikes_channel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
                    <span class="n">spikes_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spikes_channel</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_spikes_all</span><span class="p">(</span><span class="n">spikes_all</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
            <span class="k">case</span> <span class="s2">&quot;mne&quot;</span><span class="p">:</span>
                <span class="n">raws</span> <span class="o">=</span> <span class="p">[</span><span class="n">sar</span><span class="o">.</span><span class="n">result_mne</span> <span class="k">for</span> <span class="n">sar</span> <span class="ow">in</span> <span class="n">sars</span><span class="p">]</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mnes_spikes</span><span class="p">(</span><span class="n">raws</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid read_mode: </span><span class="si">{</span><span class="n">read_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_mnes_spikes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raws</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract spike features from MNE RawArray objects with spike annotations.</span>

<span class="sd">        This method extracts spike timing from MNE annotations (where spikes are marked</span>
<span class="sd">        with channel-specific event labels) and bins them into WAR time windows.</span>

<span class="sd">        Args:</span>
<span class="sd">            raws: List of MNE RawArray objects with spike annotations. One per recording</span>
<span class="sd">                  session (animalday). Each should have annotations with channel names</span>
<span class="sd">                  as event labels (e.g., &#39;LMot&#39;, &#39;RMot&#39;, etc.).</span>
<span class="sd">            inplace: If True, modifies self.result and returns self.</span>
<span class="sd">                    If False, returns a new WindowAnalysisResult.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: WAR object with added spike features (nspike, lognspike).</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Expects MNE annotations with channel names as event descriptions</span>
<span class="sd">            - Spike times are extracted from event onsets and binned to WAR windows</span>
<span class="sd">            - Channels not found in annotations will have empty spike arrays</span>
<span class="sd">            - Delegates to _read_from_spikes_all() for the actual binning logic</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # From MNE spike annotations</span>
<span class="sd">            &gt;&gt;&gt; enhanced_war = war.read_mnes_spikes([mne_raw1, mne_raw2], inplace=False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spikes_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">raws</span><span class="p">:</span>
            <span class="c1"># each mne is a contiguous recording session</span>
            <span class="n">events</span><span class="p">,</span> <span class="n">event_id</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">events_from_annotations</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
            <span class="n">event_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">item</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">event_id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="n">spikes_channel</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">ch_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">channel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event_id</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> not found in event_id&quot;</span><span class="p">)</span>
                    <span class="n">spikes_channel</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="k">continue</span>
                <span class="n">event_id_channel</span> <span class="o">=</span> <span class="n">event_id</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>
                <span class="n">spike_times</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">event_id_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">spike_times</span> <span class="o">=</span> <span class="n">spike_times</span> <span class="o">/</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">]</span>
                <span class="n">spikes_channel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
            <span class="n">spikes_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spikes_channel</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_spikes_all</span><span class="p">(</span><span class="n">spikes_all</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_from_spikes_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spikes_all</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method to bin spike times into WAR time windows and add as features.</span>

<span class="sd">        This is the common endpoint for both read_sars_spikes() and read_mnes_spikes().</span>
<span class="sd">        It bins spike times according to the WAR&#39;s time windows and adds nspike/lognspike</span>
<span class="sd">        features to the result DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            spikes_all: Nested list structure of spike times in seconds:</span>
<span class="sd">                - Outer list: recording sessions (one per animalday)</span>
<span class="sd">                - Middle list: channels (one per EEG channel)</span>
<span class="sd">                - Inner list/array: spike times in seconds for that channel</span>
<span class="sd">                Example: [[[0.5, 1.2], [0.8]], [[1.1, 2.3], []]]</span>
<span class="sd">                         = 2 sessions, 2 channels each</span>
<span class="sd">            inplace: If True, modifies self.result and returns self.</span>
<span class="sd">                    If False, returns a new WindowAnalysisResult with enhanced data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: WAR object with spike features added to result DataFrame.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Groups self.result by &#39;animalday&#39; and matches to spikes_all by index</span>
<span class="sd">            - Uses _bin_spike_df() helper to count spikes within each time window</span>
<span class="sd">            - Adds two new columns:</span>
<span class="sd">                - &#39;nspike&#39;: array of spike counts per channel for each window</span>
<span class="sd">                - &#39;lognspike&#39;: log-transformed spike counts via core.log_transform()</span>
<span class="sd">            - Warns if spike count size doesn&#39;t match result DataFrame size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Each groupby animalday is a recording session</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;animalday&quot;</span><span class="p">)</span>
        <span class="n">animaldays</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Animal days: </span><span class="si">{</span><span class="n">animaldays</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">spike_counts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">animaldays</span><span class="p">,</span> <span class="n">spikes_all</span><span class="p">))</span>
        <span class="n">spike_counts</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_bin_spike_df</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spikes_channel</span><span class="o">=</span><span class="n">spike_counts</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
        <span class="n">spike_counts</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">spike_counts</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">spike_counts</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spike counts size </span><span class="si">{</span><span class="n">spike_counts</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> does not match result size </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;nspike&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spike_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;lognspike&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">log_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;nspike&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create a new WindowAnalysisResult</span>
            <span class="n">new_war</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">new_war</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="n">new_war</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a formatted string with basic information about the WindowAnalysisResult object&quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;feature names: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;animaldays: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;animalday&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;animal_id: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;animal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;animal&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;genotype: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;genotype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;genotype&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;channel_names: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">allow_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get windowed analysis result dataframe, with helpful filters</span>

<span class="sd">        Args:</span>
<span class="sd">            features (list[str]): List of features to get from result</span>
<span class="sd">            exclude (list[str], optional): List of features to exclude from result; will override the features parameter. Defaults to [].</span>
<span class="sd">            allow_missing (bool, optional): If True, will return all requested features as columns regardless if they exist in result. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            result: pd.DataFrame object with features in columns and windows in rows</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">_sanitize_feature_request</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_missing</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nonfeature_columns</span> <span class="o">+</span> <span class="n">features</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nonfeature_columns</span> <span class="o">+</span> <span class="n">features</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_groupavg_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;animalday&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Group result and average within groups. Preserves data structure and shape for each feature.</span>

<span class="sd">        Args:</span>
<span class="sd">            features (list[str]): List of features to get from result</span>
<span class="sd">            exclude (list[str], optional): List of features to exclude from result. Will override the features parameter. Defaults to [].</span>
<span class="sd">            df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">            groupby (str, optional): Feature or list of features to group by before averaging. Passed to the `by` parameter in pd.DataFrame.groupby(). Defaults to &quot;animalday&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            grouped_result: result grouped by `groupby` and averaged for each group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result_grouped</span><span class="p">,</span> <span class="n">result_validcols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_groups</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">_sanitize_feature_request</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>

        <span class="n">avg_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">result_validcols</span><span class="p">:</span>
                <span class="n">avg_result_col</span> <span class="o">=</span> <span class="n">result_grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_average_feature</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">avg_result_col</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">f</span>
                <span class="n">avg_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_result_col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> not calculated, skipping&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">avg_results</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__get_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;animalday&quot;</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">_sanitize_feature_request</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>
        <span class="n">result_win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">df</span>
        <span class="k">return</span> <span class="n">result_win</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">),</span> <span class="n">result_win</span><span class="o">.</span><span class="n">columns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grouprows_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multiindex</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">,</span> <span class="s2">&quot;animal&quot;</span><span class="p">,</span> <span class="s2">&quot;genotype&quot;</span><span class="p">],</span>
        <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;endfile&quot;</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">_sanitize_feature_request</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>
        <span class="n">result_win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">df</span>
        <span class="n">result_win</span> <span class="o">=</span> <span class="n">result_win</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">features</span> <span class="o">+</span> <span class="n">multiindex</span> <span class="o">+</span> <span class="n">include</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result_win</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">multiindex</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_filter_logrms_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">z_range</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter windows based on log(rms).</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">            z_range (float, optional): The z-score range to filter by. Values outside this range will be set to NaN.</span>

<span class="sd">        Returns:</span>
<span class="sd">            out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">z_range</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z_range</span><span class="p">)</span>
        <span class="n">np_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">np_logrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np_rms</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">np_rms</span>
        <span class="n">np_logrmsz</span> <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">np_logrms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;omit&quot;</span><span class="p">)</span>
        <span class="n">np_logrms</span><span class="p">[(</span><span class="n">np_logrmsz</span> <span class="o">&gt;</span> <span class="n">z_range</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np_logrmsz</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">z_range</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np_logrms</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[(</span><span class="n">np_logrmsz</span> <span class="o">&gt;</span> <span class="n">z_range</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np_logrmsz</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">z_range</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_filter_high_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_rms</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter windows based on rms.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">            max_rms (float, optional): The maximum rms value to filter by. Values above this will be set to NaN.</span>

<span class="sd">        Returns:</span>
<span class="sd">            out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">np_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">np_rmsnan</span> <span class="o">=</span> <span class="n">np_rms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Convert to float to allow NaN assignment for integer arrays</span>
        <span class="k">if</span> <span class="n">np_rmsnan</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">):</span>  <span class="c1"># integer types</span>
            <span class="n">np_rmsnan</span> <span class="o">=</span> <span class="n">np_rmsnan</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">np_rmsnan</span><span class="p">[</span><span class="n">np_rms</span> <span class="o">&gt;</span> <span class="n">max_rms</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np_rmsnan</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np_rms</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">np_rms</span> <span class="o">&gt;</span> <span class="n">max_rms</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_filter_low_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_rms</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter windows based on rms.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">            min_rms (float, optional): The minimum rms value to filter by. Values below this will be set to NaN.</span>

<span class="sd">        Returns:</span>
<span class="sd">            out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">np_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">np_rmsnan</span> <span class="o">=</span> <span class="n">np_rms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">np_rmsnan</span><span class="p">[</span><span class="n">np_rms</span> <span class="o">&lt;</span> <span class="n">min_rms</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np_rmsnan</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np_rms</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">np_rms</span> <span class="o">&lt;</span> <span class="n">min_rms</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_filter_high_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_beta_prop</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter windows based on beta power.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">            max_beta_prop (float, optional): The maximum beta power to filter by. Values above this will be set to NaN. Defaults to 0.4.</span>

<span class="sd">        Returns:</span>
<span class="sd">            out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;psdfrac&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_psdfrac</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;psdfrac&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">np_prop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_psdfrac</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s2">&quot;psdband&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;psdtotal&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_psdband</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;psdband&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">np_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_psdband</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">np_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;psdtotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">np_prop</span> <span class="o">=</span> <span class="n">np_beta</span> <span class="o">/</span> <span class="n">np_total</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;psdfrac or psdband+psdtotal required for beta power filtering&quot;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np_prop</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">np_prop</span> <span class="o">&gt;</span> <span class="n">max_beta_prop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_filter_reject_channels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bad_channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_abbrevs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_bad_channels</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;union&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;union&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter channels to reject.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">            bad_channels (list[str]): List of channels to reject. Can be either full channel names or abbreviations.</span>
<span class="sd">                The method will automatically detect which format is being used. If None, no filtering is performed.</span>
<span class="sd">            use_abbrevs (bool, optional): Override automatic detection. If True, channels are assumed to be channel abbreviations. If False, channels are assumed to be channel names.</span>
<span class="sd">                If None, channels are parsed to abbreviations and matched against self.channel_abbrevs.</span>
<span class="sd">            save_bad_channels (Literal[&quot;overwrite&quot;, &quot;union&quot;, None], optional): How to save bad channels to self.bad_channels_dict.</span>
<span class="sd">                &quot;overwrite&quot;: Replace self.bad_channels_dict completely with bad channels applied to all sessions.</span>
<span class="sd">                &quot;union&quot;: Merge bad channels with existing self.bad_channels_dict for all sessions.</span>
<span class="sd">                None: Don&#39;t save to self.bad_channels_dict. Defaults to &quot;union&quot;.</span>
<span class="sd">                Note: When using &quot;overwrite&quot; mode, the bad_channels parameter and bad_channels_dict parameter</span>
<span class="sd">                may conflict and overwrite each other&#39;s bad channel definitions if both are provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bad_channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask</span>

        <span class="n">channel_targets</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="k">if</span> <span class="n">use_abbrevs</span> <span class="ow">or</span> <span class="n">use_abbrevs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span>
        <span class="p">)</span>  <span class="c1"># Match to appropriate target</span>
        <span class="k">if</span> <span class="n">use_abbrevs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Match channels as abbreviations</span>
            <span class="n">bad_channels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">core</span><span class="o">.</span><span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bad_channels</span>
            <span class="p">]</span>

        <span class="c1"># Match channels to channel_targets</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bad_channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_targets</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[:,</span> <span class="n">channel_targets</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ch</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">channel_targets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Save bad channels to self.bad_channels_dict if requested</span>
        <span class="k">if</span> <span class="n">save_bad_channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get all unique animal days from the result</span>
            <span class="n">animaldays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

            <span class="c1"># Convert bad channels to the format used in bad_channels_dict (original channel names)</span>
            <span class="n">channels_to_save</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bad_channels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">use_abbrevs</span> <span class="ow">is</span> <span class="kc">False</span>
                <span class="k">else</span> <span class="p">[</span>
                    <span class="n">core</span><span class="o">.</span><span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bad_channels</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">save_bad_channels</span> <span class="o">==</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span>
                <span class="c1"># Replace entire dict with bad channels applied to all sessions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">animalday</span><span class="p">:</span> <span class="n">channels_to_save</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">animalday</span> <span class="ow">in</span> <span class="n">animaldays</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">save_bad_channels</span> <span class="o">==</span> <span class="s2">&quot;union&quot;</span><span class="p">:</span>
                <span class="c1"># Merge with existing bad channels for all sessions</span>
                <span class="n">updated_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">animalday</span> <span class="ow">in</span> <span class="n">animaldays</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">animalday</span> <span class="ow">in</span> <span class="n">updated_dict</span><span class="p">:</span>
                        <span class="c1"># Union of existing and new channels</span>
                        <span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">channels_to_save</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels_to_save</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="n">updated_dict</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_filter_reject_channels_by_recording_session</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bad_channels_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_abbrevs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_bad_channels</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;union&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;union&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter channels to reject for each recording session</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">            bad_channels_dict (dict[str, list[str]]): Dictionary of list of channels to reject for each recording session.</span>
<span class="sd">                Can be either full channel names or abbreviations. The method will automatically detect which format is being used.</span>
<span class="sd">                If None, the method will use the bad_channels_dict passed to the constructor.</span>
<span class="sd">            use_abbrevs (bool, optional): Override automatic detection. If True, channels are assumed to be channel abbreviations. If False, channels are assumed to be channel names.</span>
<span class="sd">                If None, channels are parsed to abbreviations and matched against self.channel_abbrevs.</span>
<span class="sd">            save_bad_channels (Literal[&quot;overwrite&quot;, &quot;union&quot;, None], optional): How to save bad channels to self.bad_channels_dict.</span>
<span class="sd">                &quot;overwrite&quot;: Replace self.bad_channels_dict completely with bad_channels_dict.</span>
<span class="sd">                &quot;union&quot;: Merge bad_channels_dict with existing self.bad_channels_dict per session.</span>
<span class="sd">                None: Don&#39;t save to self.bad_channels_dict. Defaults to &quot;union&quot;.</span>
<span class="sd">                Note: When using &quot;overwrite&quot; mode, the bad_channels parameter and bad_channels_dict parameter</span>
<span class="sd">                may conflict and overwrite each other&#39;s bad channel definitions if both are provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bad_channels_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Group by animalday to apply filters per recording session</span>
        <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;animalday&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bad_channels_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">animalday</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bad_channels_dict</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No bad channels specified for recording session </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">. Check that all days are present in bad_channels_dict&quot;</span>
                    <span class="p">)</span>
                <span class="n">bad_channels</span> <span class="o">=</span> <span class="n">bad_channels_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bad_channels</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">channel_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="k">if</span> <span class="n">use_abbrevs</span> <span class="ow">or</span> <span class="n">use_abbrevs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span>
            <span class="k">if</span> <span class="n">use_abbrevs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bad_channels</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">core</span><span class="o">.</span><span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bad_channels</span>
                <span class="p">]</span>

            <span class="c1"># Get indices for this recording session</span>
            <span class="n">session_indices</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Apply channel filtering for this session</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bad_channels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_targets</span><span class="p">:</span>
                    <span class="n">ch_idx</span> <span class="o">=</span> <span class="n">channel_targets</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">session_indices</span><span class="p">,</span> <span class="n">ch_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">channel_targets</span><span class="si">}</span><span class="s2"> for session </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Save bad channels to self.bad_channels_dict if requested</span>
        <span class="k">if</span> <span class="n">save_bad_channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bad_channels_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">save_bad_channels</span> <span class="o">==</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">save_bad_channels</span> <span class="o">==</span> <span class="s2">&quot;union&quot;</span><span class="p">:</span>
                <span class="c1"># Merge with existing bad channels per session</span>
                <span class="n">updated_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">channels</span> <span class="ow">in</span> <span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">animalday</span> <span class="ow">in</span> <span class="n">updated_dict</span><span class="p">:</span>
                        <span class="c1"># Union of existing and new channels</span>
                        <span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">channels</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="n">updated_dict</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_filter_morphological_smoothing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filter_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">smoothing_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply morphological smoothing to a filter mask.</span>

<span class="sd">        Args:</span>
<span class="sd">            filter_mask (np.ndarray): Input boolean mask of shape (n_windows, n_channels)</span>
<span class="sd">            smoothing_seconds (float): Time window in seconds for morphological operations</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Smoothed boolean mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot calculate window duration - &#39;duration&#39; column missing&quot;</span><span class="p">)</span>

        <span class="n">window_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">structure_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">smoothing_seconds</span> <span class="o">/</span> <span class="n">window_duration</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">structure_size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filter_mask</span>

        <span class="n">smoothed_mask</span> <span class="o">=</span> <span class="n">filter_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">filter_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">filter_mask</span><span class="p">[:,</span> <span class="n">ch_idx</span><span class="p">]</span>
            <span class="c1"># Opening removes small isolated artifacts</span>
            <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">binary_opening</span><span class="p">(</span><span class="n">channel_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">structure_size</span><span class="p">))</span>
            <span class="c1"># Closing fills small gaps in valid data</span>
            <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">binary_closing</span><span class="p">(</span><span class="n">channel_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">structure_size</span><span class="p">))</span>
            <span class="n">smoothed_mask</span><span class="p">[:,</span> <span class="n">ch_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_mask</span>

        <span class="k">return</span> <span class="n">smoothed_mask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_morphological_smoothing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smoothing_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply morphological smoothing to all data.</span>

<span class="sd">        Args:</span>
<span class="sd">            smoothing_seconds (float): Time window in seconds for morphological operations</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: New filtered instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start with all-True mask and smooth it</span>
        <span class="n">base_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">smoothed_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_morphological_smoothing</span><span class="p">(</span><span class="n">base_mask</span><span class="p">,</span> <span class="n">smoothing_seconds</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">smoothed_mask</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># bad_channels: list[str] = None,</span>
        <span class="n">min_valid_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">morphological_smoothing_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># save_bad_channels: Literal[&quot;overwrite&quot;, &quot;union&quot;, None] = &quot;union&quot;,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply a list of filters to the data. Filtering should be performed before aggregation.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">            inplace (bool, optional): If True, modify the result in place. Defaults to True.</span>
<span class="sd">            bad_channels (list[str], optional): List of channels to reject. Defaults to None.</span>
<span class="sd">            min_valid_channels (int, optional): Minimum number of valid channels required per window. Defaults to 3.</span>
<span class="sd">            filters (list[callable], optional): List of filter functions to apply. Each function should return a boolean mask.</span>
<span class="sd">                If None, uses default filters: [get_filter_logrms_range, get_filter_high_rms, get_filter_low_rms, get_filter_high_beta].</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            morphological_smoothing_seconds (float, optional): If provided, apply morphological opening/closing to smooth the filter mask.</span>
<span class="sd">                This removes isolated false positives/negatives along the time axis for each channel independently.</span>
<span class="sd">                The value specifies the time window in seconds for the morphological operations. Defaults to None.</span>
<span class="sd">            save_bad_channels (Literal[&quot;overwrite&quot;, &quot;union&quot;, None], optional): How to save bad channels to self.bad_channels_dict.</span>
<span class="sd">                This parameter is passed to the filtering functions. Defaults to &quot;union&quot;.</span>
<span class="sd">                Note: When using &quot;overwrite&quot; mode, the bad_channels parameter and bad_channels_dict parameter</span>
<span class="sd">                may conflict and overwrite each other&#39;s bad channel definitions if both are provided.</span>
<span class="sd">            **kwargs: Additional keyword arguments to pass to filter functions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: Filtered result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO refactor these into standalone functions, which take in a war as the first parameter, then pass</span>
            <span class="c1"># filt_bool = filt(self, df, **kwargs) as needed</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_logrms_range</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_rms</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_low_rms</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_beta</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels_by_recording_session</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="n">filt_bools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Apply each filter function</span>
        <span class="k">for</span> <span class="n">filter_function</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">filt_bool</span> <span class="o">=</span> <span class="n">filter_function</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">filt_bools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filt_bool</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filter_function</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="s2">filtered </span><span class="si">{</span><span class="n">filt_bool</span><span class="o">.</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">filt_bool</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filt_bool</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Apply all filters</span>
        <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">filt_bools</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filt_bool_all.shape: </span><span class="si">{</span><span class="n">filt_bool_all</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># (windows, channels)</span>

        <span class="c1"># Apply morphological smoothing if requested</span>
        <span class="k">if</span> <span class="n">morphological_smoothing_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot calculate window duration - &#39;duration&#39; column missing from result dataframe&quot;</span><span class="p">)</span>
            <span class="n">window_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

            <span class="c1"># Calculate number of windows for the smoothing</span>
            <span class="n">structure_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">morphological_smoothing_seconds</span> <span class="o">/</span> <span class="n">window_duration</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">structure_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Applying morphological smoothing with </span><span class="si">{</span><span class="n">structure_size</span><span class="si">}</span><span class="s2"> windows (</span><span class="si">{</span><span class="n">morphological_smoothing_seconds</span><span class="si">}</span><span class="s2">s / </span><span class="si">{</span><span class="n">window_duration</span><span class="si">}</span><span class="s2">s per window)&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Apply channel-wise temporal smoothing (each channel processed independently)</span>
                <span class="c1"># This avoids spatial assumptions while smoothing temporal artifacts</span>
                <span class="k">for</span> <span class="n">ch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">filt_bool_all</span><span class="p">[:,</span> <span class="n">ch_idx</span><span class="p">]</span>
                    <span class="c1"># Opening removes small isolated artifacts</span>
                    <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">binary_opening</span><span class="p">(</span><span class="n">channel_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">structure_size</span><span class="p">))</span>
                    <span class="c1"># Closing fills small gaps in valid data</span>
                    <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">binary_closing</span><span class="p">(</span><span class="n">channel_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">structure_size</span><span class="p">))</span>
                    <span class="n">filt_bool_all</span><span class="p">[:,</span> <span class="n">ch_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_mask</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping morphological smoothing - structure size would be 1 (no effect)&quot;</span><span class="p">)</span>

        <span class="c1"># Filter windows based on number of valid channels</span>
        <span class="n">valid_channels_per_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># axis 1 = channel</span>
        <span class="n">window_mask</span> <span class="o">=</span> <span class="n">valid_channels_per_window</span> <span class="o">&gt;=</span> <span class="n">min_valid_channels</span>  <span class="c1"># True if window has enough valid channels</span>
        <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="n">filt_bool_all</span> <span class="o">&amp;</span> <span class="n">window_mask</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Apply window mask to all channels</span>

        <span class="n">filtered_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">filtered_result</span>
        <span class="k">return</span> <span class="n">WindowAnalysisResult</span><span class="p">(</span>
            <span class="n">filtered_result</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_filtered_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new WindowAnalysisResult with the filter applied.</span>

<span class="sd">        Args:</span>
<span class="sd">            filter_mask (np.ndarray): Boolean mask of shape (n_windows, n_channels)</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: New instance with filter applied</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filtered_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter</span><span class="p">(</span><span class="n">filter_mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">WindowAnalysisResult</span><span class="p">(</span>
            <span class="n">filtered_result</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_logrms_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_range</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter based on log(rms) z-score range.</span>

<span class="sd">        Args:</span>
<span class="sd">            z_range (float): Z-score range threshold. Defaults to 3.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: New filtered instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_logrms_range</span><span class="p">(</span><span class="n">z_range</span><span class="o">=</span><span class="n">z_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_high_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_rms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter out windows with RMS above threshold.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_rms (float): Maximum RMS threshold. Defaults to 500.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: New filtered instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_rms</span><span class="p">(</span><span class="n">max_rms</span><span class="o">=</span><span class="n">max_rms</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_low_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_rms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter out windows with RMS below threshold.</span>

<span class="sd">        Args:</span>
<span class="sd">            min_rms (float): Minimum RMS threshold. Defaults to 50.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: New filtered instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_low_rms</span><span class="p">(</span><span class="n">min_rms</span><span class="o">=</span><span class="n">min_rms</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_high_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_beta_prop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter out windows with high beta power.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_beta_prop (float): Maximum beta power proportion. Defaults to 0.4.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: New filtered instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_beta</span><span class="p">(</span><span class="n">max_beta_prop</span><span class="o">=</span><span class="n">max_beta_prop</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_reject_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bad_channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">use_abbrevs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter out specified bad channels.</span>

<span class="sd">        Args:</span>
<span class="sd">            bad_channels (list[str]): List of channel names to reject</span>
<span class="sd">            use_abbrevs (bool, optional): Whether to use abbreviations. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: New filtered instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels</span><span class="p">(</span><span class="n">bad_channels</span><span class="o">=</span><span class="n">bad_channels</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="n">use_abbrevs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_reject_channels_by_session</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">bad_channels_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter out bad channels by recording session.</span>

<span class="sd">        Args:</span>
<span class="sd">            bad_channels_dict (dict[str, list[str]], optional): Dictionary mapping recording session</span>
<span class="sd">                identifiers to lists of bad channel names to reject. Session identifiers are in the</span>
<span class="sd">                format &quot;{animal_id} {genotype} {day}&quot; (e.g., &quot;A10 WT Apr-01-2023&quot;). Channel names</span>
<span class="sd">                can be either full names (e.g., &quot;Left Auditory&quot;) or abbreviations (e.g., &quot;LAud&quot;).</span>
<span class="sd">                If None, uses the bad_channels_dict from the constructor. Defaults to None.</span>
<span class="sd">            use_abbrevs (bool, optional): Override automatic channel name format detection. If True,</span>
<span class="sd">                channels are assumed to be abbreviations. If False, channels are assumed to be full</span>
<span class="sd">                names. If None, automatically detects format and converts to abbreviations for matching.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: New filtered instance with bad channels masked as NaN for their</span>
<span class="sd">                respective recording sessions</span>

<span class="sd">        Examples:</span>
<span class="sd">            Filter specific channels per session using abbreviations:</span>
<span class="sd">            &gt;&gt;&gt; bad_channels = {</span>
<span class="sd">            ...     &quot;A10 WT Apr-01-2023&quot;: [&quot;LAud&quot;, &quot;RMot&quot;],  # Session 1: reject left auditory, right motor</span>
<span class="sd">            ...     &quot;A10 WT Apr-02-2023&quot;: [&quot;LVis&quot;]           # Session 2: reject left visual only</span>
<span class="sd">            ... }</span>
<span class="sd">            &gt;&gt;&gt; filtered_war = war.filter_reject_channels_by_session(bad_channels, use_abbrevs=True)</span>

<span class="sd">            Filter using full channel names:</span>
<span class="sd">            &gt;&gt;&gt; bad_channels = {</span>
<span class="sd">            ...     &quot;A12 KO May-15-2023&quot;: [&quot;Left Motor&quot;, &quot;Right Barrel&quot;],</span>
<span class="sd">            ...     &quot;A12 KO May-16-2023&quot;: [&quot;Left Auditory&quot;, &quot;Left Visual&quot;, &quot;Right Motor&quot;]</span>
<span class="sd">            ... }</span>
<span class="sd">            &gt;&gt;&gt; filtered_war = war.filter_reject_channels_by_session(bad_channels, use_abbrevs=False)</span>

<span class="sd">            Auto-detect channel format (recommended):</span>
<span class="sd">            &gt;&gt;&gt; bad_channels = {</span>
<span class="sd">            ...     &quot;A15 WT Jun-10-2023&quot;: [&quot;LMot&quot;, &quot;RBar&quot;],  # Will auto-detect as abbreviations</span>
<span class="sd">            ...     &quot;A15 WT Jun-11-2023&quot;: [&quot;LAud&quot;]</span>
<span class="sd">            ... }</span>
<span class="sd">            &gt;&gt;&gt; filtered_war = war.filter_reject_channels_by_session(bad_channels)</span>

<span class="sd">        Note:</span>
<span class="sd">            - Session identifiers must exactly match the &quot;animalday&quot; values in the result DataFrame</span>
<span class="sd">            - Available channel abbreviations: LAud, RAud, LVis, RVis, LHip, RHip, LBar, RBar, LMot, RMot</span>
<span class="sd">            - Channel names are case-insensitive and support various formats (e.g., &quot;left aud&quot;, &quot;Left Auditory&quot;)</span>
<span class="sd">            - If a session identifier is not found in bad_channels_dict, a warning is logged but processing continues</span>
<span class="sd">            - If a channel name is not recognized, a warning is logged but other channels are still processed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels_by_recording_session</span><span class="p">(</span>
            <span class="n">bad_channels_dict</span><span class="o">=</span><span class="n">bad_channels_dict</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="n">use_abbrevs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_filters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filter_config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_valid_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">morphological_smoothing_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply multiple filters using configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            filter_config (dict, optional): Dictionary of filter names and parameters.</span>
<span class="sd">                Available filters: &#39;logrms_range&#39;, &#39;high_rms&#39;, &#39;low_rms&#39;, &#39;high_beta&#39;,</span>
<span class="sd">                &#39;reject_channels&#39;, &#39;reject_channels_by_session&#39;, &#39;morphological_smoothing&#39;</span>
<span class="sd">            min_valid_channels (int): Minimum valid channels per window. Defaults to 3.</span>
<span class="sd">            morphological_smoothing_seconds (float, optional): Temporal smoothing window (deprecated, use config instead)</span>

<span class="sd">        Returns:</span>
<span class="sd">            WindowAnalysisResult: New filtered instance</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; config = {</span>
<span class="sd">            ...     &#39;logrms_range&#39;: {&#39;z_range&#39;: 3},</span>
<span class="sd">            ...     &#39;high_rms&#39;: {&#39;max_rms&#39;: 500},</span>
<span class="sd">            ...     &#39;reject_channels&#39;: {&#39;bad_channels&#39;: [&#39;LMot&#39;, &#39;RMot&#39;]},</span>
<span class="sd">            ...     &#39;morphological_smoothing&#39;: {&#39;smoothing_seconds&#39;: 8.0}</span>
<span class="sd">            ... }</span>
<span class="sd">            &gt;&gt;&gt; filtered_war = war.apply_filters(config)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filter_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filter_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;logrms_range&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;z_range&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                <span class="s2">&quot;high_rms&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_rms&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span>
                <span class="s2">&quot;low_rms&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min_rms&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
                <span class="s2">&quot;high_beta&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_beta_prop&quot;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">},</span>
                <span class="s2">&quot;reject_channels_by_session&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">}</span>

        <span class="n">filter_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;logrms_range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_logrms_range</span><span class="p">,</span>
            <span class="s2">&quot;high_rms&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_rms</span><span class="p">,</span>
            <span class="s2">&quot;low_rms&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_low_rms</span><span class="p">,</span>
            <span class="s2">&quot;high_beta&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_beta</span><span class="p">,</span>
            <span class="s2">&quot;reject_channels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels</span><span class="p">,</span>
            <span class="s2">&quot;reject_channels_by_session&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels_by_recording_session</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">filt_bools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">morphological_params</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">filter_params</span> <span class="ow">in</span> <span class="n">filter_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">filter_name</span> <span class="o">==</span> <span class="s2">&quot;morphological_smoothing&quot;</span><span class="p">:</span>
                <span class="n">morphological_params</span> <span class="o">=</span> <span class="n">filter_params</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">filter_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filter_methods</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unknown filter: </span><span class="si">{</span><span class="n">filter_name</span><span class="si">}</span><span class="s2">. Available: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">filter_methods</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;morphological_smoothing&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">filter_func</span> <span class="o">=</span> <span class="n">filter_methods</span><span class="p">[</span><span class="n">filter_name</span><span class="p">]</span>
            <span class="n">filt_bool</span> <span class="o">=</span> <span class="n">filter_func</span><span class="p">(</span><span class="o">**</span><span class="n">filter_params</span><span class="p">)</span>
            <span class="n">filt_bools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filt_bool</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filter_name</span><span class="si">}</span><span class="s2">: filtered </span><span class="si">{</span><span class="n">filt_bool</span><span class="o">.</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">filt_bool</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filt_bool</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Combine all filter masks</span>
        <span class="k">if</span> <span class="n">filt_bools</span><span class="p">:</span>
            <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">filt_bools</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Apply morphological smoothing if requested (either from config or parameter)</span>
        <span class="k">if</span> <span class="n">morphological_params</span> <span class="ow">or</span> <span class="n">morphological_smoothing_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">morphological_params</span><span class="p">:</span>
                <span class="n">smoothing_seconds</span> <span class="o">=</span> <span class="n">morphological_params</span><span class="p">[</span><span class="s2">&quot;smoothing_seconds&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">smoothing_seconds</span> <span class="o">=</span> <span class="n">morphological_smoothing_seconds</span>

            <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_morphological_smoothing</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="p">,</span> <span class="n">smoothing_seconds</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied morphological smoothing: </span><span class="si">{</span><span class="n">smoothing_seconds</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

        <span class="c1"># Filter windows based on minimum valid channels</span>
        <span class="n">valid_channels_per_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">window_mask</span> <span class="o">=</span> <span class="n">valid_channels_per_window</span> <span class="o">&gt;=</span> <span class="n">min_valid_channels</span>
        <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="n">filt_bool_all</span> <span class="o">&amp;</span> <span class="n">window_mask</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_tfs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">filter_tfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filter_tfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>  <span class="c1"># (M fragments, N channels)</span>
        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">FEATURES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> because it is not in result&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">match</span> <span class="n">feat</span><span class="p">:</span>  <span class="c1"># NOTE refactor this to use constants</span>
                <span class="k">case</span> <span class="s2">&quot;rms&quot;</span> <span class="o">|</span> <span class="s2">&quot;ampvar&quot;</span> <span class="o">|</span> <span class="s2">&quot;psdtotal&quot;</span> <span class="o">|</span> <span class="s2">&quot;nspike&quot;</span> <span class="o">|</span> <span class="s2">&quot;logrms&quot;</span> <span class="o">|</span> <span class="s2">&quot;logampvar&quot;</span> <span class="o">|</span> <span class="s2">&quot;logpsdtotal&quot;</span> <span class="o">|</span> <span class="s2">&quot;lognspike&quot;</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="c1"># Convert to float to allow NaN assignment for integer features</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">):</span>  <span class="c1"># integer types</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">vals</span><span class="p">[</span><span class="o">~</span><span class="n">filter_tfs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">case</span> <span class="s2">&quot;psd&quot;</span><span class="p">:</span>
                    <span class="c1"># FIXME The sampling rates have changed between computation passes so WARs have different shapes.</span>
                    <span class="c1"># Add a check for same sampling frequency, other war-relevant properties etc.</span>
                    <span class="c1"># The logging lines below should be removed at some point, but I&#39;ll keep it this way for now</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;set([x[0].shape for x in result[feat].tolist()]) = </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]))</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;set([x[1].shape for x in result[feat].tolist()]) = </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]))</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">filter_tfs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">vals</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">outs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">)]</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">=</span> <span class="n">outs</span>
                <span class="k">case</span> <span class="s2">&quot;psdband&quot;</span> <span class="o">|</span> <span class="s2">&quot;psdfrac&quot;</span> <span class="o">|</span> <span class="s2">&quot;logpsdband&quot;</span> <span class="o">|</span> <span class="s2">&quot;logpsdfrac&quot;</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">v</span><span class="p">[</span><span class="o">~</span><span class="n">filter_tfs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">vals</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
                <span class="k">case</span> <span class="s2">&quot;psdslope&quot;</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">filter_tfs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">vals</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="c1"># vals = [list(map(tuple, x)) for x in vals.tolist()]</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">case</span> <span class="s2">&quot;cohere&quot;</span> <span class="o">|</span> <span class="s2">&quot;zcohere&quot;</span> <span class="o">|</span> <span class="s2">&quot;imcoh&quot;</span> <span class="o">|</span> <span class="s2">&quot;zimcoh&quot;</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">filter_tfs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">shape</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="n">v</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">v</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">vals</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
                <span class="k">case</span> <span class="s2">&quot;pcorr&quot;</span> <span class="o">|</span> <span class="s2">&quot;zpcorr&quot;</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">filter_tfs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">vals</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">vals</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown feature to filter </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_pickle_and_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">make_folder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slugify_filename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save_abbrevs_as_chnames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Archive window analysis result into the folder specified, as a pickle and json file.</span>

<span class="sd">        Args:</span>
<span class="sd">            folder (str | Path): Destination folder to save results to</span>
<span class="sd">            make_folder (bool, optional): If True, create the folder if it doesn&#39;t exist. Defaults to True.</span>
<span class="sd">            filename (str, optional): Name of the file to save. Defaults to &quot;war&quot;.</span>
<span class="sd">            slugify_filename (bool, optional): If True, slugify the filename (replace special characters). Defaults to False.</span>
<span class="sd">            save_abbrevs_as_chnames (bool, optional): If True, save the channel abbreviations as the channel names in the json file. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">make_folder</span><span class="p">:</span>
            <span class="n">folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;war&quot;</span> <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">filename</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">if</span> <span class="n">slugify_filename</span> <span class="k">else</span> <span class="n">filename</span>

        <span class="n">filepath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved WAR to </span><span class="si">{</span><span class="n">filepath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.pkl&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;animal_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
            <span class="s2">&quot;genotype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
            <span class="s2">&quot;channel_names&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="k">if</span> <span class="n">save_abbrevs_as_chnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
            <span class="s2">&quot;assume_from_number&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">save_abbrevs_as_chnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
            <span class="s2">&quot;bad_channels_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="p">,</span>
            <span class="s2">&quot;suppress_short_interval_error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span><span class="p">,</span>
            <span class="s2">&quot;lof_scores_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved WAR to </span><span class="si">{</span><span class="n">filepath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.json&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_bad_channels_by_lof_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lof_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply LOF threshold directly to stored scores to get bad channels.</span>

<span class="sd">        Args:</span>
<span class="sd">            lof_threshold (float): Threshold for determining bad channels.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary mapping animal days to lists of bad channel names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lof_scores_dict&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LOF scores not available in this WAR. Compute LOF scores first.&quot;</span><span class="p">)</span>

        <span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lof_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;lof_scores&quot;</span> <span class="ow">in</span> <span class="n">lof_data</span> <span class="ow">and</span> <span class="s2">&quot;channel_names&quot;</span> <span class="ow">in</span> <span class="n">lof_data</span><span class="p">:</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;lof_scores&quot;</span><span class="p">])</span>
                <span class="n">channel_names</span> <span class="o">=</span> <span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;channel_names&quot;</span><span class="p">]</span>

                <span class="n">is_inlier</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&lt;</span> <span class="n">lof_threshold</span>
                <span class="n">bad_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">is_inlier</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">bad_channels_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="n">bad_channels</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOF scores not available for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bad_channels_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_lof_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get LOF scores from this WAR.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary mapping animal days to LOF score dictionaries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lof_scores_dict&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LOF scores not available in this WAR. Compute LOF scores first.&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lof_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;lof_scores&quot;</span> <span class="ow">in</span> <span class="n">lof_data</span> <span class="ow">and</span> <span class="s2">&quot;channel_names&quot;</span> <span class="ow">in</span> <span class="n">lof_data</span><span class="p">:</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;lof_scores&quot;</span><span class="p">]</span>
                <span class="n">channel_names</span> <span class="o">=</span> <span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;channel_names&quot;</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">scores</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOF scores not available for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_lof_threshold_binary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ground_truth_bad_channels</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">evaluation_channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate single threshold against ground truth for binary classification.</span>

<span class="sd">        Args:</span>
<span class="sd">            ground_truth_bad_channels: Dict mapping animal-day to bad channel sets.</span>
<span class="sd">                                     If None, uses self.bad_channels_dict as ground truth.</span>
<span class="sd">            threshold: LOF threshold to test</span>
<span class="sd">            evaluation_channels: Subset of channels to include in evaluation. If none, uses all channels.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (y_true_list, y_pred_list) for sklearn.metrics.f1_score</span>
<span class="sd">                   Each element represents one channel from one animal-day</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lof_scores_dict&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LOF scores not available in this WAR. Run compute_bad_channels() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;threshold parameter is required&quot;</span><span class="p">)</span>

        <span class="c1"># Use self.bad_channels_dict as default ground truth</span>
        <span class="k">if</span> <span class="n">ground_truth_bad_channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;bad_channels_dict&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="p">:</span>
                <span class="n">ground_truth_bad_channels</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># Filter bad_channels_dict to only include keys that exist in lof_scores_dict</span>
                <span class="n">lof_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">bad_channels_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="n">missing_keys</span> <span class="o">=</span> <span class="n">bad_channels_keys</span> <span class="o">-</span> <span class="n">lof_keys</span>
                <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;bad_channels_dict contains keys not found in lof_scores_dict: </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Available LOF keys: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">lof_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Only use bad channel keys that have corresponding LOF data</span>
                <span class="n">ground_truth_bad_channels</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lof_keys</span>
                <span class="p">}</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Using filtered bad_channels_dict as ground truth with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ground_truth_bad_channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> animal-day sessions&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No ground truth provided and self.bad_channels_dict is empty.&quot;</span><span class="p">)</span>

        <span class="c1"># Get all channels if no subset specified</span>
        <span class="k">if</span> <span class="n">evaluation_channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">evaluation_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span>

        <span class="n">y_true_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_pred_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Debug: Log what we&#39;re working with</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;evaluate_lof_threshold_binary: evaluation_channels = </span><span class="si">{</span><span class="n">evaluation_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;evaluate_lof_threshold_binary: ground_truth_bad_channels keys = </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ground_truth_bad_channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;evaluate_lof_threshold_binary: lof_scores_dict keys = </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Iterate through each animal-day and evaluate channels</span>
        <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lof_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;lof_scores&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lof_data</span> <span class="ow">or</span> <span class="s2">&quot;channel_names&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lof_data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid LOF data for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: missing required fields &#39;lof_scores&#39; or &#39;channel_names&#39;&quot;</span>
                <span class="p">)</span>

            <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;lof_scores&quot;</span><span class="p">])</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;channel_names&quot;</span><span class="p">]</span>

            <span class="c1"># Get ground truth bad channels for this animal-day</span>
            <span class="n">animalday_bad_channels</span> <span class="o">=</span> <span class="n">ground_truth_bad_channels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">animalday</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

            <span class="c1"># Debug: Log details for this animal-day</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: channel_names = </span><span class="si">{</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: animalday_bad_channels = </span><span class="si">{</span><span class="n">animalday_bad_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: scores shape = </span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Evaluate each channel in the evaluation subset</span>
            <span class="n">channels_processed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">channel</span> <span class="ow">in</span> <span class="n">evaluation_channels</span>
                    <span class="ow">or</span> <span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">strict_matching</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">in</span> <span class="n">evaluation_channels</span>
                <span class="p">):</span>
                    <span class="n">channels_processed</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Ground truth: 1 if channel is marked as bad, 0 otherwise</span>
                    <span class="n">is_bad_channel</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">channel</span> <span class="ow">in</span> <span class="n">animalday_bad_channels</span>
                        <span class="ow">or</span> <span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">strict_matching</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">in</span> <span class="n">animalday_bad_channels</span>
                    <span class="p">)</span>
                    <span class="c1"># if is_bad_channel and channel not in animalday_bad_channels:</span>
                    <span class="c1">#     logging.debug(f&quot;Mapped full channel &#39;{channel}&#39; -&gt; &#39;{parse_chname_to_abbrev(channel, strict_matching=False)}&#39; found in bad channels&quot;)</span>

                    <span class="n">y_true</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">is_bad_channel</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="c1"># Prediction: 1 if LOF score &gt; threshold, 0 otherwise</span>
                    <span class="n">y_pred</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="mi">0</span>

                    <span class="n">y_true_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
                    <span class="n">y_pred_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">: y_true=</span><span class="si">{</span><span class="n">y_true</span><span class="si">}</span><span class="s2">, y_pred=</span><span class="si">{</span><span class="n">y_pred</span><span class="si">}</span><span class="s2"> (score=</span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, threshold=</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>

                    <span class="c1"># Extra debugging for the alignment issue</span>
                    <span class="k">if</span> <span class="n">y_true</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;TRUE POSITIVE CANDIDATE: </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> mapped to bad channel in: </span><span class="si">{</span><span class="n">animalday_bad_channels</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">y_pred</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOF PREDICTION: </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> has score </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> &gt; threshold </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">channels_processed</span><span class="si">}</span><span class="s2"> channels for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">y_true_list</span><span class="p">,</span> <span class="n">y_pred_list</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_pickle_and_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pickle_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load WindowAnalysisResult from folder</span>

<span class="sd">        Args:</span>
<span class="sd">            folder_path (str, optional): Path of folder containing .pkl and .json files. Defaults to None.</span>
<span class="sd">            pickle_name (str, optional): Name of the pickle file. Can be just the filename (e.g. &quot;war.pkl&quot;)</span>
<span class="sd">                or a path relative to folder_path (e.g. &quot;subdir/war.pkl&quot;). If None and folder_path is provided,</span>
<span class="sd">                expects exactly one .pkl file in folder_path. Defaults to None.</span>
<span class="sd">            json_name (str, optional): Name of the JSON file. Can be just the filename (e.g. &quot;war.json&quot;)</span>
<span class="sd">                or a path relative to folder_path (e.g. &quot;subdir/war.json&quot;). If None and folder_path is provided,</span>
<span class="sd">                expects exactly one .json file in folder_path. Defaults to None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: folder_path does not exist</span>
<span class="sd">            ValueError: Expected exactly one pickle and one json file in folder_path (when pickle_name/json_name not specified)</span>
<span class="sd">            FileNotFoundError: Specified pickle_name or json_name not found</span>

<span class="sd">        Returns:</span>
<span class="sd">            result: WindowAnalysisResult object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">folder_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder path </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pickle_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Handle pickle_name as either absolute path or relative to folder_path</span>
                <span class="n">pickle_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">pickle_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pickle_path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                    <span class="n">df_pickle_path</span> <span class="o">=</span> <span class="n">pickle_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df_pickle_path</span> <span class="o">=</span> <span class="n">folder_path</span> <span class="o">/</span> <span class="n">pickle_name</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">df_pickle_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pickle file not found: </span><span class="si">{</span><span class="n">df_pickle_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pkl_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">folder_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.pkl&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkl_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected exactly one pickle file in </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pkl_files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">df_pickle_path</span> <span class="o">=</span> <span class="n">pkl_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">json_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Handle json_name as either absolute path or relative to folder_path</span>
                <span class="n">json_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">json_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">json_path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                    <span class="n">json_path</span> <span class="o">=</span> <span class="n">json_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">json_path</span> <span class="o">=</span> <span class="n">folder_path</span> <span class="o">/</span> <span class="n">json_name</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON file not found: </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">json_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">folder_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected exactly one json file in </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">json_files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">json_path</span> <span class="o">=</span> <span class="n">json_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pickle_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">json_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Either folder_path must be provided, or both pickle_name and json_name must be provided as absolute paths&quot;</span>
                <span class="p">)</span>

            <span class="n">df_pickle_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">pickle_name</span><span class="p">)</span>
            <span class="n">json_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">json_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">df_pickle_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pickle file not found: </span><span class="si">{</span><span class="n">df_pickle_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON file not found: </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">df_pickle_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_time_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupby</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">,</span> <span class="s2">&quot;isday&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate time windows into a single data point per groupby by averaging features. This reduces the number of rows in the result.</span>

<span class="sd">        Args:</span>
<span class="sd">            groupby (list[str] | str, optional): Columns to group by. Defaults to [&#39;animalday&#39;, &#39;isday&#39;], which groups by animalday (recording session) and isday (day/night).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: groupby must be from [&#39;animalday&#39;, &#39;isday&#39;]</span>
<span class="sd">            ValueError: Columns in groupby not found in result</span>
<span class="sd">            ValueError: Columns in groupby are not constant in groups</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupby</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">,</span> <span class="s2">&quot;isday&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;groupby must be from [&#39;animalday&#39;, &#39;isday&#39;]. Got </span><span class="si">{</span><span class="n">groupby</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns </span><span class="si">{</span><span class="n">groupby</span><span class="si">}</span><span class="s2"> not found in result. Columns: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">FEATURES</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggregating </span><span class="si">{</span><span class="n">features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result_grouped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span>

        <span class="n">agg_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s2">&quot;animalday&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
            <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;isday&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
            <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;isday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="kc">None</span>

        <span class="n">constant_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;genotype&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">constant_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">is_constant</span> <span class="o">=</span> <span class="n">result_grouped</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_constant</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">non_constant_groups</span> <span class="o">=</span> <span class="n">is_constant</span><span class="p">[</span><span class="o">~</span><span class="n">is_constant</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> is not constant in groups: </span><span class="si">{</span><span class="n">non_constant_groups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">agg_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s2">&quot;endfile&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;endfile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;endfile&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="n">agg_dict</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">,</span> <span class="n">feat</span><span class="o">=</span><span class="n">feat</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_average_feature</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">)</span>

        <span class="n">aggregated_df</span> <span class="o">=</span> <span class="n">result_grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="n">agg_dict</span><span class="p">[</span><span class="n">col</span><span class="p">](</span><span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">})</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">aggregated_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Keep animalday/isday as a column</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting suppress_short_interval_error to True&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_instance_vars</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_unique_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a hex hash to the animal ID to ensure uniqueness. This prevents collisions when, for example, multiple animals in ExperimentPlotter have the same animal ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            nbytes (int, optional): Number of bytes to generate. This is passed directly to secrets.token_hex(). Defaults to None, which generates 16 hex characters (8 bytes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>

        <span class="n">hash_suffix</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="n">nbytes</span><span class="p">)</span>
        <span class="n">new_animal_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">hash_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;animal&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_animal_id</span>
        <span class="k">if</span> <span class="s2">&quot;animalday&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span> <span class="n">new_animal_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span> <span class="o">=</span> <span class="n">new_animal_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__update_instance_vars</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">animal_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">genotype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channel_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bad_channels_dict</span><span class="o">=</span><span class="p">{},</span> <span class="n">suppress_short_interval_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lof_scores_dict</span><span class="o">=</span><span class="p">{})</span></code>

</h3>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>result</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Result comes from AnimalOrganizer.compute_windowed_analysis()</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>animal_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Identifier for the animal where result was computed from. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>genotype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Genotype of animal. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channel_names</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channel names. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>assume_channels</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If true, assumes channel names according to AnimalFeatureParser.DEFAULT_CHNUM_TO_NAME. Defaults to False.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bad_channels_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of channels to reject for each recording session. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suppress_short_interval_error</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, suppress ValueError for short intervals between timestamps. Useful for aggregated WARs with large window sizes. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">animal_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">genotype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">channel_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">assume_from_number</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bad_channels_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">suppress_short_interval_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">lof_scores_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        result (pd.DataFrame): Result comes from AnimalOrganizer.compute_windowed_analysis()</span>
<span class="sd">        animal_id (str, optional): Identifier for the animal where result was computed from. Defaults to None.</span>
<span class="sd">        genotype (str, optional): Genotype of animal. Defaults to None.</span>
<span class="sd">        channel_names (list[str], optional): List of channel names. Defaults to None.</span>
<span class="sd">        assume_channels (bool, optional): If true, assumes channel names according to AnimalFeatureParser.DEFAULT_CHNUM_TO_NAME. Defaults to False.</span>
<span class="sd">        bad_channels_dict (dict[str, list[str]], optional): Dictionary of channels to reject for each recording session. Defaults to {}.</span>
<span class="sd">        suppress_short_interval_error (bool, optional): If True, suppress ValueError for short intervals between timestamps. Useful for aggregated WARs with large window sizes. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span> <span class="o">=</span> <span class="n">animal_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span> <span class="o">=</span> <span class="n">genotype</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="n">channel_names</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span> <span class="o">=</span> <span class="n">assume_from_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span> <span class="o">=</span> <span class="n">suppress_short_interval_error</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span> <span class="o">=</span> <span class="n">lof_scores_dict</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__update_instance_vars</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel names: </span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel abbreviations: </span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.__update_instance_vars" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__update_instance_vars</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run after updating self.result, or other init values</p>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__update_instance_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run after updating self.result, or other init values&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Dropping column &#39;index&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>

    <span class="c1"># Check if timestamps are sorted and sort if needed</span>
    <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">is_monotonic_increasing</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Timestamps are not sorted. Sorting result DataFrame by timestamp.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>

    <span class="c1"># Check for unusually short intervals between timestamps</span>
    <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">median_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">timestamp_diffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">short_intervals</span> <span class="o">=</span> <span class="n">timestamp_diffs</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">median_duration</span><span class="p">)</span>

        <span class="c1"># Skip first row since diff() produces NaT</span>
        <span class="n">short_intervals</span> <span class="o">=</span> <span class="n">short_intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">short_intervals</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">n_short</span> <span class="o">=</span> <span class="n">short_intervals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">pct_short</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_short</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">short_intervals</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

            <span class="n">warning_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">n_short</span><span class="si">}</span><span class="s2"> intervals (</span><span class="si">{</span><span class="n">pct_short</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%) between timestamps &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;that are shorter than the median duration of </span><span class="si">{</span><span class="n">median_duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">pct_short</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span><span class="p">:</span>  <span class="c1"># More than 1% of intervals are short</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;animal&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">unique_animals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_animals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple animals found in result: </span><span class="si">{</span><span class="n">unique_animals</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unique_animals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Animal ID mismatch: result has </span><span class="si">{</span><span class="n">unique_animals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, but self.animal_id is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">FEATURES</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_nonfeature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">FEATURES</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">animaldays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;animalday&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">core</span><span class="o">.</span><span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.add_unique_hash" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_unique_hash</span><span class="p">(</span><span class="n">nbytes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Adds a hex hash to the animal ID to ensure uniqueness. This prevents collisions when, for example, multiple animals in ExperimentPlotter have the same animal ID.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>nbytes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bytes to generate. This is passed directly to secrets.token_hex(). Defaults to None, which generates 16 hex characters (8 bytes).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_unique_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a hex hash to the animal ID to ensure uniqueness. This prevents collisions when, for example, multiple animals in ExperimentPlotter have the same animal ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        nbytes (int, optional): Number of bytes to generate. This is passed directly to secrets.token_hex(). Defaults to None, which generates 16 hex characters (8 bytes).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>

    <span class="n">hash_suffix</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="n">nbytes</span><span class="p">)</span>
    <span class="n">new_animal_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">hash_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;animal&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_animal_id</span>
    <span class="k">if</span> <span class="s2">&quot;animalday&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span> <span class="n">new_animal_id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span> <span class="o">=</span> <span class="n">new_animal_id</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__update_instance_vars</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.aggregate_time_windows" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_time_windows</span><span class="p">(</span><span class="n">groupby</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;animalday&#39;</span><span class="p">,</span> <span class="s1">&#39;isday&#39;</span><span class="p">])</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Aggregate time windows into a single data point per groupby by averaging features. This reduces the number of rows in the result.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>groupby</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to group by. Defaults to ['animalday', 'isday'], which groups by animalday (recording session) and isday (day/night).</p>
              </div>
            </td>
            <td>
                  <code>[&#39;animalday&#39;, &#39;isday&#39;]</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>groupby must be from ['animalday', 'isday']</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns in groupby not found in result</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns in groupby are not constant in groups</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_time_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupby</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">,</span> <span class="s2">&quot;isday&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate time windows into a single data point per groupby by averaging features. This reduces the number of rows in the result.</span>

<span class="sd">    Args:</span>
<span class="sd">        groupby (list[str] | str, optional): Columns to group by. Defaults to [&#39;animalday&#39;, &#39;isday&#39;], which groups by animalday (recording session) and isday (day/night).</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: groupby must be from [&#39;animalday&#39;, &#39;isday&#39;]</span>
<span class="sd">        ValueError: Columns in groupby not found in result</span>
<span class="sd">        ValueError: Columns in groupby are not constant in groups</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupby</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">,</span> <span class="s2">&quot;isday&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;groupby must be from [&#39;animalday&#39;, &#39;isday&#39;]. Got </span><span class="si">{</span><span class="n">groupby</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns </span><span class="si">{</span><span class="n">groupby</span><span class="si">}</span><span class="s2"> not found in result. Columns: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">FEATURES</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggregating </span><span class="si">{</span><span class="n">features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">result_grouped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span>

    <span class="n">agg_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s2">&quot;animalday&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;isday&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;isday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="kc">None</span>

    <span class="n">constant_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;genotype&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">constant_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">is_constant</span> <span class="o">=</span> <span class="n">result_grouped</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_constant</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">non_constant_groups</span> <span class="o">=</span> <span class="n">is_constant</span><span class="p">[</span><span class="o">~</span><span class="n">is_constant</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> is not constant in groups: </span><span class="si">{</span><span class="n">non_constant_groups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">agg_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s2">&quot;endfile&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;endfile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;endfile&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">,</span> <span class="n">feat</span><span class="o">=</span><span class="n">feat</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_average_feature</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">)</span>

    <span class="n">aggregated_df</span> <span class="o">=</span> <span class="n">result_grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="n">agg_dict</span><span class="p">[</span><span class="n">col</span><span class="p">](</span><span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">aggregated_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Keep animalday/isday as a column</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting suppress_short_interval_error to True&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__update_instance_vars</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.apply_filters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_filters</span><span class="p">(</span><span class="n">filter_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_valid_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">morphological_smoothing_seconds</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Apply multiple filters using configuration.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filter_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of filter names and parameters.
Available filters: 'logrms_range', 'high_rms', 'low_rms', 'high_beta',
'reject_channels', 'reject_channels_by_session', 'morphological_smoothing'</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_valid_channels</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum valid channels per window. Defaults to 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>morphological_smoothing_seconds</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Temporal smoothing window (deprecated, use config instead)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="WindowAnalysisResult (neurodent.visualization.results.WindowAnalysisResult)" href="#neurodent.visualization.results.WindowAnalysisResult">WindowAnalysisResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New filtered instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s1">&#39;logrms_range&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;z_range&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
<span class="gp">... </span>    <span class="s1">&#39;high_rms&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;max_rms&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span>
<span class="gp">... </span>    <span class="s1">&#39;reject_channels&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bad_channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;LMot&#39;</span><span class="p">,</span> <span class="s1">&#39;RMot&#39;</span><span class="p">]},</span>
<span class="gp">... </span>    <span class="s1">&#39;morphological_smoothing&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;smoothing_seconds&#39;</span><span class="p">:</span> <span class="mf">8.0</span><span class="p">}</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">filtered_war</span> <span class="o">=</span> <span class="n">war</span><span class="o">.</span><span class="n">apply_filters</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_filters</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">filter_config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_valid_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">morphological_smoothing_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply multiple filters using configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        filter_config (dict, optional): Dictionary of filter names and parameters.</span>
<span class="sd">            Available filters: &#39;logrms_range&#39;, &#39;high_rms&#39;, &#39;low_rms&#39;, &#39;high_beta&#39;,</span>
<span class="sd">            &#39;reject_channels&#39;, &#39;reject_channels_by_session&#39;, &#39;morphological_smoothing&#39;</span>
<span class="sd">        min_valid_channels (int): Minimum valid channels per window. Defaults to 3.</span>
<span class="sd">        morphological_smoothing_seconds (float, optional): Temporal smoothing window (deprecated, use config instead)</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: New filtered instance</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; config = {</span>
<span class="sd">        ...     &#39;logrms_range&#39;: {&#39;z_range&#39;: 3},</span>
<span class="sd">        ...     &#39;high_rms&#39;: {&#39;max_rms&#39;: 500},</span>
<span class="sd">        ...     &#39;reject_channels&#39;: {&#39;bad_channels&#39;: [&#39;LMot&#39;, &#39;RMot&#39;]},</span>
<span class="sd">        ...     &#39;morphological_smoothing&#39;: {&#39;smoothing_seconds&#39;: 8.0}</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; filtered_war = war.apply_filters(config)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filter_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;logrms_range&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;z_range&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
            <span class="s2">&quot;high_rms&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_rms&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span>
            <span class="s2">&quot;low_rms&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min_rms&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
            <span class="s2">&quot;high_beta&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;max_beta_prop&quot;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">},</span>
            <span class="s2">&quot;reject_channels_by_session&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

    <span class="n">filter_methods</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;logrms_range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_logrms_range</span><span class="p">,</span>
        <span class="s2">&quot;high_rms&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_rms</span><span class="p">,</span>
        <span class="s2">&quot;low_rms&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_low_rms</span><span class="p">,</span>
        <span class="s2">&quot;high_beta&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_beta</span><span class="p">,</span>
        <span class="s2">&quot;reject_channels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels</span><span class="p">,</span>
        <span class="s2">&quot;reject_channels_by_session&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels_by_recording_session</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">filt_bools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">morphological_params</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">filter_params</span> <span class="ow">in</span> <span class="n">filter_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">filter_name</span> <span class="o">==</span> <span class="s2">&quot;morphological_smoothing&quot;</span><span class="p">:</span>
            <span class="n">morphological_params</span> <span class="o">=</span> <span class="n">filter_params</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">filter_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filter_methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown filter: </span><span class="si">{</span><span class="n">filter_name</span><span class="si">}</span><span class="s2">. Available: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">filter_methods</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;morphological_smoothing&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">filter_func</span> <span class="o">=</span> <span class="n">filter_methods</span><span class="p">[</span><span class="n">filter_name</span><span class="p">]</span>
        <span class="n">filt_bool</span> <span class="o">=</span> <span class="n">filter_func</span><span class="p">(</span><span class="o">**</span><span class="n">filter_params</span><span class="p">)</span>
        <span class="n">filt_bools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filt_bool</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filter_name</span><span class="si">}</span><span class="s2">: filtered </span><span class="si">{</span><span class="n">filt_bool</span><span class="o">.</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">filt_bool</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filt_bool</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Combine all filter masks</span>
    <span class="k">if</span> <span class="n">filt_bools</span><span class="p">:</span>
        <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">filt_bools</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># Apply morphological smoothing if requested (either from config or parameter)</span>
    <span class="k">if</span> <span class="n">morphological_params</span> <span class="ow">or</span> <span class="n">morphological_smoothing_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">morphological_params</span><span class="p">:</span>
            <span class="n">smoothing_seconds</span> <span class="o">=</span> <span class="n">morphological_params</span><span class="p">[</span><span class="s2">&quot;smoothing_seconds&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smoothing_seconds</span> <span class="o">=</span> <span class="n">morphological_smoothing_seconds</span>

        <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_morphological_smoothing</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="p">,</span> <span class="n">smoothing_seconds</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied morphological smoothing: </span><span class="si">{</span><span class="n">smoothing_seconds</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

    <span class="c1"># Filter windows based on minimum valid channels</span>
    <span class="n">valid_channels_per_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">window_mask</span> <span class="o">=</span> <span class="n">valid_channels_per_window</span> <span class="o">&gt;=</span> <span class="n">min_valid_channels</span>
    <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="n">filt_bool_all</span> <span class="o">&amp;</span> <span class="n">window_mask</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.evaluate_lof_threshold_binary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_lof_threshold_binary</span><span class="p">(</span><span class="n">ground_truth_bad_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evaluation_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Evaluate single threshold against ground truth for binary classification.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ground_truth_bad_channels</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict mapping animal-day to bad channel sets.
                     If None, uses self.bad_channels_dict as ground truth.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>LOF threshold to test</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>evaluation_channels</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Subset of channels to include in evaluation. If none, uses all channels.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(y_true_list, y_pred_list) for sklearn.metrics.f1_score
   Each element represents one channel from one animal-day</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_lof_threshold_binary</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ground_truth_bad_channels</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">evaluation_channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate single threshold against ground truth for binary classification.</span>

<span class="sd">    Args:</span>
<span class="sd">        ground_truth_bad_channels: Dict mapping animal-day to bad channel sets.</span>
<span class="sd">                                 If None, uses self.bad_channels_dict as ground truth.</span>
<span class="sd">        threshold: LOF threshold to test</span>
<span class="sd">        evaluation_channels: Subset of channels to include in evaluation. If none, uses all channels.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (y_true_list, y_pred_list) for sklearn.metrics.f1_score</span>
<span class="sd">               Each element represents one channel from one animal-day</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lof_scores_dict&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LOF scores not available in this WAR. Run compute_bad_channels() first.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;threshold parameter is required&quot;</span><span class="p">)</span>

    <span class="c1"># Use self.bad_channels_dict as default ground truth</span>
    <span class="k">if</span> <span class="n">ground_truth_bad_channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;bad_channels_dict&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="p">:</span>
            <span class="n">ground_truth_bad_channels</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Filter bad_channels_dict to only include keys that exist in lof_scores_dict</span>
            <span class="n">lof_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">bad_channels_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="n">missing_keys</span> <span class="o">=</span> <span class="n">bad_channels_keys</span> <span class="o">-</span> <span class="n">lof_keys</span>
            <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;bad_channels_dict contains keys not found in lof_scores_dict: </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Available LOF keys: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">lof_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Only use bad channel keys that have corresponding LOF data</span>
            <span class="n">ground_truth_bad_channels</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lof_keys</span>
            <span class="p">}</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using filtered bad_channels_dict as ground truth with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ground_truth_bad_channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> animal-day sessions&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No ground truth provided and self.bad_channels_dict is empty.&quot;</span><span class="p">)</span>

    <span class="c1"># Get all channels if no subset specified</span>
    <span class="k">if</span> <span class="n">evaluation_channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">evaluation_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span>

    <span class="n">y_true_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_pred_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Debug: Log what we&#39;re working with</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;evaluate_lof_threshold_binary: evaluation_channels = </span><span class="si">{</span><span class="n">evaluation_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;evaluate_lof_threshold_binary: ground_truth_bad_channels keys = </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ground_truth_bad_channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;evaluate_lof_threshold_binary: lof_scores_dict keys = </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Iterate through each animal-day and evaluate channels</span>
    <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lof_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;lof_scores&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lof_data</span> <span class="ow">or</span> <span class="s2">&quot;channel_names&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lof_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid LOF data for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: missing required fields &#39;lof_scores&#39; or &#39;channel_names&#39;&quot;</span>
            <span class="p">)</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;lof_scores&quot;</span><span class="p">])</span>
        <span class="n">channel_names</span> <span class="o">=</span> <span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;channel_names&quot;</span><span class="p">]</span>

        <span class="c1"># Get ground truth bad channels for this animal-day</span>
        <span class="n">animalday_bad_channels</span> <span class="o">=</span> <span class="n">ground_truth_bad_channels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">animalday</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

        <span class="c1"># Debug: Log details for this animal-day</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: channel_names = </span><span class="si">{</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: animalday_bad_channels = </span><span class="si">{</span><span class="n">animalday_bad_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">: scores shape = </span><span class="si">{</span><span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Evaluate each channel in the evaluation subset</span>
        <span class="n">channels_processed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">channel</span> <span class="ow">in</span> <span class="n">evaluation_channels</span>
                <span class="ow">or</span> <span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">strict_matching</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">in</span> <span class="n">evaluation_channels</span>
            <span class="p">):</span>
                <span class="n">channels_processed</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Ground truth: 1 if channel is marked as bad, 0 otherwise</span>
                <span class="n">is_bad_channel</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">channel</span> <span class="ow">in</span> <span class="n">animalday_bad_channels</span>
                    <span class="ow">or</span> <span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">strict_matching</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">in</span> <span class="n">animalday_bad_channels</span>
                <span class="p">)</span>
                <span class="c1"># if is_bad_channel and channel not in animalday_bad_channels:</span>
                <span class="c1">#     logging.debug(f&quot;Mapped full channel &#39;{channel}&#39; -&gt; &#39;{parse_chname_to_abbrev(channel, strict_matching=False)}&#39; found in bad channels&quot;)</span>

                <span class="n">y_true</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">is_bad_channel</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="c1"># Prediction: 1 if LOF score &gt; threshold, 0 otherwise</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="mi">0</span>

                <span class="n">y_true_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
                <span class="n">y_pred_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">: y_true=</span><span class="si">{</span><span class="n">y_true</span><span class="si">}</span><span class="s2">, y_pred=</span><span class="si">{</span><span class="n">y_pred</span><span class="si">}</span><span class="s2"> (score=</span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, threshold=</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Extra debugging for the alignment issue</span>
                <span class="k">if</span> <span class="n">y_true</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;TRUE POSITIVE CANDIDATE: </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> mapped to bad channel in: </span><span class="si">{</span><span class="n">animalday_bad_channels</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">y_pred</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOF PREDICTION: </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> has score </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> &gt; threshold </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">channels_processed</span><span class="si">}</span><span class="s2"> channels for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y_true_list</span><span class="p">,</span> <span class="n">y_pred_list</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.filter_all" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_all</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_valid_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">morphological_smoothing_seconds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Apply a list of filters to the data. Filtering should be performed before aggregation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not None, this function will use this dataframe instead of self.result. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inplace</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, modify the result in place. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bad_channels</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channels to reject. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_valid_channels</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum number of valid channels required per window. Defaults to 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="callable">callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of filter functions to apply. Each function should return a boolean mask.
If None, uses default filters: [get_filter_logrms_range, get_filter_high_rms, get_filter_low_rms, get_filter_high_beta].
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>morphological_smoothing_seconds</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If provided, apply morphological opening/closing to smooth the filter mask.
This removes isolated false positives/negatives along the time axis for each channel independently.
The value specifies the time window in seconds for the morphological operations. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_bad_channels</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;overwrite&#39;, &#39;union&#39;, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to save bad channels to self.bad_channels_dict.
This parameter is passed to the filtering functions. Defaults to "union".
Note: When using "overwrite" mode, the bad_channels parameter and bad_channels_dict parameter
may conflict and overwrite each other's bad channel definitions if both are provided.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to filter functions.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filtered result</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_all</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># bad_channels: list[str] = None,</span>
    <span class="n">min_valid_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">morphological_smoothing_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># save_bad_channels: Literal[&quot;overwrite&quot;, &quot;union&quot;, None] = &quot;union&quot;,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply a list of filters to the data. Filtering should be performed before aggregation.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">        inplace (bool, optional): If True, modify the result in place. Defaults to True.</span>
<span class="sd">        bad_channels (list[str], optional): List of channels to reject. Defaults to None.</span>
<span class="sd">        min_valid_channels (int, optional): Minimum number of valid channels required per window. Defaults to 3.</span>
<span class="sd">        filters (list[callable], optional): List of filter functions to apply. Each function should return a boolean mask.</span>
<span class="sd">            If None, uses default filters: [get_filter_logrms_range, get_filter_high_rms, get_filter_low_rms, get_filter_high_beta].</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        morphological_smoothing_seconds (float, optional): If provided, apply morphological opening/closing to smooth the filter mask.</span>
<span class="sd">            This removes isolated false positives/negatives along the time axis for each channel independently.</span>
<span class="sd">            The value specifies the time window in seconds for the morphological operations. Defaults to None.</span>
<span class="sd">        save_bad_channels (Literal[&quot;overwrite&quot;, &quot;union&quot;, None], optional): How to save bad channels to self.bad_channels_dict.</span>
<span class="sd">            This parameter is passed to the filtering functions. Defaults to &quot;union&quot;.</span>
<span class="sd">            Note: When using &quot;overwrite&quot; mode, the bad_channels parameter and bad_channels_dict parameter</span>
<span class="sd">            may conflict and overwrite each other&#39;s bad channel definitions if both are provided.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to filter functions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: Filtered result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO refactor these into standalone functions, which take in a war as the first parameter, then pass</span>
        <span class="c1"># filt_bool = filt(self, df, **kwargs) as needed</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_logrms_range</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_rms</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_low_rms</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_beta</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels_by_recording_session</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="n">filt_bools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Apply each filter function</span>
    <span class="k">for</span> <span class="n">filter_function</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">filt_bool</span> <span class="o">=</span> <span class="n">filter_function</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">filt_bools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filt_bool</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filter_function</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="s2">filtered </span><span class="si">{</span><span class="n">filt_bool</span><span class="o">.</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">filt_bool</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filt_bool</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Apply all filters</span>
    <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">filt_bools</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filt_bool_all.shape: </span><span class="si">{</span><span class="n">filt_bool_all</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># (windows, channels)</span>

    <span class="c1"># Apply morphological smoothing if requested</span>
    <span class="k">if</span> <span class="n">morphological_smoothing_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot calculate window duration - &#39;duration&#39; column missing from result dataframe&quot;</span><span class="p">)</span>
        <span class="n">window_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

        <span class="c1"># Calculate number of windows for the smoothing</span>
        <span class="n">structure_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">morphological_smoothing_seconds</span> <span class="o">/</span> <span class="n">window_duration</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">structure_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Applying morphological smoothing with </span><span class="si">{</span><span class="n">structure_size</span><span class="si">}</span><span class="s2"> windows (</span><span class="si">{</span><span class="n">morphological_smoothing_seconds</span><span class="si">}</span><span class="s2">s / </span><span class="si">{</span><span class="n">window_duration</span><span class="si">}</span><span class="s2">s per window)&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Apply channel-wise temporal smoothing (each channel processed independently)</span>
            <span class="c1"># This avoids spatial assumptions while smoothing temporal artifacts</span>
            <span class="k">for</span> <span class="n">ch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">filt_bool_all</span><span class="p">[:,</span> <span class="n">ch_idx</span><span class="p">]</span>
                <span class="c1"># Opening removes small isolated artifacts</span>
                <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">binary_opening</span><span class="p">(</span><span class="n">channel_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">structure_size</span><span class="p">))</span>
                <span class="c1"># Closing fills small gaps in valid data</span>
                <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">binary_closing</span><span class="p">(</span><span class="n">channel_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">structure_size</span><span class="p">))</span>
                <span class="n">filt_bool_all</span><span class="p">[:,</span> <span class="n">ch_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping morphological smoothing - structure size would be 1 (no effect)&quot;</span><span class="p">)</span>

    <span class="c1"># Filter windows based on number of valid channels</span>
    <span class="n">valid_channels_per_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># axis 1 = channel</span>
    <span class="n">window_mask</span> <span class="o">=</span> <span class="n">valid_channels_per_window</span> <span class="o">&gt;=</span> <span class="n">min_valid_channels</span>  <span class="c1"># True if window has enough valid channels</span>
    <span class="n">filt_bool_all</span> <span class="o">=</span> <span class="n">filt_bool_all</span> <span class="o">&amp;</span> <span class="n">window_mask</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Apply window mask to all channels</span>

    <span class="n">filtered_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter</span><span class="p">(</span><span class="n">filt_bool_all</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">filtered_result</span>
    <span class="k">return</span> <span class="n">WindowAnalysisResult</span><span class="p">(</span>
        <span class="n">filtered_result</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.filter_high_beta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_high_beta</span><span class="p">(</span><span class="n">max_beta_prop</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter out windows with high beta power.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>max_beta_prop</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum beta power proportion. Defaults to 0.4.</p>
              </div>
            </td>
            <td>
                  <code>0.4</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="WindowAnalysisResult (neurodent.visualization.results.WindowAnalysisResult)" href="#neurodent.visualization.results.WindowAnalysisResult">WindowAnalysisResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New filtered instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_high_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_beta_prop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter out windows with high beta power.</span>

<span class="sd">    Args:</span>
<span class="sd">        max_beta_prop (float): Maximum beta power proportion. Defaults to 0.4.</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: New filtered instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_beta</span><span class="p">(</span><span class="n">max_beta_prop</span><span class="o">=</span><span class="n">max_beta_prop</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.filter_high_rms" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_high_rms</span><span class="p">(</span><span class="n">max_rms</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter out windows with RMS above threshold.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>max_rms</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum RMS threshold. Defaults to 500.</p>
              </div>
            </td>
            <td>
                  <code>500</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="WindowAnalysisResult (neurodent.visualization.results.WindowAnalysisResult)" href="#neurodent.visualization.results.WindowAnalysisResult">WindowAnalysisResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New filtered instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_high_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_rms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter out windows with RMS above threshold.</span>

<span class="sd">    Args:</span>
<span class="sd">        max_rms (float): Maximum RMS threshold. Defaults to 500.</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: New filtered instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_high_rms</span><span class="p">(</span><span class="n">max_rms</span><span class="o">=</span><span class="n">max_rms</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.filter_logrms_range" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_logrms_range</span><span class="p">(</span><span class="n">z_range</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter based on log(rms) z-score range.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>z_range</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Z-score range threshold. Defaults to 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="WindowAnalysisResult (neurodent.visualization.results.WindowAnalysisResult)" href="#neurodent.visualization.results.WindowAnalysisResult">WindowAnalysisResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New filtered instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_logrms_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_range</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter based on log(rms) z-score range.</span>

<span class="sd">    Args:</span>
<span class="sd">        z_range (float): Z-score range threshold. Defaults to 3.</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: New filtered instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_logrms_range</span><span class="p">(</span><span class="n">z_range</span><span class="o">=</span><span class="n">z_range</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.filter_low_rms" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_low_rms</span><span class="p">(</span><span class="n">min_rms</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter out windows with RMS below threshold.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>min_rms</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum RMS threshold. Defaults to 50.</p>
              </div>
            </td>
            <td>
                  <code>50</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="WindowAnalysisResult (neurodent.visualization.results.WindowAnalysisResult)" href="#neurodent.visualization.results.WindowAnalysisResult">WindowAnalysisResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New filtered instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_low_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_rms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter out windows with RMS below threshold.</span>

<span class="sd">    Args:</span>
<span class="sd">        min_rms (float): Minimum RMS threshold. Defaults to 50.</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: New filtered instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_low_rms</span><span class="p">(</span><span class="n">min_rms</span><span class="o">=</span><span class="n">min_rms</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.filter_morphological_smoothing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_morphological_smoothing</span><span class="p">(</span><span class="n">smoothing_seconds</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Apply morphological smoothing to all data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>smoothing_seconds</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time window in seconds for morphological operations</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="WindowAnalysisResult (neurodent.visualization.results.WindowAnalysisResult)" href="#neurodent.visualization.results.WindowAnalysisResult">WindowAnalysisResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New filtered instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_morphological_smoothing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smoothing_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply morphological smoothing to all data.</span>

<span class="sd">    Args:</span>
<span class="sd">        smoothing_seconds (float): Time window in seconds for morphological operations</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: New filtered instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Start with all-True mask and smooth it</span>
    <span class="n">base_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">smoothed_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_morphological_smoothing</span><span class="p">(</span><span class="n">base_mask</span><span class="p">,</span> <span class="n">smoothing_seconds</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">smoothed_mask</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.filter_reject_channels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_reject_channels</span><span class="p">(</span><span class="n">bad_channels</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter out specified bad channels.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>bad_channels</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channel names to reject</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_abbrevs</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use abbreviations. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="WindowAnalysisResult (neurodent.visualization.results.WindowAnalysisResult)" href="#neurodent.visualization.results.WindowAnalysisResult">WindowAnalysisResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New filtered instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_reject_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bad_channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">use_abbrevs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter out specified bad channels.</span>

<span class="sd">    Args:</span>
<span class="sd">        bad_channels (list[str]): List of channel names to reject</span>
<span class="sd">        use_abbrevs (bool, optional): Whether to use abbreviations. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: New filtered instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels</span><span class="p">(</span><span class="n">bad_channels</span><span class="o">=</span><span class="n">bad_channels</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="n">use_abbrevs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.filter_reject_channels_by_session" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_reject_channels_by_session</span><span class="p">(</span><span class="n">bad_channels_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter out bad channels by recording session.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>bad_channels_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping recording session
identifiers to lists of bad channel names to reject. Session identifiers are in the
format "{animal_id} {genotype} {day}" (e.g., "A10 WT Apr-01-2023"). Channel names
can be either full names (e.g., "Left Auditory") or abbreviations (e.g., "LAud").
If None, uses the bad_channels_dict from the constructor. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_abbrevs</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override automatic channel name format detection. If True,
channels are assumed to be abbreviations. If False, channels are assumed to be full
names. If None, automatically detects format and converts to abbreviations for matching.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="WindowAnalysisResult (neurodent.visualization.results.WindowAnalysisResult)" href="#neurodent.visualization.results.WindowAnalysisResult">WindowAnalysisResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New filtered instance with bad channels masked as NaN for their
respective recording sessions</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Filter specific channels per session using abbreviations:</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">bad_channels</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;A10 WT Apr-01-2023&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LAud&quot;</span><span class="p">,</span> <span class="s2">&quot;RMot&quot;</span><span class="p">],</span>  <span class="c1"># Session 1: reject left auditory, right motor</span>
<span class="gp">... </span>    <span class="s2">&quot;A10 WT Apr-02-2023&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LVis&quot;</span><span class="p">]</span>           <span class="c1"># Session 2: reject left visual only</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">filtered_war</span> <span class="o">=</span> <span class="n">war</span><span class="o">.</span><span class="n">filter_reject_channels_by_session</span><span class="p">(</span><span class="n">bad_channels</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
    <p>Filter using full channel names:</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">bad_channels</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;A12 KO May-15-2023&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Left Motor&quot;</span><span class="p">,</span> <span class="s2">&quot;Right Barrel&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s2">&quot;A12 KO May-16-2023&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Left Auditory&quot;</span><span class="p">,</span> <span class="s2">&quot;Left Visual&quot;</span><span class="p">,</span> <span class="s2">&quot;Right Motor&quot;</span><span class="p">]</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">filtered_war</span> <span class="o">=</span> <span class="n">war</span><span class="o">.</span><span class="n">filter_reject_channels_by_session</span><span class="p">(</span><span class="n">bad_channels</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
    <p>Auto-detect channel format (recommended):</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">bad_channels</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;A15 WT Jun-10-2023&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LMot&quot;</span><span class="p">,</span> <span class="s2">&quot;RBar&quot;</span><span class="p">],</span>  <span class="c1"># Will auto-detect as abbreviations</span>
<span class="gp">... </span>    <span class="s2">&quot;A15 WT Jun-11-2023&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LAud&quot;</span><span class="p">]</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">filtered_war</span> <span class="o">=</span> <span class="n">war</span><span class="o">.</span><span class="n">filter_reject_channels_by_session</span><span class="p">(</span><span class="n">bad_channels</span><span class="p">)</span>
</code></pre></div>


<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>Session identifiers must exactly match the "animalday" values in the result DataFrame</li>
<li>Available channel abbreviations: LAud, RAud, LVis, RVis, LHip, RHip, LBar, RBar, LMot, RMot</li>
<li>Channel names are case-insensitive and support various formats (e.g., "left aud", "Left Auditory")</li>
<li>If a session identifier is not found in bad_channels_dict, a warning is logged but processing continues</li>
<li>If a channel name is not recognized, a warning is logged but other channels are still processed</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_reject_channels_by_session</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">bad_channels_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WindowAnalysisResult&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter out bad channels by recording session.</span>

<span class="sd">    Args:</span>
<span class="sd">        bad_channels_dict (dict[str, list[str]], optional): Dictionary mapping recording session</span>
<span class="sd">            identifiers to lists of bad channel names to reject. Session identifiers are in the</span>
<span class="sd">            format &quot;{animal_id} {genotype} {day}&quot; (e.g., &quot;A10 WT Apr-01-2023&quot;). Channel names</span>
<span class="sd">            can be either full names (e.g., &quot;Left Auditory&quot;) or abbreviations (e.g., &quot;LAud&quot;).</span>
<span class="sd">            If None, uses the bad_channels_dict from the constructor. Defaults to None.</span>
<span class="sd">        use_abbrevs (bool, optional): Override automatic channel name format detection. If True,</span>
<span class="sd">            channels are assumed to be abbreviations. If False, channels are assumed to be full</span>
<span class="sd">            names. If None, automatically detects format and converts to abbreviations for matching.</span>
<span class="sd">            Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: New filtered instance with bad channels masked as NaN for their</span>
<span class="sd">            respective recording sessions</span>

<span class="sd">    Examples:</span>
<span class="sd">        Filter specific channels per session using abbreviations:</span>
<span class="sd">        &gt;&gt;&gt; bad_channels = {</span>
<span class="sd">        ...     &quot;A10 WT Apr-01-2023&quot;: [&quot;LAud&quot;, &quot;RMot&quot;],  # Session 1: reject left auditory, right motor</span>
<span class="sd">        ...     &quot;A10 WT Apr-02-2023&quot;: [&quot;LVis&quot;]           # Session 2: reject left visual only</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; filtered_war = war.filter_reject_channels_by_session(bad_channels, use_abbrevs=True)</span>

<span class="sd">        Filter using full channel names:</span>
<span class="sd">        &gt;&gt;&gt; bad_channels = {</span>
<span class="sd">        ...     &quot;A12 KO May-15-2023&quot;: [&quot;Left Motor&quot;, &quot;Right Barrel&quot;],</span>
<span class="sd">        ...     &quot;A12 KO May-16-2023&quot;: [&quot;Left Auditory&quot;, &quot;Left Visual&quot;, &quot;Right Motor&quot;]</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; filtered_war = war.filter_reject_channels_by_session(bad_channels, use_abbrevs=False)</span>

<span class="sd">        Auto-detect channel format (recommended):</span>
<span class="sd">        &gt;&gt;&gt; bad_channels = {</span>
<span class="sd">        ...     &quot;A15 WT Jun-10-2023&quot;: [&quot;LMot&quot;, &quot;RBar&quot;],  # Will auto-detect as abbreviations</span>
<span class="sd">        ...     &quot;A15 WT Jun-11-2023&quot;: [&quot;LAud&quot;]</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; filtered_war = war.filter_reject_channels_by_session(bad_channels)</span>

<span class="sd">    Note:</span>
<span class="sd">        - Session identifiers must exactly match the &quot;animalday&quot; values in the result DataFrame</span>
<span class="sd">        - Available channel abbreviations: LAud, RAud, LVis, RVis, LHip, RHip, LBar, RBar, LMot, RMot</span>
<span class="sd">        - Channel names are case-insensitive and support various formats (e.g., &quot;left aud&quot;, &quot;Left Auditory&quot;)</span>
<span class="sd">        - If a session identifier is not found in bad_channels_dict, a warning is logged but processing continues</span>
<span class="sd">        - If a channel name is not recognized, a warning is logged but other channels are still processed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_reject_channels_by_recording_session</span><span class="p">(</span>
        <span class="n">bad_channels_dict</span><span class="o">=</span><span class="n">bad_channels_dict</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="n">use_abbrevs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filtered_copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_bad_channels_by_lof_threshold" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_bad_channels_by_lof_threshold</span><span class="p">(</span><span class="n">lof_threshold</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Apply LOF threshold directly to stored scores to get bad channels.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lof_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for determining bad channels.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping animal days to lists of bad channel names.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_bad_channels_by_lof_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lof_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply LOF threshold directly to stored scores to get bad channels.</span>

<span class="sd">    Args:</span>
<span class="sd">        lof_threshold (float): Threshold for determining bad channels.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary mapping animal days to lists of bad channel names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lof_scores_dict&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LOF scores not available in this WAR. Compute LOF scores first.&quot;</span><span class="p">)</span>

    <span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lof_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;lof_scores&quot;</span> <span class="ow">in</span> <span class="n">lof_data</span> <span class="ow">and</span> <span class="s2">&quot;channel_names&quot;</span> <span class="ow">in</span> <span class="n">lof_data</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;lof_scores&quot;</span><span class="p">])</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;channel_names&quot;</span><span class="p">]</span>

            <span class="n">is_inlier</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&lt;</span> <span class="n">lof_threshold</span>
            <span class="n">bad_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">is_inlier</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">bad_channels_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="n">bad_channels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOF scores not available for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bad_channels_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_filter_high_beta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_filter_high_beta</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_beta_prop</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter windows based on beta power.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not None, this function will use this dataframe instead of self.result. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_beta_prop</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum beta power to filter by. Values above this will be set to NaN. Defaults to 0.4.</p>
              </div>
            </td>
            <td>
                  <code>0.4</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>out</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_filter_high_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_beta_prop</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter windows based on beta power.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">        max_beta_prop (float, optional): The maximum beta power to filter by. Values above this will be set to NaN. Defaults to 0.4.</span>

<span class="sd">    Returns:</span>
<span class="sd">        out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;psdfrac&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df_psdfrac</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;psdfrac&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">np_prop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_psdfrac</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">elif</span> <span class="s2">&quot;psdband&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;psdtotal&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df_psdband</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;psdband&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">np_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_psdband</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">np_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;psdtotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">np_prop</span> <span class="o">=</span> <span class="n">np_beta</span> <span class="o">/</span> <span class="n">np_total</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;psdfrac or psdband+psdtotal required for beta power filtering&quot;</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np_prop</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="n">np_prop</span> <span class="o">&gt;</span> <span class="n">max_beta_prop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_filter_high_rms" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_filter_high_rms</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_rms</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter windows based on rms.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not None, this function will use this dataframe instead of self.result. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_rms</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum rms value to filter by. Values above this will be set to NaN.</p>
              </div>
            </td>
            <td>
                  <code>500</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>out</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_filter_high_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_rms</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter windows based on rms.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">        max_rms (float, optional): The maximum rms value to filter by. Values above this will be set to NaN.</span>

<span class="sd">    Returns:</span>
<span class="sd">        out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">np_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">np_rmsnan</span> <span class="o">=</span> <span class="n">np_rms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Convert to float to allow NaN assignment for integer arrays</span>
    <span class="k">if</span> <span class="n">np_rmsnan</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">):</span>  <span class="c1"># integer types</span>
        <span class="n">np_rmsnan</span> <span class="o">=</span> <span class="n">np_rmsnan</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">np_rmsnan</span><span class="p">[</span><span class="n">np_rms</span> <span class="o">&gt;</span> <span class="n">max_rms</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np_rmsnan</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np_rms</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="n">np_rms</span> <span class="o">&gt;</span> <span class="n">max_rms</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_filter_logrms_range" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_filter_logrms_range</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_range</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter windows based on log(rms).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not None, this function will use this dataframe instead of self.result. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>z_range</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The z-score range to filter by. Values outside this range will be set to NaN.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>out</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_filter_logrms_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">z_range</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter windows based on log(rms).</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">        z_range (float, optional): The z-score range to filter by. Values outside this range will be set to NaN.</span>

<span class="sd">    Returns:</span>
<span class="sd">        out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">z_range</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z_range</span><span class="p">)</span>
    <span class="n">np_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">np_logrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np_rms</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">np_rms</span>
    <span class="n">np_logrmsz</span> <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">np_logrms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;omit&quot;</span><span class="p">)</span>
    <span class="n">np_logrms</span><span class="p">[(</span><span class="n">np_logrmsz</span> <span class="o">&gt;</span> <span class="n">z_range</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np_logrmsz</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">z_range</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np_logrms</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[(</span><span class="n">np_logrmsz</span> <span class="o">&gt;</span> <span class="n">z_range</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np_logrmsz</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">z_range</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_filter_low_rms" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_filter_low_rms</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_rms</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter windows based on rms.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not None, this function will use this dataframe instead of self.result. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_rms</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The minimum rms value to filter by. Values below this will be set to NaN.</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>out</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_filter_low_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_rms</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter windows based on rms.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">        min_rms (float, optional): The minimum rms value to filter by. Values below this will be set to NaN.</span>

<span class="sd">    Returns:</span>
<span class="sd">        out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">np_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">np_rmsnan</span> <span class="o">=</span> <span class="n">np_rms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">np_rmsnan</span><span class="p">[</span><span class="n">np_rms</span> <span class="o">&lt;</span> <span class="n">min_rms</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np_rmsnan</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np_rms</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="n">np_rms</span> <span class="o">&lt;</span> <span class="n">min_rms</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_filter_morphological_smoothing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_filter_morphological_smoothing</span><span class="p">(</span><span class="n">filter_mask</span><span class="p">,</span> <span class="n">smoothing_seconds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Apply morphological smoothing to a filter mask.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filter_mask</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input boolean mask of shape (n_windows, n_channels)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>smoothing_seconds</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time window in seconds for morphological operations</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray: Smoothed boolean mask</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_filter_morphological_smoothing</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">filter_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">smoothing_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply morphological smoothing to a filter mask.</span>

<span class="sd">    Args:</span>
<span class="sd">        filter_mask (np.ndarray): Input boolean mask of shape (n_windows, n_channels)</span>
<span class="sd">        smoothing_seconds (float): Time window in seconds for morphological operations</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Smoothed boolean mask</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot calculate window duration - &#39;duration&#39; column missing&quot;</span><span class="p">)</span>

    <span class="n">window_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">structure_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">smoothing_seconds</span> <span class="o">/</span> <span class="n">window_duration</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">structure_size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">filter_mask</span>

    <span class="n">smoothed_mask</span> <span class="o">=</span> <span class="n">filter_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">filter_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">filter_mask</span><span class="p">[:,</span> <span class="n">ch_idx</span><span class="p">]</span>
        <span class="c1"># Opening removes small isolated artifacts</span>
        <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">binary_opening</span><span class="p">(</span><span class="n">channel_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">structure_size</span><span class="p">))</span>
        <span class="c1"># Closing fills small gaps in valid data</span>
        <span class="n">channel_mask</span> <span class="o">=</span> <span class="n">binary_closing</span><span class="p">(</span><span class="n">channel_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">structure_size</span><span class="p">))</span>
        <span class="n">smoothed_mask</span><span class="p">[:,</span> <span class="n">ch_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_mask</span>

    <span class="k">return</span> <span class="n">smoothed_mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_filter_reject_channels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_filter_reject_channels</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_bad_channels</span><span class="o">=</span><span class="s1">&#39;union&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter channels to reject.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not None, this function will use this dataframe instead of self.result. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bad_channels</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of channels to reject. Can be either full channel names or abbreviations.
The method will automatically detect which format is being used. If None, no filtering is performed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_abbrevs</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override automatic detection. If True, channels are assumed to be channel abbreviations. If False, channels are assumed to be channel names.
If None, channels are parsed to abbreviations and matched against self.channel_abbrevs.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_bad_channels</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;overwrite&#39;, &#39;union&#39;, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to save bad channels to self.bad_channels_dict.
"overwrite": Replace self.bad_channels_dict completely with bad channels applied to all sessions.
"union": Merge bad channels with existing self.bad_channels_dict for all sessions.
None: Don't save to self.bad_channels_dict. Defaults to "union".
Note: When using "overwrite" mode, the bad_channels parameter and bad_channels_dict parameter
may conflict and overwrite each other's bad channel definitions if both are provided.</p>
              </div>
            </td>
            <td>
                  <code>&#39;union&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>out</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_filter_reject_channels</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bad_channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_abbrevs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_bad_channels</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;union&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;union&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter channels to reject.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">        bad_channels (list[str]): List of channels to reject. Can be either full channel names or abbreviations.</span>
<span class="sd">            The method will automatically detect which format is being used. If None, no filtering is performed.</span>
<span class="sd">        use_abbrevs (bool, optional): Override automatic detection. If True, channels are assumed to be channel abbreviations. If False, channels are assumed to be channel names.</span>
<span class="sd">            If None, channels are parsed to abbreviations and matched against self.channel_abbrevs.</span>
<span class="sd">        save_bad_channels (Literal[&quot;overwrite&quot;, &quot;union&quot;, None], optional): How to save bad channels to self.bad_channels_dict.</span>
<span class="sd">            &quot;overwrite&quot;: Replace self.bad_channels_dict completely with bad channels applied to all sessions.</span>
<span class="sd">            &quot;union&quot;: Merge bad channels with existing self.bad_channels_dict for all sessions.</span>
<span class="sd">            None: Don&#39;t save to self.bad_channels_dict. Defaults to &quot;union&quot;.</span>
<span class="sd">            Note: When using &quot;overwrite&quot; mode, the bad_channels parameter and bad_channels_dict parameter</span>
<span class="sd">            may conflict and overwrite each other&#39;s bad channel definitions if both are provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
    <span class="n">n_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bad_channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mask</span>

    <span class="n">channel_targets</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="k">if</span> <span class="n">use_abbrevs</span> <span class="ow">or</span> <span class="n">use_abbrevs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span>
    <span class="p">)</span>  <span class="c1"># Match to appropriate target</span>
    <span class="k">if</span> <span class="n">use_abbrevs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Match channels as abbreviations</span>
        <span class="n">bad_channels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">core</span><span class="o">.</span><span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bad_channels</span>
        <span class="p">]</span>

    <span class="c1"># Match channels to channel_targets</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bad_channels</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_targets</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[:,</span> <span class="n">channel_targets</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ch</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">channel_targets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Save bad channels to self.bad_channels_dict if requested</span>
    <span class="k">if</span> <span class="n">save_bad_channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Get all unique animal days from the result</span>
        <span class="n">animaldays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;animalday&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="c1"># Convert bad channels to the format used in bad_channels_dict (original channel names)</span>
        <span class="n">channels_to_save</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">bad_channels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">use_abbrevs</span> <span class="ow">is</span> <span class="kc">False</span>
            <span class="k">else</span> <span class="p">[</span>
                <span class="n">core</span><span class="o">.</span><span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bad_channels</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">save_bad_channels</span> <span class="o">==</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span>
            <span class="c1"># Replace entire dict with bad channels applied to all sessions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">animalday</span><span class="p">:</span> <span class="n">channels_to_save</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">animalday</span> <span class="ow">in</span> <span class="n">animaldays</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">save_bad_channels</span> <span class="o">==</span> <span class="s2">&quot;union&quot;</span><span class="p">:</span>
            <span class="c1"># Merge with existing bad channels for all sessions</span>
            <span class="n">updated_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">animalday</span> <span class="ow">in</span> <span class="n">animaldays</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">animalday</span> <span class="ow">in</span> <span class="n">updated_dict</span><span class="p">:</span>
                    <span class="c1"># Union of existing and new channels</span>
                    <span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">channels_to_save</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels_to_save</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="n">updated_dict</span>

    <span class="k">return</span> <span class="n">mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_filter_reject_channels_by_recording_session" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_filter_reject_channels_by_recording_session</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bad_channels_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_bad_channels</span><span class="o">=</span><span class="s1">&#39;union&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter channels to reject for each recording session</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not None, this function will use this dataframe instead of self.result. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bad_channels_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of list of channels to reject for each recording session.
Can be either full channel names or abbreviations. The method will automatically detect which format is being used.
If None, the method will use the bad_channels_dict passed to the constructor.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_abbrevs</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override automatic detection. If True, channels are assumed to be channel abbreviations. If False, channels are assumed to be channel names.
If None, channels are parsed to abbreviations and matched against self.channel_abbrevs.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_bad_channels</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;overwrite&#39;, &#39;union&#39;, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to save bad channels to self.bad_channels_dict.
"overwrite": Replace self.bad_channels_dict completely with bad_channels_dict.
"union": Merge bad_channels_dict with existing self.bad_channels_dict per session.
None: Don't save to self.bad_channels_dict. Defaults to "union".
Note: When using "overwrite" mode, the bad_channels parameter and bad_channels_dict parameter
may conflict and overwrite each other's bad channel definitions if both are provided.</p>
              </div>
            </td>
            <td>
                  <code>&#39;union&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>out</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_filter_reject_channels_by_recording_session</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bad_channels_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_abbrevs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_bad_channels</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;union&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;union&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter channels to reject for each recording session</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">        bad_channels_dict (dict[str, list[str]]): Dictionary of list of channels to reject for each recording session.</span>
<span class="sd">            Can be either full channel names or abbreviations. The method will automatically detect which format is being used.</span>
<span class="sd">            If None, the method will use the bad_channels_dict passed to the constructor.</span>
<span class="sd">        use_abbrevs (bool, optional): Override automatic detection. If True, channels are assumed to be channel abbreviations. If False, channels are assumed to be channel names.</span>
<span class="sd">            If None, channels are parsed to abbreviations and matched against self.channel_abbrevs.</span>
<span class="sd">        save_bad_channels (Literal[&quot;overwrite&quot;, &quot;union&quot;, None], optional): How to save bad channels to self.bad_channels_dict.</span>
<span class="sd">            &quot;overwrite&quot;: Replace self.bad_channels_dict completely with bad_channels_dict.</span>
<span class="sd">            &quot;union&quot;: Merge bad_channels_dict with existing self.bad_channels_dict per session.</span>
<span class="sd">            None: Don&#39;t save to self.bad_channels_dict. Defaults to &quot;union&quot;.</span>
<span class="sd">            Note: When using &quot;overwrite&quot; mode, the bad_channels parameter and bad_channels_dict parameter</span>
<span class="sd">            may conflict and overwrite each other&#39;s bad channel definitions if both are provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        out: np.ndarray of bool, (M fragments, N channels). True = keep window, False = remove window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bad_channels_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
    <span class="n">n_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># Group by animalday to apply filters per recording session</span>
    <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;animalday&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">bad_channels_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">animalday</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bad_channels_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No bad channels specified for recording session </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">. Check that all days are present in bad_channels_dict&quot;</span>
                <span class="p">)</span>
            <span class="n">bad_channels</span> <span class="o">=</span> <span class="n">bad_channels_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bad_channels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">channel_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="k">if</span> <span class="n">use_abbrevs</span> <span class="ow">or</span> <span class="n">use_abbrevs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span>
        <span class="k">if</span> <span class="n">use_abbrevs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bad_channels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">core</span><span class="o">.</span><span class="n">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bad_channels</span>
            <span class="p">]</span>

        <span class="c1"># Get indices for this recording session</span>
        <span class="n">session_indices</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Apply channel filtering for this session</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bad_channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_targets</span><span class="p">:</span>
                <span class="n">ch_idx</span> <span class="o">=</span> <span class="n">channel_targets</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">session_indices</span><span class="p">,</span> <span class="n">ch_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">channel_targets</span><span class="si">}</span><span class="s2"> for session </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Save bad channels to self.bad_channels_dict if requested</span>
    <span class="k">if</span> <span class="n">save_bad_channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bad_channels_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">save_bad_channels</span> <span class="o">==</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">save_bad_channels</span> <span class="o">==</span> <span class="s2">&quot;union&quot;</span><span class="p">:</span>
            <span class="c1"># Merge with existing bad channels per session</span>
            <span class="n">updated_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">channels</span> <span class="ow">in</span> <span class="n">bad_channels_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">animalday</span> <span class="ow">in</span> <span class="n">updated_dict</span><span class="p">:</span>
                    <span class="c1"># Union of existing and new channels</span>
                    <span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">channels</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">updated_dict</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span> <span class="o">=</span> <span class="n">updated_dict</span>

    <span class="k">return</span> <span class="n">mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_groupavg_result" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_groupavg_result</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;animalday&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Group result and average within groups. Preserves data structure and shape for each feature.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>features</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of features to get from result</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of features to exclude from result. Will override the features parameter. Defaults to [].</p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not None, this function will use this dataframe instead of self.result. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>groupby</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Feature or list of features to group by before averaging. Passed to the <code>by</code> parameter in pd.DataFrame.groupby(). Defaults to "animalday".</p>
              </div>
            </td>
            <td>
                  <code>&#39;animalday&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>grouped_result</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>result grouped by <code>groupby</code> and averaged for each group.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_groupavg_result</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;animalday&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Group result and average within groups. Preserves data structure and shape for each feature.</span>

<span class="sd">    Args:</span>
<span class="sd">        features (list[str]): List of features to get from result</span>
<span class="sd">        exclude (list[str], optional): List of features to exclude from result. Will override the features parameter. Defaults to [].</span>
<span class="sd">        df (pd.DataFrame, optional): If not None, this function will use this dataframe instead of self.result. Defaults to None.</span>
<span class="sd">        groupby (str, optional): Feature or list of features to group by before averaging. Passed to the `by` parameter in pd.DataFrame.groupby(). Defaults to &quot;animalday&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        grouped_result: result grouped by `groupby` and averaged for each group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result_grouped</span><span class="p">,</span> <span class="n">result_validcols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_groups</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">_sanitize_feature_request</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>

    <span class="n">avg_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">result_validcols</span><span class="p">:</span>
            <span class="n">avg_result_col</span> <span class="o">=</span> <span class="n">result_grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_average_feature</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">avg_result_col</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">avg_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_result_col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> not calculated, skipping&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">avg_results</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_info</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns a formatted string with basic information about the WindowAnalysisResult object</p>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a formatted string with basic information about the WindowAnalysisResult object&quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;feature names: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;animaldays: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;animalday&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;animal_id: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;animal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;animal&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;genotype: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;genotype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;genotype&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;channel_names: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_lof_scores" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_lof_scores</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get LOF scores from this WAR.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping animal days to LOF score dictionaries.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_lof_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get LOF scores from this WAR.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary mapping animal days to LOF score dictionaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lof_scores_dict&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LOF scores not available in this WAR. Compute LOF scores first.&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">animalday</span><span class="p">,</span> <span class="n">lof_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;lof_scores&quot;</span> <span class="ow">in</span> <span class="n">lof_data</span> <span class="ow">and</span> <span class="s2">&quot;channel_names&quot;</span> <span class="ow">in</span> <span class="n">lof_data</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;lof_scores&quot;</span><span class="p">]</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="n">lof_data</span><span class="p">[</span><span class="s2">&quot;channel_names&quot;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="n">animalday</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">scores</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOF scores not available for </span><span class="si">{</span><span class="n">animalday</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.get_result" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_result</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">allow_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get windowed analysis result dataframe, with helpful filters</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>features</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of features to get from result</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of features to exclude from result; will override the features parameter. Defaults to [].</p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_missing</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, will return all requested features as columns regardless if they exist in result. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>result</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame object with features in columns and windows in rows</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">allow_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get windowed analysis result dataframe, with helpful filters</span>

<span class="sd">    Args:</span>
<span class="sd">        features (list[str]): List of features to get from result</span>
<span class="sd">        exclude (list[str], optional): List of features to exclude from result; will override the features parameter. Defaults to [].</span>
<span class="sd">        allow_missing (bool, optional): If True, will return all requested features as columns regardless if they exist in result. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        result: pd.DataFrame object with features in columns and windows in rows</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">_sanitize_feature_request</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_missing</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nonfeature_columns</span> <span class="o">+</span> <span class="n">features</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nonfeature_columns</span> <span class="o">+</span> <span class="n">features</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.load_pickle_and_json" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_pickle_and_json</span><span class="p">(</span><span class="n">folder_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pickle_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Load WindowAnalysisResult from folder</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path of folder containing .pkl and .json files. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pickle_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the pickle file. Can be just the filename (e.g. "war.pkl")
or a path relative to folder_path (e.g. "subdir/war.pkl"). If None and folder_path is provided,
expects exactly one .pkl file in folder_path. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>json_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the JSON file. Can be just the filename (e.g. "war.json")
or a path relative to folder_path (e.g. "subdir/war.json"). If None and folder_path is provided,
expects exactly one .json file in folder_path. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>folder_path does not exist</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Expected exactly one pickle and one json file in folder_path (when pickle_name/json_name not specified)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specified pickle_name or json_name not found</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>result</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>WindowAnalysisResult object</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_pickle_and_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pickle_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load WindowAnalysisResult from folder</span>

<span class="sd">    Args:</span>
<span class="sd">        folder_path (str, optional): Path of folder containing .pkl and .json files. Defaults to None.</span>
<span class="sd">        pickle_name (str, optional): Name of the pickle file. Can be just the filename (e.g. &quot;war.pkl&quot;)</span>
<span class="sd">            or a path relative to folder_path (e.g. &quot;subdir/war.pkl&quot;). If None and folder_path is provided,</span>
<span class="sd">            expects exactly one .pkl file in folder_path. Defaults to None.</span>
<span class="sd">        json_name (str, optional): Name of the JSON file. Can be just the filename (e.g. &quot;war.json&quot;)</span>
<span class="sd">            or a path relative to folder_path (e.g. &quot;subdir/war.json&quot;). If None and folder_path is provided,</span>
<span class="sd">            expects exactly one .json file in folder_path. Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: folder_path does not exist</span>
<span class="sd">        ValueError: Expected exactly one pickle and one json file in folder_path (when pickle_name/json_name not specified)</span>
<span class="sd">        FileNotFoundError: Specified pickle_name or json_name not found</span>

<span class="sd">    Returns:</span>
<span class="sd">        result: WindowAnalysisResult object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">folder_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder path </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pickle_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Handle pickle_name as either absolute path or relative to folder_path</span>
            <span class="n">pickle_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">pickle_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pickle_path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                <span class="n">df_pickle_path</span> <span class="o">=</span> <span class="n">pickle_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_pickle_path</span> <span class="o">=</span> <span class="n">folder_path</span> <span class="o">/</span> <span class="n">pickle_name</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">df_pickle_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pickle file not found: </span><span class="si">{</span><span class="n">df_pickle_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pkl_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">folder_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.pkl&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkl_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected exactly one pickle file in </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pkl_files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">df_pickle_path</span> <span class="o">=</span> <span class="n">pkl_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">json_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Handle json_name as either absolute path or relative to folder_path</span>
            <span class="n">json_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">json_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">json_path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                <span class="n">json_path</span> <span class="o">=</span> <span class="n">json_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">json_path</span> <span class="o">=</span> <span class="n">folder_path</span> <span class="o">/</span> <span class="n">json_name</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON file not found: </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">folder_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected exactly one json file in </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">json_files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">json_path</span> <span class="o">=</span> <span class="n">json_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pickle_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">json_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Either folder_path must be provided, or both pickle_name and json_name must be provided as absolute paths&quot;</span>
            <span class="p">)</span>

        <span class="n">df_pickle_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">pickle_name</span><span class="p">)</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">json_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df_pickle_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pickle file not found: </span><span class="si">{</span><span class="n">df_pickle_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON file not found: </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">df_pickle_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.read_mnes_spikes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_mnes_spikes</span><span class="p">(</span><span class="n">raws</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Extract spike features from MNE RawArray objects with spike annotations.</p>
<p>This method extracts spike timing from MNE annotations (where spikes are marked
with channel-specific event labels) and bins them into WAR time windows.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raws</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="mne.io.RawArray">RawArray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of MNE RawArray objects with spike annotations. One per recording
  session (animalday). Each should have annotations with channel names
  as event labels (e.g., 'LMot', 'RMot', etc.).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inplace</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, modifies self.result and returns self.
    If False, returns a new WindowAnalysisResult.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>WAR object with added spike features (nspike, lognspike).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Expects MNE annotations with channel names as event descriptions</li>
<li>Spike times are extracted from event onsets and binned to WAR windows</li>
<li>Channels not found in annotations will have empty spike arrays</li>
<li>Delegates to _read_from_spikes_all() for the actual binning logic</li>
</ul>
</details>

<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="neurodent.visualization.results.WindowAnalysisResult.read_mnes_spikes--from-mne-spike-annotations">From MNE spike annotations</h4>
<p>enhanced_war = war.read_mnes_spikes([mne_raw1, mne_raw2], inplace=False)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_mnes_spikes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raws</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract spike features from MNE RawArray objects with spike annotations.</span>

<span class="sd">    This method extracts spike timing from MNE annotations (where spikes are marked</span>
<span class="sd">    with channel-specific event labels) and bins them into WAR time windows.</span>

<span class="sd">    Args:</span>
<span class="sd">        raws: List of MNE RawArray objects with spike annotations. One per recording</span>
<span class="sd">              session (animalday). Each should have annotations with channel names</span>
<span class="sd">              as event labels (e.g., &#39;LMot&#39;, &#39;RMot&#39;, etc.).</span>
<span class="sd">        inplace: If True, modifies self.result and returns self.</span>
<span class="sd">                If False, returns a new WindowAnalysisResult.</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: WAR object with added spike features (nspike, lognspike).</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Expects MNE annotations with channel names as event descriptions</span>
<span class="sd">        - Spike times are extracted from event onsets and binned to WAR windows</span>
<span class="sd">        - Channels not found in annotations will have empty spike arrays</span>
<span class="sd">        - Delegates to _read_from_spikes_all() for the actual binning logic</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # From MNE spike annotations</span>
<span class="sd">        &gt;&gt;&gt; enhanced_war = war.read_mnes_spikes([mne_raw1, mne_raw2], inplace=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spikes_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">raws</span><span class="p">:</span>
        <span class="c1"># each mne is a contiguous recording session</span>
        <span class="n">events</span><span class="p">,</span> <span class="n">event_id</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">events_from_annotations</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">event_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">item</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">event_id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">spikes_channel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">ch_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event_id</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> not found in event_id&quot;</span><span class="p">)</span>
                <span class="n">spikes_channel</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="k">continue</span>
            <span class="n">event_id_channel</span> <span class="o">=</span> <span class="n">event_id</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>
            <span class="n">spike_times</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">event_id_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">spike_times</span> <span class="o">=</span> <span class="n">spike_times</span> <span class="o">/</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">]</span>
            <span class="n">spikes_channel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
        <span class="n">spikes_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spikes_channel</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_spikes_all</span><span class="p">(</span><span class="n">spikes_all</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.read_sars_spikes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_sars_spikes</span><span class="p">(</span><span class="n">sars</span><span class="p">,</span> <span class="n">read_mode</span><span class="o">=</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Integrate spike analysis results into WAR by adding nspike/lognspike features.</p>
<p>This method extracts spike timing information from spike detection results and bins
them according to the WAR's time windows, adding spike count features to each row.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sars</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="SpikeAnalysisResult (neurodent.visualization.results.SpikeAnalysisResult)" href="#neurodent.visualization.results.SpikeAnalysisResult">SpikeAnalysisResult</a>, <span title="FrequencyDomainSpikeAnalysisResult">FrequencyDomainSpikeAnalysisResult</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of SpikeAnalysisResult or FrequencyDomainSpikeAnalysisResult objects.
  One result per recording session (animalday).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>read_mode</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;sa&#39;, &#39;mne&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mode for extracting spike data:
- "sa": Read from SortingAnalyzer objects (result_sas attribute)
- "mne": Read from MNE RawArray objects (result_mne attribute)</p>
              </div>
            </td>
            <td>
                  <code>&#39;sa&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inplace</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, modifies self.result and returns self.
    If False, returns a new WindowAnalysisResult.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>WindowAnalysisResult</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>WAR object with added spike features (nspike, lognspike).
- If inplace=True: returns self with modified result DataFrame
- If inplace=False: returns new WAR object with enhanced result DataFrame</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>The number of sars must match the number of unique animaldays in self.result</li>
<li>Spikes are binned into time windows matching the existing WAR fragments</li>
<li>nspike: array of spike counts per channel for each time window</li>
<li>lognspike: log-transformed spike counts using core.log_transform()</li>
</ul>
</details>

<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="neurodent.visualization.results.WindowAnalysisResult.read_sars_spikes--after-computing-war-and-spike-detection">After computing WAR and spike detection</h4>
<p>enhanced_war = war.read_sars_spikes(fdsar_list, read_mode="sa", inplace=False)
enhanced_war.result['nspike']  # Spike counts per channel per window</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_sars_spikes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">sars</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s2">&quot;SpikeAnalysisResult&quot;</span><span class="p">,</span> <span class="s2">&quot;FrequencyDomainSpikeAnalysisResult&quot;</span><span class="p">]],</span>
    <span class="n">read_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;sa&quot;</span><span class="p">,</span> <span class="s2">&quot;mne&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sa&quot;</span><span class="p">,</span>
    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate spike analysis results into WAR by adding nspike/lognspike features.</span>

<span class="sd">    This method extracts spike timing information from spike detection results and bins</span>
<span class="sd">    them according to the WAR&#39;s time windows, adding spike count features to each row.</span>

<span class="sd">    Args:</span>
<span class="sd">        sars: List of SpikeAnalysisResult or FrequencyDomainSpikeAnalysisResult objects.</span>
<span class="sd">              One result per recording session (animalday).</span>
<span class="sd">        read_mode: Mode for extracting spike data:</span>
<span class="sd">            - &quot;sa&quot;: Read from SortingAnalyzer objects (result_sas attribute)</span>
<span class="sd">            - &quot;mne&quot;: Read from MNE RawArray objects (result_mne attribute)</span>
<span class="sd">        inplace: If True, modifies self.result and returns self.</span>
<span class="sd">                If False, returns a new WindowAnalysisResult.</span>

<span class="sd">    Returns:</span>
<span class="sd">        WindowAnalysisResult: WAR object with added spike features (nspike, lognspike).</span>
<span class="sd">            - If inplace=True: returns self with modified result DataFrame</span>
<span class="sd">            - If inplace=False: returns new WAR object with enhanced result DataFrame</span>

<span class="sd">    Notes:</span>
<span class="sd">        - The number of sars must match the number of unique animaldays in self.result</span>
<span class="sd">        - Spikes are binned into time windows matching the existing WAR fragments</span>
<span class="sd">        - nspike: array of spike counts per channel for each time window</span>
<span class="sd">        - lognspike: log-transformed spike counts using core.log_transform()</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # After computing WAR and spike detection</span>
<span class="sd">        &gt;&gt;&gt; enhanced_war = war.read_sars_spikes(fdsar_list, read_mode=&quot;sa&quot;, inplace=False)</span>
<span class="sd">        &gt;&gt;&gt; enhanced_war.result[&#39;nspike&#39;]  # Spike counts per channel per window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">match</span> <span class="n">read_mode</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;sa&quot;</span><span class="p">:</span>
            <span class="n">spikes_all</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sar</span> <span class="ow">in</span> <span class="n">sars</span><span class="p">:</span>  <span class="c1"># for each continuous recording session</span>
                <span class="n">spikes_channel</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sar</span><span class="o">.</span><span class="n">result_sas</span><span class="p">):</span>  <span class="c1"># for each channel</span>
                    <span class="n">spike_times</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_ids</span><span class="p">():</span>  <span class="c1"># Flatten units</span>
                        <span class="n">spike_times</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_unit_spike_train</span><span class="p">(</span><span class="n">unit_id</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">spike_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span> <span class="o">/</span> <span class="n">sa</span><span class="o">.</span><span class="n">sorting</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">()</span>
                    <span class="n">spikes_channel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
                <span class="n">spikes_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spikes_channel</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_spikes_all</span><span class="p">(</span><span class="n">spikes_all</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="k">case</span> <span class="s2">&quot;mne&quot;</span><span class="p">:</span>
            <span class="n">raws</span> <span class="o">=</span> <span class="p">[</span><span class="n">sar</span><span class="o">.</span><span class="n">result_mne</span> <span class="k">for</span> <span class="n">sar</span> <span class="ow">in</span> <span class="n">sars</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mnes_spikes</span><span class="p">(</span><span class="n">raws</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid read_mode: </span><span class="si">{</span><span class="n">read_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.reorder_and_pad_channels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reorder_and_pad_channels</span><span class="p">(</span><span class="n">target_channels</span><span class="p">,</span> <span class="n">use_abbrevs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Reorder and pad channels to match a target channel list.</p>
<p>This method ensures that the data has a consistent channel order and structure
by reordering existing channels and padding missing channels with NaNs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>target_channels</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of target channel names to match</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_abbrevs</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, target channel names are read as channel abbreviations instead of channel names. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inplace</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, modify the result in place. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    pd.DataFrame: DataFrame with reordered and padded channels</p>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reorder_and_pad_channels</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">target_channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">use_abbrevs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reorder and pad channels to match a target channel list.</span>

<span class="sd">    This method ensures that the data has a consistent channel order and structure</span>
<span class="sd">    by reordering existing channels and padding missing channels with NaNs.</span>

<span class="sd">    Args:</span>
<span class="sd">        target_channels (list[str]): List of target channel names to match</span>
<span class="sd">        use_abbrevs (bool, optional): If True, target channel names are read as channel abbreviations instead of channel names. Defaults to True.</span>
<span class="sd">        inplace (bool, optional): If True, modify the result in place. Defaults to True.</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame with reordered and padded channels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">target_channels</span> <span class="k">if</span> <span class="n">target_channels</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">duplicates</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target channels must be unique. Found duplicates: </span><span class="si">{</span><span class="n">duplicates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">channel_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">ch</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_channels</span><span class="p">)}</span>
    <span class="n">channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">use_abbrevs</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span>

    <span class="n">valid_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_names</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_map</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_channels</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;None of the channel names </span><span class="si">{</span><span class="n">channel_names</span><span class="si">}</span><span class="s2"> were found in target channels </span><span class="si">{</span><span class="n">target_channels</span><span class="si">}</span><span class="s2">. Is use_abbrevs correctly set?&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_columns</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">feature</span><span class="p">:</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span> <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">LINEAR_FEATURES</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">BAND_FEATURES</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">BAND_FEATURES</span><span class="p">:</span>
                    <span class="n">df_bands</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bands</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">keys</span> <span class="o">=</span> <span class="n">df_bands</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                <span class="n">new_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_channels</span><span class="p">),</span> <span class="o">*</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># dubious</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_map</span><span class="p">:</span>
                        <span class="n">new_vals</span><span class="p">[:,</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">ch</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">BAND_FEATURES</span><span class="p">:</span>
                    <span class="n">new_vals</span> <span class="o">=</span> <span class="n">new_vals</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">))</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">]</span>

            <span class="k">case</span><span class="w"> </span><span class="k">_</span> <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">MATRIX_FEATURES</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cohere&quot;</span><span class="p">,</span> <span class="s2">&quot;zcohere&quot;</span><span class="p">,</span> <span class="s2">&quot;imcoh&quot;</span><span class="p">,</span> <span class="s2">&quot;zimcoh&quot;</span><span class="p">]:</span>
                    <span class="n">df_bands</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bands</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">keys</span> <span class="o">=</span> <span class="n">df_bands</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vals.shape: </span><span class="si">{</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">new_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">target_channels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_channels</span><span class="p">)]</span>
                <span class="n">new_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

                <span class="c1"># Map original channels to target channels</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ch1</span> <span class="ow">in</span> <span class="n">channel_map</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ch2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">ch2</span> <span class="ow">in</span> <span class="n">channel_map</span><span class="p">:</span>
                                <span class="n">new_vals</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">ch1</span><span class="p">],</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">ch2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cohere&quot;</span><span class="p">,</span> <span class="s2">&quot;zcohere&quot;</span><span class="p">,</span> <span class="s2">&quot;imcoh&quot;</span><span class="p">,</span> <span class="s2">&quot;zimcoh&quot;</span><span class="p">]:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">))</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">]</span>

            <span class="k">case</span><span class="w"> </span><span class="k">_</span> <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">HIST_FEATURES</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
                <span class="n">new_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="o">*</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_channels</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_map</span><span class="p">:</span>
                        <span class="n">new_vals</span><span class="p">[:,</span> <span class="o">...</span><span class="p">,</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">ch</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:,</span> <span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

                <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">))]</span>

            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid feature: </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Old channel names: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="n">target_channels</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New channel names: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Old channel abbreviations: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_instance_vars</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New channel abbreviations: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="neurodent.visualization.results.WindowAnalysisResult.save_pickle_and_json" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_pickle_and_json</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">make_folder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slugify_filename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_abbrevs_as_chnames</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Archive window analysis result into the folder specified, as a pickle and json file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Destination folder to save results to</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>make_folder</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, create the folder if it doesn't exist. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the file to save. Defaults to "war".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>slugify_filename</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, slugify the filename (replace special characters). Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_abbrevs_as_chnames</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, save the channel abbreviations as the channel names in the json file. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_pickle_and_json</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">make_folder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">slugify_filename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">save_abbrevs_as_chnames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Archive window analysis result into the folder specified, as a pickle and json file.</span>

<span class="sd">    Args:</span>
<span class="sd">        folder (str | Path): Destination folder to save results to</span>
<span class="sd">        make_folder (bool, optional): If True, create the folder if it doesn&#39;t exist. Defaults to True.</span>
<span class="sd">        filename (str, optional): Name of the file to save. Defaults to &quot;war&quot;.</span>
<span class="sd">        slugify_filename (bool, optional): If True, slugify the filename (replace special characters). Defaults to False.</span>
<span class="sd">        save_abbrevs_as_chnames (bool, optional): If True, save the channel abbreviations as the channel names in the json file. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">make_folder</span><span class="p">:</span>
        <span class="n">folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;war&quot;</span> <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">filename</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">if</span> <span class="n">slugify_filename</span> <span class="k">else</span> <span class="n">filename</span>

    <span class="n">filepath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved WAR to </span><span class="si">{</span><span class="n">filepath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.pkl&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;animal_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">animal_id</span><span class="p">,</span>
        <span class="s2">&quot;genotype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">genotype</span><span class="p">,</span>
        <span class="s2">&quot;channel_names&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_abbrevs</span> <span class="k">if</span> <span class="n">save_abbrevs_as_chnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
        <span class="s2">&quot;assume_from_number&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">save_abbrevs_as_chnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">assume_from_number</span><span class="p">,</span>
        <span class="s2">&quot;bad_channels_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels_dict</span><span class="p">,</span>
        <span class="s2">&quot;suppress_short_interval_error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_short_interval_error</span><span class="p">,</span>
        <span class="s2">&quot;lof_scores_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof_scores_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved WAR to </span><span class="si">{</span><span class="n">filepath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.json&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="neurodent.visualization.results.bin_spike_times" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">bin_spike_times</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">fragment_durations</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Bin spike times into counts based on fragment durations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>spike_times</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of spike timestamps in seconds</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fragment_durations</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of fragment durations in seconds</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[int]: List of spike counts per fragment</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/neurodent/visualization/results.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bin_spike_times</span><span class="p">(</span><span class="n">spike_times</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">fragment_durations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bin spike times into counts based on fragment durations.</span>

<span class="sd">    Args:</span>
<span class="sd">        spike_times (list[float]): List of spike timestamps in seconds</span>
<span class="sd">        fragment_durations (list[float]): List of fragment durations in seconds</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[int]: List of spike counts per fragment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert fragment durations to bin edges</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">fragment_durations</span><span class="p">)</span>

    <span class="c1"># Use numpy&#39;s histogram function to count spikes in each bin</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["toc.integrate", "navigation.sections"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>